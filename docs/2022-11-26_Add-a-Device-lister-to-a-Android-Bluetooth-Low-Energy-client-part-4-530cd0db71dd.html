<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Add a Device lister to a Android Bluetooth Low Energy client part 4</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Add a Device lister to a Android Bluetooth Low Energy client part 4</h1>
</header>
<section data-field="subtitle" class="p-summary">
The last three parts of my article series about a Bluetooth Low Energy (BLE) client connected to a server with a Heart Rate Service…
</section>
<section data-field="body" class="e-content">
<section name="ffa3" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="851c" id="851c" class="graf graf--h3 graf--leading graf--title"><em class="markup--em markup--h3-em">Add a Device lister to a Android Bluetooth Low Energy client part 4</em></h3><p name="ade7" id="ade7" class="graf graf--p graf-after--h3">The last three parts of my article series about a Bluetooth Low Energy (BLE) client connected to a server with a Heart Rate Service notification. <strong class="markup--strong markup--p-strong">In this article I show how to find and connect to nearby BLE devices</strong>.</p><p name="fb5b" id="fb5b" class="graf graf--p graf-after--p">This is the screen as it will look like when we are ready:</p><figure name="6c46" id="6c46" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*LB-asH7J0xJkjfvhBG6vLQ.png" data-width="500" data-height="1046" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*LB-asH7J0xJkjfvhBG6vLQ.png"></figure><p name="8a1d" id="8a1d" class="graf graf--p graf-after--figure">We are still using the library <strong class="markup--strong markup--p-strong">blessed-android </strong>(<a href="https://github.com/weliem/blessed-android" data-href="https://github.com/weliem/blessed-android" class="markup--anchor markup--p-anchor" rel="noopener ugc nofollow noopener" target="_blank">https://github.com/weliem/blessed-android</a>) from <strong class="markup--strong markup--p-strong">Martijn van Welie</strong> to handle the complete BLE workflow.</p><p name="9aee" id="9aee" class="graf graf--p graf-after--p">The first step to add the device lister is to add a Button to the main_activity.xml file as seeing above. The onClick listener will call a new activity with an intent:</p><pre name="2551" id="2551" class="graf graf--pre graf-after--p">listDevices.setOnClickListener(new View.OnClickListener() {<br>    @Override<br>    public void onClick(View view) {<br>        Intent intent = new Intent(MainActivity.this, DeviceLeListActivity.class);<br>        startActivity(intent);<br>    }<br>});</pre><p name="cc00" id="cc00" class="graf graf--p graf-after--pre">The next steps are made in a new activity called “DeviceLeListActivity” that will look like this when we are ready:</p><figure name="a6fc" id="a6fc" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*rKP9IGQlzttx9kqP4IP0_g.png" data-width="500" data-height="556" src="https://cdn-images-1.medium.com/max/800/1*rKP9IGQlzttx9kqP4IP0_g.png"></figure><p name="d36b" id="d36b" class="graf graf--p graf-after--figure">There are 3 main parts for the user interface:</p><ol class="postList"><li name="0f55" id="0f55" class="graf graf--li graf--startsWithDoubleQuote graf-after--p">“paired devices” — a ListView that shows devices that were paired previously to the smartphone</li><li name="93bf" id="93bf" class="graf graf--li graf-after--li">a button to start a scan for unpaired devices and a switch to limit the search on devices with a Heart Rate Service running only</li><li name="5479" id="5479" class="graf graf--li graf--startsWithDoubleQuote graf-after--li">“other LE devices” — a ListView that shows all found devices nearby</li></ol><p name="5d49" id="5d49" class="graf graf--p graf-after--li">This is the screen when a scan has completed:</p><figure name="853a" id="853a" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*qbZEu6aJP60uB8qpdDBkbA.png" data-width="500" data-height="805" src="https://cdn-images-1.medium.com/max/800/1*qbZEu6aJP60uB8qpdDBkbA.png"></figure><p name="cb91" id="cb91" class="graf graf--p graf-after--figure">When clicking on an entry on either the first or second ListView the MAC address of the device will be send back to the MainActivity with an Broadcast Intent.</p><p name="49a2" id="49a2" class="graf graf--p graf-after--p">Let’s focus on the code to search and list Bluetooth devices.</p><p name="917e" id="917e" class="graf graf--p graf-after--p">We do need a <strong class="markup--strong markup--p-strong">Bluetooth Adapter</strong> , a <strong class="markup--strong markup--p-strong">Bluetooth LE Scanner</strong> and a <strong class="markup--strong markup--p-strong">Handler</strong> for the communication between the UI and our methods. As the scan should run only for 5 seconds we define a contant with the value 5000 (milliseconds = 5 seconds):</p><pre name="75ab" id="75ab" class="graf graf--pre graf-after--p">private BluetoothAdapter mBtAdapter;<br>private BluetoothLeScanner mBtLeScanner;<br>private Handler handler = new Handler();<br>private static final long <em class="markup--em markup--pre-em">SCAN_PERIOD </em>= 5000; <em class="markup--em markup--pre-em">// 5000 = 5 seconds</em></pre><p name="685c" id="685c" class="graf graf--p graf-after--pre">The scan is started in the scanLeDevice method with the defined timeout and a <strong class="markup--strong markup--p-strong">callback</strong> (“leScanCallback”):</p><pre name="26b6" id="26b6" class="graf graf--pre graf-after--p">scanLeDevice:</pre><pre name="9ecc" id="9ecc" class="graf graf--pre graf-after--pre"><em class="markup--em markup--pre-em">...<br>// Stops scanning after a predefined scan period.<br></em>handler.postDelayed(new Runnable() {<br>    @SuppressLint(&quot;MissingPermission&quot;)<br>    @Override<br>    public void run() {<br>        scanning = false;<br>        mBtLeScanner.stopScan(leScanCallback);<br>        progressBar.setIndeterminate(true);<br>        progressBar.setVisibility(View.<em class="markup--em markup--pre-em">GONE</em>);<br>    }<br>}, <em class="markup--em markup--pre-em">SCAN_PERIOD</em>);<br>...<br>mBtLeScanner.startScan(leScanCallback);</pre><p name="f3ed" id="f3ed" class="graf graf--p graf-after--pre">If we want to limit the (scan) results we use a <strong class="markup--strong markup--p-strong">ScanFilter</strong> to see only the devices with a specification like the service that is advertised:</p><pre name="c13b" id="c13b" class="graf graf--pre graf-after--p">private static final UUID <em class="markup--em markup--pre-em">HEART_RATE_SERVICE_UUID </em>= UUID.<em class="markup--em markup--pre-em">fromString</em>(&quot;0000180D-0000-1000-8000-00805f9b34fb&quot;);</pre><pre name="ddae" id="ddae" class="graf graf--pre graf-after--pre">scanLeDevice:</pre><pre name="dd03" id="dd03" class="graf graf--pre graf-after--pre">...<br>if (scanFilterEnabled.isChecked()) {<br>    <em class="markup--em markup--pre-em">// using a scan filter - here for fixed Heart Rate Service UUID<br>    </em>List&lt;ScanFilter&gt; leScanFilter = new ArrayList&lt;ScanFilter&gt;();<br>    ScanFilter scanFilter = new ScanFilter.Builder()<br>            .setServiceUuid(new ParcelUuid(<em class="markup--em markup--pre-em">HEART_RATE_SERVICE_UUID</em>))<br>            .build();<br>    leScanFilter.add(scanFilter);<br>    ScanSettings leScanSettings = new ScanSettings.Builder()<br>            .setScanMode(ScanSettings.<em class="markup--em markup--pre-em">SCAN_MODE_LOW_LATENCY</em>).build();<br>    mBtLeScanner.startScan(leScanFilter, leScanSettings, leScanCallback);<br>}</pre><p name="992c" id="992c" class="graf graf--p graf-after--pre">As our companion BLE server is working like a Heart Rate measurement I’m adding the <strong class="markup--strong markup--p-strong">Heart Rate Service UUID</strong> to the scan filter and start the scan with this filter.</p><p name="5fb3" id="5fb3" class="graf graf--p graf-after--p">Now the scanner is running until the timeout stops the search and on each device that is found the callback is running:</p><pre name="0a91" id="0a91" class="graf graf--pre graf-after--p">private ScanCallback leScanCallback =<br>        new ScanCallback() {<br>            @Override<br>            public void onScanResult(int callbackType, ScanResult result) {<br>                super.onScanResult(callbackType, result);<br>                String deviceInfos =<br>                        &quot;name: &quot; + result.getDevice().getName()<br>                                + &quot;\ntype: &quot; + getBTDeviceType(result.getDevice())<br>                                + &quot;\naddress: &quot; + result.getDevice().getAddress();<br>                <em class="markup--em markup--pre-em">// this code is for avoiding duplicates in the listview<br>                </em>subject_list.add(deviceInfos);<br>                HashSet&lt;String&gt; hashSet = new HashSet&lt;String&gt;();<br>                hashSet.addAll(subject_list);<br>                subject_list.clear();<br>                subject_list.addAll(hashSet);<br>                mNewDevicesArrayAdapter.clear();<br>                mNewDevicesArrayAdapter.addAll(hashSet);<br>                mNewDevicesArrayAdapter.notifyDataSetChanged();<br>            }<br>        };</pre><p name="5d2e" id="5d2e" class="graf graf--p graf-after--pre">The callback is grabbing the MAC address, the name of the device (if available) and the device type and adds it to a HashSet that is later added to the “mNewDevicesArrayAdapter”. The HashSet is used to avoid duplicates in the list.</p><p name="46c9" id="46c9" class="graf graf--p graf-after--p">Just a note on the <strong class="markup--strong markup--p-strong">device type</strong>: I added a service method to show the cleartext names of the types. You can restrict the new devices list to those devices that are BLE only but I left the search to the full list.</p><p name="5c5b" id="5c5b" class="graf graf--p graf-after--p">I left out a lot of service code but there is one important information: as <strong class="markup--strong markup--p-strong">a scan is very ressource intensive</strong> (e.g. battery) it is important that a scan needs to get stopped before starting any other action, therefore a lot of “stopScanning” calls are made that end in</p><pre name="92cf" id="92cf" class="graf graf--pre graf-after--p">mBtAdapter.cancelDiscovery();</pre><p name="cb42" id="cb42" class="graf graf--p graf-after--pre">The data itself is send to the MainActivity after a click on one of the two ListViews and the activity finishes:</p><pre name="3588" id="3588" class="graf graf--pre graf-after--p">OnItemClickListener:</pre><pre name="cff5" id="cff5" class="graf graf--pre graf-after--pre"><em class="markup--em markup--pre-em">// Get the device MAC address, which is the last 17 chars in the View<br></em>String info = ((TextView) v).getText().toString();<br>String address = info.substring(info.length() - 17);<br><br><em class="markup--em markup--pre-em">// Create the Intent and include the MAC address<br></em>Intent intent = new Intent(DeviceLeListActivity.this, MainActivity.class);<br>intent.putExtra(<em class="markup--em markup--pre-em">EXTRA_DEVICE_ADDRESS</em>, address);<br>startActivity(intent);<br>finish();</pre><p name="5cb8" id="5cb8" class="graf graf--p graf-after--pre">The MAC address is flowing to the MainActivity and send to the BluetoothHandler-class:</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="java" name="0cba" id="0cba" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">        <span class="hljs-type">Intent</span> <span class="hljs-variable">incommingIntent</span> <span class="hljs-operator">=</span> getIntent();<br />        <span class="hljs-type">Bundle</span> <span class="hljs-variable">extras</span> <span class="hljs-operator">=</span> incommingIntent.getExtras();<br />        <span class="hljs-keyword">if</span> (extras != <span class="hljs-literal">null</span>) {<br />            initBluetoothHandler();<br />            macAddressFromScan = extras.getString(EXTRA_DEVICE_ADDRESS); <span class="hljs-comment">// retrieve the data using keyName</span><br />            System.out.println(<span class="hljs-string">&quot;Main received data: &quot;</span> + macAddressFromScan);<br />            <span class="hljs-keyword">try</span> {<br />                <span class="hljs-keyword">if</span> (!macAddressFromScan.equals(<span class="hljs-string">&quot;&quot;</span>)) {<br />                    Log.i(<span class="hljs-string">&quot;Main&quot;</span>, <span class="hljs-string">&quot;selected MAC: &quot;</span> + macAddressFromScan);<br />                    connectedDevice.setText(macAddressFromScan);<br />                    <span class="hljs-keyword">if</span> (bluetoothHandler != <span class="hljs-literal">null</span>) {<br />                        <span class="hljs-keyword">if</span> (macAddressFromScan.length() &gt; <span class="hljs-number">16</span>) {<br />                            Log.i(<span class="hljs-string">&quot;Main&quot;</span>, <span class="hljs-string">&quot;connect to macAddress: &quot;</span> + macAddressFromScan);<br />                            bluetoothHandler.connectToAddress(macAddressFromScan);<br />                        } <span class="hljs-keyword">else</span> {<br />                            Log.i(<span class="hljs-string">&quot;Main&quot;</span>, <span class="hljs-string">&quot;macAddressFromScan !&gt; 16&quot;</span>);<br />                        }<br />                    } <span class="hljs-keyword">else</span> {<br />                        Log.i(<span class="hljs-string">&quot;Main&quot;</span>, <span class="hljs-string">&quot;bluetoothHandler == null&quot;</span>);<br />                    }<br />                }<br />            } <span class="hljs-keyword">catch</span> (NullPointerException e) {<br />                <span class="hljs-comment">// do nothing, there are just no data</span><br />                Log.i(<span class="hljs-string">&quot;Main&quot;</span>, <span class="hljs-string">&quot;null pointer exception: &quot;</span> + e.toString());<br />            }<br />        }<br />    }</span></pre><p name="a79b" id="a79b" class="graf graf--p graf-after--pre">The data end in a method of BluetoothHandler where the central will connect to the server:</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="java" name="5cd3" id="5cd3" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">connectToAddress</span><span class="hljs-params">(String peripheralMacAddress)</span> {<br />        Timber.i(<span class="hljs-string">&quot;BH connectToAddress: %s&quot;</span>, peripheralMacAddress);<br />        central.stopScan();<br />        <span class="hljs-type">BluetoothPeripheral</span> <span class="hljs-variable">bluetoothPeripheral</span> <span class="hljs-operator">=</span> central.getPeripheral(peripheralMacAddress);<br />        central.connectPeripheral(bluetoothPeripheral, peripheralCallback);<br />    }</span></pre><p name="3879" id="3879" class="graf graf--p graf-after--pre">The complete <strong class="markup--strong markup--p-strong">source code</strong> for the BleClientBlessedPart4 is available on my GitHub repository: <a href="https://github.com/AndroidCrypto/BleClientBlessedPart4" data-href="https://github.com/AndroidCrypto/BleClientBlessedPart4" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">https://github.com/AndroidCrypto/BleClientBlessedPart4</a>.</p><p name="0093" id="0093" class="graf graf--p graf-after--p graf--trailing">The companion article “<a href="https://medium.com/@androidcrypto/expose-connected-devices-from-your-own-android-bluetooth-low-energy-server-part-4-e11be41e681c" data-href="https://medium.com/@androidcrypto/expose-connected-devices-from-your-own-android-bluetooth-low-energy-server-part-4-e11be41e681c" class="markup--anchor markup--p-anchor" target="_blank">Expose connected devices from your own Android Bluetooth Low Energy server part 4</a>” is published here on medium.com as well.</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@androidcrypto" class="p-author h-card">AndroidCrypto</a> on <a href="https://medium.com/p/530cd0db71dd"><time class="dt-published" datetime="2022-11-26T23:58:00.933Z">November 26, 2022</time></a>.</p><p><a href="https://medium.com/@androidcrypto/add-a-device-lister-to-a-android-bluetooth-low-energy-client-part-4-530cd0db71dd" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on November 27, 2022.</p></footer></article></body></html>