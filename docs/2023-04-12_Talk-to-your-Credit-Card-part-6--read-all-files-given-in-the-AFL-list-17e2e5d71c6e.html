<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Talk to your Credit Card part 6: read all files given in the AFL list</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Talk to your Credit Card part 6: read all files given in the AFL list</h1>
</header>
<section data-field="subtitle" class="p-summary">
Now we come to the most interesting part of our journey and read files from the card.
</section>
<section data-field="body" class="e-content">
<section name="5f15" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="dfec" id="dfec" class="graf graf--h3 graf--leading graf--title">Talk to your Credit Card part 6: read all files given in the AFL list</h3><p name="47a2" id="47a2" class="graf graf--p graf-after--h3">Now we come to the most interesting part of our journey and <strong class="markup--strong markup--p-strong">read files from the card</strong>.</p><figure name="ba1b" id="ba1b" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*eXnV90pI2F7Uby7NFboxJw.png" data-width="300" data-height="468" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*eXnV90pI2F7Uby7NFboxJw.png"></figure><p name="20c0" id="20c0" class="graf graf--p graf-after--figure">An EMV card contains a file system that is organized in <strong class="markup--strong markup--p-strong">tracks</strong> and <strong class="markup--strong markup--p-strong">records</strong>. Thinking of a traditional hard disk the tracks are like tree rings; track 1 is starting as the innermost ring, followed by track 2… up the outermost ring. The record is part or peace of the “ring” or “track” (think of a pizza cut in 8 segments). To address a single record we need two informations — the number of the track and the record. In an EMV file system <strong class="markup--strong markup--p-strong">the track is named “Short File Indicator” (“SFI”)</strong>. As the name <strong class="markup--strong markup--p-strong">Application File Locator</strong> suggests our <strong class="markup--strong markup--p-strong">AFL</strong> does contain this information but it is a little bit tricky to get the information.</p><p name="27a1" id="27a1" class="graf graf--p graf-after--p">Let’s start with the general structure of the AFL list, our data are from the MasterCard response in step 5:</p><pre data-code-block-mode="0" spellcheck="false" name="517d" id="517d" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">94 0C -- Application File Locator (AFL)<br>      08 01 01 00 10 01 01 01 20 01 02 00 (BINARY)</span></pre><p name="938c" id="938c" class="graf graf--p graf-after--pre">The <strong class="markup--strong markup--p-strong">AFL is a list of entries</strong> and each entry is of length 4 bytes, so I’m simply splitting the complete value in 4 bytes long chunks:</p><pre data-code-block-mode="0" spellcheck="false" name="669d" id="669d" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">94 0C -- Application File Locator (AFL)<br>      08 01 01 00 10 01 01 01 20 01 02 00<br>      08 01 01 00 = chunk 1 <br>      10 01 01 01 = chunk 2<br>      20 01 02 00 = chunk 3</span></pre><p name="ee3e" id="ee3e" class="graf graf--p graf-after--pre">Each chunk is 4 bytes long and for the next parsing step I’ using chunk 3:</p><pre data-code-block-mode="0" spellcheck="false" name="3d64" id="3d64" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">20 01 02 00 = chunk 3<br>20 = SFI = Short File Indicator<br>01 = first record to read<br>02 = last record to read<br>00 = number of records included in offline transactions</span></pre><p name="3a0a" id="3a0a" class="graf graf--p graf-after--pre">That means that we are asked to read 2 records (record 1 and record 2) from SFI 20. The last information “number of records included in offline transactions” can skipped out as we do not need this information for our journey.</p><p name="d8f4" id="d8f4" class="graf graf--p graf-after--p">Now we loop through the AFL list — it is a double loop with an “outer loop” taking each chunk and an “inner loop” reading the number of records.</p><p name="137e" id="137e" class="graf graf--p graf-after--p">In this article I’m not showing the contents of all files read but just the relevant ones.</p><p name="d072" id="d072" class="graf graf--p graf-after--p">According to our AFL list we need to read 4 files in total:</p><pre data-code-block-mode="0" spellcheck="false" name="fbf4" id="fbf4" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">08010100 = 1 file<br>10010101 = 1 file<br>20010200 = 2 files</span></pre><h3 name="1f18" id="1f18" class="graf graf--h3 graf-after--pre">I’m only showing the data for 2 files. <strong class="markup--strong markup--h3-strong">Serious security warning: This step may reveal confidential data like the credit card number ! The card number shown in my example is from a card cancelled long time ago and is no longer valid.</strong></h3><pre data-code-block-mode="0" spellcheck="false" name="47af" id="47af" class="graf graf--pre graf-after--h3 graf--preV2"><span class="pre--content">for SFI 8 we read 1 record<br>readRecord  command length: 5 data: 00b2010c00<br>readRecord response length: 121 data: 70759f6c0200019f6206000000000f009f63060000000000fe563442353337353035303030303136303131305e202f5e323430333232313237393433323930303030303030303030303030303030309f6401029f65020f009f660200fe9f6b135375050000160110d24032210000000000000f9f6701029000<br>------------------------------------<br>70 75 -- Record Template (EMV Proprietary)<br>      9F 6C 02 -- Mag Stripe Application Version Number (Card)<br>               00 01 (BINARY)<br>      9F 62 06 -- Track 1 bit map for CVC3<br>               00 00 00 00 0F 00 (BINARY)<br>      9F 63 06 -- Track 1 bit map for UN and ATC<br>               00 00 00 00 00 FE (BINARY)<br>      56 34 -- Track 1 Data<br>            42 35 33 37 35 30 35 30 30 30 30 31 36 30 31 31<br>            30 5E 20 2F 5E 32 34 30 33 32 32 31 32 37 39 34<br>            33 32 39 30 30 30 30 30 30 30 30 30 30 30 30 30<br>            30 30 30 30 (BINARY)<br>      9F 64 01 -- Track 1 number of ATC digits<br>               02 (BINARY)<br>      9F 65 02 -- Track 2 bit map for CVC3<br>               0F 00 (BINARY)<br>      9F 66 02 -- Terminal Transaction Qualifiers<br>               00 FE (BINARY)<br>      9F 6B 13 -- Track 2 Data<br>               53 75 05 00 00 16 01 10 D2 40 32 21 00 00 00 00<br>               00 00 0F (BINARY)<br>      9F 67 01 -- Track 2 number of ATC digits<br>               02 (BINARY)<br>90 00 -- Command successfully executed (OK)<br>------------------------------------</span></pre><p name="dee1" id="dee1" class="graf graf--p graf-after--pre">There are 2 tags of interest for our journey:</p><ul class="postList"><li name="fd74" id="fd74" class="graf graf--li graf-after--p">tag <em class="markup--em markup--li-em">0x56</em> Track 1 Data: It is as well an old relic from the magnetic stripe area and does contain the credit card number and expiration date in cleartext — do you see it ? A little hint: the data is in ASCII encoding, so the value “35 33 37 35 30 35 30 30 30 30 31 36 30 31 31 30” reads as “5375 0500…”</li><li name="fb79" id="fb79" class="graf graf--li graf-after--li">tag <em class="markup--em markup--li-em">0x9F6B</em> Track 2 Data: the data is equals to tag 0x57 shown in the previous step 5 and reveals the credit card number and expiration date as well</li></ul><pre data-code-block-mode="0" spellcheck="false" name="99f3" id="99f3" class="graf graf--pre graf-after--li graf--preV2"><span class="pre--content">for SFI 10 we read 1 record<br>readRecord  command length: 5 data: 00b2011400<br>readRecord response length: 171 data: 7081a69f420209785f25032203015f24032403315a0853750500001601105f3401009f0702ffc09f080200028c279f02069f03069f1a0295055f2a029a039c019f37049f35019f45029f4c089f34039f21039f7c148d0c910a8a0295059f37049f4c088e0e000000000000000042031e031f039f0d05b4508400009f0e0500000000009f0f05b4708480005f280202809f4a018257135375050000160110d24032212794329000000f9000<br>------------------------------------<br>70 81 A6 -- Record Template (EMV Proprietary)<br>         9F 42 02 -- Application Currency Code<br>                  09 78 (NUMERIC)<br>         5F 25 03 -- Application Effective Date<br>                  22 03 01 (NUMERIC)<br>         5F 24 03 -- Application Expiration Date<br>                  24 03 31 (NUMERIC)<br>         5A 08 -- Application Primary Account Number (PAN)<br>               53 75 05 00 00 16 01 10 (NUMERIC)<br>         5F 34 01 -- Application Primary Account Number (PAN) Sequence Number<br>                  00 (NUMERIC)<br>         9F 07 02 -- Application Usage Control<br>                  FF C0 (BINARY)<br>         9F 08 02 -- Application Version Number - card<br>                  00 02 (BINARY)<br>         8C 27 -- Card Risk Management Data Object List 1 (CDOL1)<br>               9F 02 06 -- Amount, Authorised (Numeric)<br>               9F 03 06 -- Amount, Other (Numeric)<br>               9F 1A 02 -- Terminal Country Code<br>               95 05 -- Terminal Verification Results (TVR)<br>               5F 2A 02 -- Transaction Currency Code<br>               9A 03 -- Transaction Date<br>               9C 01 -- Transaction Type<br>               9F 37 04 -- Unpredictable Number<br>               9F 35 01 -- Terminal Type<br>               9F 45 02 -- Data Authentication Code<br>               9F 4C 08 -- ICC Dynamic Number<br>               9F 34 03 -- Cardholder Verification (CVM) Results<br>               9F 21 03 -- Transaction Time (HHMMSS)<br>               9F 7C 14 -- Merchant Custom Data<br>         8D 0C -- Card Risk Management Data Object List 2 (CDOL2)<br>               91 0a -- Issuer Authentication Data<br>               8A 02 -- Authorisation Response Code<br>               95 05 -- Terminal Verification Results (TVR)<br>               9F 37 04 -- Unpredictable Number<br>               9F 4C 08 -- ICC Dynamic Number<br>         8E 0E -- Cardholder Verification Method (CVM) List<br>               00 00 00 00 00 00 00 00 42 03 1E 03 1F 03 (BINARY)<br>         9F 0D 05 -- Issuer Action Code - Default<br>                  B4 50 84 00 00 (BINARY)<br>         9F 0E 05 -- Issuer Action Code - Denial<br>                  00 00 00 00 00 (BINARY)<br>         9F 0F 05 -- Issuer Action Code - Online<br>                  B4 70 84 80 00 (BINARY)<br>         5F 28 02 -- Issuer Country Code<br>                  02 80 (NUMERIC)<br>         9F 4A 01 -- Static Data Authentication Tag List<br>                  82 (BINARY)<br>         57 13 -- Track 2 Equivalent Data<br>               53 75 05 00 00 16 01 10 D2 40 32 21 27 94 32 90<br>               00 00 0F (BINARY)<br>90 00 -- Command successfully executed (OK)<br>------------------------------------</span></pre><p name="1fd1" id="1fd1" class="graf graf--p graf-after--pre">There are two tags of interest:</p><ul class="postList"><li name="4e39" id="4e39" class="graf graf--li graf-after--p">tag <em class="markup--em markup--li-em">0x5A</em> Application Primary Account Number (PAN). Please note that the PAN = credit card number could be padded with trailing “F”s</li><li name="75c6" id="75c6" class="graf graf--li graf-after--li">tag <em class="markup--em markup--li-em">0x5F24</em> Application Expiration Date</li></ul><p name="83b0" id="83b0" class="graf graf--p graf-after--li">This is the source code added for step 6 in MainActivity.java class:</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="java" name="d8fc" id="d8fc" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onTagDiscovered</span><span class="hljs-params">(Tag tag)</span> {<br />...<br /><span class="hljs-comment">// parse content of gpoResponse to get Track 2 or AFL</span><br /><br /><span class="hljs-comment">/**<br /> * We do have 3 scenarios to work with:<br /> * a) the response contains a Track 2 Equivalent Data tag (tag 0x57)<br /> * b) the response is of type &#x27;Response Message Template Format 1&#x27; (tag 0x80)<br /> * c) the response is of type &#x27;Response Message Template Format 2&#x27; (tag 0x77)<br /> */</span><br /><span class="hljs-comment">//System.out.println(&quot;*** gpoResponse ***&quot;);</span><br /><span class="hljs-comment">//System.out.println(prettyPrintDataToString(gpoRequestResponse));</span><br /><span class="hljs-type">BerTlvs</span> <span class="hljs-variable">tlvsGpo</span> <span class="hljs-operator">=</span> parser.parse(gpoRequestResponse);<br /><span class="hljs-type">byte</span>[] aflBytes = <span class="hljs-literal">null</span>;<br /><br /><span class="hljs-comment">/**<br /> * workflow a)<br /> * The response contains a Track 2 Equivalent Data tag and from this we can directly<br /> * retrieve the Primary Application Number (PAN, here the Credit Card Number)<br /> * found using a VisaCard<br /> */</span><br /><br /><span class="hljs-type">BerTlv</span> <span class="hljs-variable">tag57</span> <span class="hljs-operator">=</span> tlvsGpo.find(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BerTag</span>(<span class="hljs-number">0x57</span>));<br /><span class="hljs-keyword">if</span> (tag57 != <span class="hljs-literal">null</span>) {<br />    <span class="hljs-comment">//writeToUiAppend(&quot;&quot;);</span><br />    writeToUiAppend(<span class="hljs-string">&quot;workflow a)&quot;</span>);<br />    writeToUiAppend(<span class="hljs-string">&quot;&quot;</span>);<br />    printStepHeader(<span class="hljs-number">6</span>, <span class="hljs-string">&quot;read files &amp; search PAN&quot;</span>);<br />    writeToUiAppend(<span class="hljs-string">&quot;06 read the files from card skipped&quot;</span>);<br />    writeToUiAppend(etData, <span class="hljs-string">&quot;06 read the files from card skipped&quot;</span>);<br /><br />    writeToUiAppend(<span class="hljs-string">&quot;the response contains a Track 2 Equivalent Data tag [tag 0x57]&quot;</span>);<br />    <span class="hljs-type">byte</span>[] gpoResponseTag57 = tag57.getBytesValue();<br />    writeToUiAppend(<span class="hljs-string">&quot;found tag 0x57 in the gpoResponse length: &quot;</span> + gpoResponseTag57.length + <span class="hljs-string">&quot; data: &quot;</span> + bytesToHexNpe(gpoResponseTag57));<br />    <span class="hljs-type">String</span> <span class="hljs-variable">pan</span> <span class="hljs-operator">=</span> getPanFromTrack2EquivalentData(gpoResponseTag57);<br />    <span class="hljs-type">String</span> <span class="hljs-variable">expDate</span> <span class="hljs-operator">=</span> getExpirationDateFromTrack2EquivalentData(gpoResponseTag57);<br />    writeToUiAppend(<span class="hljs-string">&quot;found a PAN &quot;</span> + pan + <span class="hljs-string">&quot; with Expiration date: &quot;</span> + expDate);<br />    writeToUiAppend(<span class="hljs-string">&quot;&quot;</span>);<br />    printStepHeader(<span class="hljs-number">7</span>, <span class="hljs-string">&quot;print PAN &amp; expire date&quot;</span>);<br />    writeToUiAppend(<span class="hljs-string">&quot;07 get PAN and Expiration date from tag 0x57 (Track 2 Equivalent Data)&quot;</span>);<br />    writeToUiAppend(etData, <span class="hljs-string">&quot;07 get PAN and Expiration date from tag 0x57 (Track 2 Equivalent Data) completed&quot;</span>);<br />    writeToUiAppend(<span class="hljs-string">&quot;data for AID &quot;</span> + bytesToHexNpe(aidSelected));<br />    writeToUiAppend(<span class="hljs-string">&quot;PAN: &quot;</span> + pan);<br />    <span class="hljs-type">String</span> <span class="hljs-variable">expirationDateString</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Expiration date (&quot;</span> + (expDate.length() == <span class="hljs-number">4</span> ? <span class="hljs-string">&quot;YYMM): &quot;</span> : <span class="hljs-string">&quot;YYMMDD): &quot;</span>) + expDate;<br />    writeToUiAppend(expirationDateString);<br />    writeToUiAppend(etData, <span class="hljs-string">&quot;data for AID &quot;</span> + bytesToHexNpe(aidSelected));<br />    writeToUiAppend(etData,<span class="hljs-string">&quot;PAN: &quot;</span> + pan);<br />    writeToUiAppend(etData, expirationDateString);<br />    writeToUiAppend(<span class="hljs-string">&quot;&quot;</span>);<br />}<br /><br /><span class="hljs-comment">/**<br /> * workflow b)<br /> * The response is of type &#x27;Response Message Template Format 1&#x27; and we need to know<br /> * the meaning of each byte, so we need to parse the content to get the data for the<br /> * &#x27;Application File Locator&#x27; (AFL).<br /> * found using a American Express Card<br /> */</span><br /><br /><span class="hljs-type">BerTlv</span> <span class="hljs-variable">tag80</span> <span class="hljs-operator">=</span> tlvsGpo.find(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BerTag</span>(<span class="hljs-number">0x80</span>));<br /><span class="hljs-keyword">if</span> (tag80 != <span class="hljs-literal">null</span>) {<br />    <span class="hljs-comment">//writeToUiAppend(&quot;&quot;);</span><br />    writeToUiAppend(<span class="hljs-string">&quot;workflow b)&quot;</span>);<br />    writeToUiAppend(<span class="hljs-string">&quot;the response is of type &#x27;Response Message Template Format 1&#x27; [tag 0x80]&quot;</span>);<br />    <span class="hljs-type">byte</span>[] gpoResponseTag80 = tag80.getBytesValue();<br />    writeToUiAppend(<span class="hljs-string">&quot;found tag 0x80 in the gpoResponse length: &quot;</span> + gpoResponseTag80.length + <span class="hljs-string">&quot; data: &quot;</span> + bytesToHexNpe(gpoResponseTag80));<br />    aflBytes = Arrays.copyOfRange(gpoResponseTag80, <span class="hljs-number">2</span>, gpoResponseTag80.length);<br />}<br /><br /><br /><span class="hljs-comment">/**<br /> * workflow c)<br /> * The response is of type &#x27;Response Message Template Format 2&#x27; and we need to find<br /> * tag 0x94; the content is the &#x27;Application File Locator&#x27; (AFL)<br /> * found using a MasterCard<br /> */</span><br /><br /><span class="hljs-type">BerTlv</span> <span class="hljs-variable">tag77</span> <span class="hljs-operator">=</span> tlvsGpo.find(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BerTag</span>(<span class="hljs-number">0x77</span>));<br /><span class="hljs-keyword">if</span> (tag77 != <span class="hljs-literal">null</span>) {<br />    <span class="hljs-comment">//writeToUiAppend(&quot;&quot;);</span><br />    writeToUiAppend(<span class="hljs-string">&quot;workflow c)&quot;</span>);<br />    writeToUiAppend(<span class="hljs-string">&quot;the response is of type &#x27;Response Message Template Format 2&#x27; [tag 0x77]&quot;</span>);<br />    writeToUiAppend(<span class="hljs-string">&quot;found tag 0x77 in the gpoResponse&quot;</span>);<br />}<br /><span class="hljs-type">BerTlv</span> <span class="hljs-variable">tag94</span> <span class="hljs-operator">=</span> tlvsGpo.find(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BerTag</span>(<span class="hljs-number">0x94</span>));<br /><span class="hljs-keyword">if</span> (tag94 != <span class="hljs-literal">null</span>) {<br />    writeToUiAppend(<span class="hljs-string">&quot;found &#x27;AFL&#x27; [tag 0x94] in the response of type &#x27;Response Message Template Format 2&#x27; [tag 0x77]&quot;</span>);<br />    <span class="hljs-type">byte</span>[] gpoResponseTag94 = tag94.getBytesValue();<br />    writeToUiAppend(<span class="hljs-string">&quot;found tag 0x94 in the gpoResponse length: &quot;</span> + gpoResponseTag94.length + <span class="hljs-string">&quot; data: &quot;</span> + bytesToHexNpe(gpoResponseTag94));<br />    aflBytes = gpoResponseTag94;<br />}<br /><br />writeToUiAppend(<span class="hljs-string">&quot;&quot;</span>);<br />printStepHeader(<span class="hljs-number">6</span>, <span class="hljs-string">&quot;read files &amp; search PAN&quot;</span>);<br />writeToUiAppend(<span class="hljs-string">&quot;06 read the files from card and search for PAN &amp; Expiration date&quot;</span>);<br />writeToUiAppend(etData, <span class="hljs-string">&quot;06 read the files from card and search for PAN &amp; Expiration date&quot;</span>);<br /><br />List&lt;<span class="hljs-type">byte</span>[]&gt; tag94BytesList = divideArray(aflBytes, <span class="hljs-number">4</span>);<br /><span class="hljs-type">int</span> <span class="hljs-variable">tag94BytesListLength</span> <span class="hljs-operator">=</span> tag94BytesList.size();<br /><span class="hljs-comment">//writeToUiAppend(etLog, &quot;tag94Bytes divided into &quot; + tag94BytesListLength + &quot; arrays&quot;);</span><br />writeToUiAppend(<span class="hljs-string">&quot;&quot;</span>);<br />writeToUiAppend(<span class="hljs-string">&quot;The AFL contains &quot;</span> + tag94BytesListLength + (tag94BytesListLength == <span class="hljs-number">1</span> ? <span class="hljs-string">&quot; entry to read&quot;</span> : <span class="hljs-string">&quot; entries to read&quot;</span>));<br /><br /><span class="hljs-comment">// the AFL is a 4 byte long byte array, so I your aflBytes array is 12 bytes long there are three sets to read.</span><br /><br /><span class="hljs-comment">/**<br /> * now we are going to read the specified files from the card. The system is as follows:<br /> * The first byte is the SFI, the second byte the first record to read,<br /> * the third byte is the last record to read and byte 4 gives the number<br /> * of sectors involved in offline authorization.<br /> * Here an example: 10 01 03 00<br /> * SFI:             10<br /> * first record:       01<br /> * last record:           03<br /> * offline:                  00<br /> * means that we are asked to read 3 records (number 1, 2 and 3) from SFI 10<br /> *<br /> * The fourth byte codes the number of records involved in offline data<br /> * authentication starting with the record number coded in the second byte. The<br /> * fourth byte may range from zero to the value of the third byte less the value of<br /> * the second byte plus 1.<br /> */</span><br /><br /><span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; tag94BytesListLength; i++) {<br />    <span class="hljs-type">byte</span>[] tag94BytesListEntry = tag94BytesList.get(i);<br />    <span class="hljs-type">byte</span> <span class="hljs-variable">sfiOrg</span> <span class="hljs-operator">=</span> tag94BytesListEntry[<span class="hljs-number">0</span>];<br />    <span class="hljs-type">byte</span> <span class="hljs-variable">rec1</span> <span class="hljs-operator">=</span> tag94BytesListEntry[<span class="hljs-number">1</span>];<br />    <span class="hljs-type">byte</span> <span class="hljs-variable">recL</span> <span class="hljs-operator">=</span> tag94BytesListEntry[<span class="hljs-number">2</span>];<br />    <span class="hljs-type">byte</span> <span class="hljs-variable">offl</span> <span class="hljs-operator">=</span> tag94BytesListEntry[<span class="hljs-number">3</span>]; <span class="hljs-comment">// offline authorization</span><br />    <span class="hljs-type">int</span> <span class="hljs-variable">sfiNew</span> <span class="hljs-operator">=</span> (<span class="hljs-type">byte</span>) sfiOrg | <span class="hljs-number">0x04</span>; <span class="hljs-comment">// add 4 = set bit 3</span><br />    <span class="hljs-type">int</span> <span class="hljs-variable">numberOfRecordsToRead</span> <span class="hljs-operator">=</span> (byteToInt(recL) - byteToInt(rec1) + <span class="hljs-number">1</span>);<br />    writeToUiAppend(<span class="hljs-string">&quot;for SFI &quot;</span> + byteToHex(sfiOrg) + <span class="hljs-string">&quot; we read &quot;</span> + numberOfRecordsToRead + (numberOfRecordsToRead == <span class="hljs-number">1</span> ? <span class="hljs-string">&quot; record&quot;</span> : <span class="hljs-string">&quot; records&quot;</span>));<br />    <span class="hljs-comment">// read records</span><br />    <span class="hljs-type">byte</span>[] readRecordResponse = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">0</span>];<br />    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">iRecord</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) rec1; iRecord &lt;= (<span class="hljs-type">int</span>) recL; iRecord++) {<br />        <span class="hljs-type">byte</span>[] cmd = hexToBytes(<span class="hljs-string">&quot;00B2000400&quot;</span>);<br />        cmd[<span class="hljs-number">2</span>] = (<span class="hljs-type">byte</span>) (iRecord &amp; <span class="hljs-number">0x0FF</span>);<br />        cmd[<span class="hljs-number">3</span>] |= (<span class="hljs-type">byte</span>) (sfiNew &amp; <span class="hljs-number">0x0FF</span>);<br />        writeToUiAppend(<span class="hljs-string">&quot;readRecord  command length: &quot;</span> + cmd.length + <span class="hljs-string">&quot; data: &quot;</span> + bytesToHexNpe(cmd));<br />        readRecordResponse = nfc.transceive(cmd);<br />        <span class="hljs-type">byte</span>[] readRecordResponseTag5a = <span class="hljs-literal">null</span>;<br />        <span class="hljs-type">byte</span>[] readRecordResponseTag5f24 = <span class="hljs-literal">null</span>;<br />        <span class="hljs-keyword">if</span> (readRecordResponse != <span class="hljs-literal">null</span>) {<br />            writeToUiAppend(<span class="hljs-string">&quot;readRecord response length: &quot;</span> + readRecordResponse.length + <span class="hljs-string">&quot; data: &quot;</span> + bytesToHexNpe(readRecordResponse));<br />            writeToUiAppend(prettyPrintDataToString(readRecordResponse));<br />            System.out.println(<span class="hljs-string">&quot;readRecord response length: &quot;</span> + readRecordResponse.length + <span class="hljs-string">&quot; data: &quot;</span> + bytesToHexNpe(readRecordResponse));<br />            System.out.println(prettyPrintDataToString(readRecordResponse));<br /><br />            <span class="hljs-comment">// checking for PAN and Expiration Date</span><br />            <span class="hljs-keyword">try</span> {<br />                <span class="hljs-type">BerTlvs</span> <span class="hljs-variable">tlvsReadRecord</span> <span class="hljs-operator">=</span> parser.parse(readRecordResponse);<br />                <span class="hljs-type">BerTlv</span> <span class="hljs-variable">tag5a</span> <span class="hljs-operator">=</span> tlvsReadRecord.find(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BerTag</span>(<span class="hljs-number">0x5a</span>));<br />                <span class="hljs-keyword">if</span> (tag5a != <span class="hljs-literal">null</span>) {<br />                    readRecordResponseTag5a = tag5a.getBytesValue();<br />                    writeToUiAppend(<span class="hljs-string">&quot;found tag 0x5a in the readRecordResponse length: &quot;</span> + readRecordResponseTag5a.length + <span class="hljs-string">&quot; data: &quot;</span> + bytesToHexNpe(readRecordResponseTag5a));<br />                }<br />                <span class="hljs-type">BerTlv</span> <span class="hljs-variable">tag5f24</span> <span class="hljs-operator">=</span> tlvsReadRecord.find(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BerTag</span>(<span class="hljs-number">0x5f</span>, <span class="hljs-number">0x24</span>));<br />                <span class="hljs-keyword">if</span> (tag5f24 != <span class="hljs-literal">null</span>) {<br />                    readRecordResponseTag5f24 = tag5f24.getBytesValue();<br />                    writeToUiAppend(<span class="hljs-string">&quot;found tag 0x5f24 in the readRecordResponse length: &quot;</span> + readRecordResponseTag5f24.length + <span class="hljs-string">&quot; data: &quot;</span> + bytesToHexNpe(readRecordResponseTag5f24));<br />                }<br />                <span class="hljs-keyword">if</span> (readRecordResponseTag5a != <span class="hljs-literal">null</span>) {<br />                    <span class="hljs-type">String</span> <span class="hljs-variable">readRecordPanString</span> <span class="hljs-operator">=</span> removeTrailingF(bytesToHexNpe(readRecordResponseTag5a));<br />                    <span class="hljs-type">String</span> <span class="hljs-variable">readRecordExpirationDateString</span> <span class="hljs-operator">=</span> bytesToHexNpe(readRecordResponseTag5f24);<br />                    writeToUiAppend(<span class="hljs-string">&quot;&quot;</span>);<br />                    printStepHeader(<span class="hljs-number">7</span>, <span class="hljs-string">&quot;print PAN &amp; expire date&quot;</span>);<br />                    writeToUiAppend(<span class="hljs-string">&quot;07 get PAN and Expiration date from tags 0x5a and 0x5f24&quot;</span>);<br />                    writeToUiAppend(etData, <span class="hljs-string">&quot;07 get PAN and Expiration date from tags 0x5a and 0x5f24 completed&quot;</span>);<br />                    writeToUiAppend(<span class="hljs-string">&quot;data for AID &quot;</span> + bytesToHexNpe(aidSelected));<br />                    writeToUiAppend(<span class="hljs-string">&quot;PAN: &quot;</span> + readRecordPanString);<br />                    <span class="hljs-type">String</span> <span class="hljs-variable">expirationDateString</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Expiration date (&quot;</span> + (readRecordExpirationDateString.length() == <span class="hljs-number">4</span> ? <span class="hljs-string">&quot;YYMM): &quot;</span> : <span class="hljs-string">&quot;YYMMDD): &quot;</span>) + readRecordExpirationDateString;<br />                    writeToUiAppend(expirationDateString);<br />                    writeToUiAppend(etData, <span class="hljs-string">&quot;data for AID &quot;</span> + bytesToHexNpe(aidSelected));<br />                    writeToUiAppend(etData,<span class="hljs-string">&quot;PAN: &quot;</span> + readRecordPanString);<br />                    writeToUiAppend(etData, expirationDateString);<br />                    writeToUiAppend(<span class="hljs-string">&quot;&quot;</span>);<br />                }<br />            } <span class="hljs-keyword">catch</span> (RuntimeException e) {<br />                System.out.println(<span class="hljs-string">&quot;Runtime Exception: &quot;</span> + e.getMessage());<br />                <span class="hljs-comment">//startEndSequence(nfc);</span><br />            }<br />        } <span class="hljs-keyword">else</span> {<br />            writeToUiAppend(<span class="hljs-string">&quot;readRecord response was NULL&quot;</span>);<br />        }<br />    }<br />}</span></pre><figure name="61ca" id="61ca" class="graf graf--figure graf-after--pre"><img class="graf-image" data-image-id="1*R4AWztEgzM6dgeEPBQF1IQ.png" data-width="300" data-height="417" src="https://cdn-images-1.medium.com/max/800/1*R4AWztEgzM6dgeEPBQF1IQ.png"></figure><p name="b4bd" id="b4bd" class="graf graf--p graf-after--figure">We are come to the end of our journey and go to <a href="https://medium.com/@androidcrypto/talk-to-your-credit-card-part-7-find-and-print-out-the-application-primary-account-number-52b24b396082" data-href="https://medium.com/@androidcrypto/talk-to-your-credit-card-part-7-find-and-print-out-the-application-primary-account-number-52b24b396082" class="markup--anchor markup--p-anchor" target="_blank"><strong class="markup--strong markup--p-strong">step 07 find and print out the “Application Primary Account Number” (“PAN”) = card number and “Application Expiration Date” = expiration date of the card</strong></a></p><p name="3597" id="3597" class="graf graf--p graf-after--p graf--trailing">Find the full code of the app in my GitHub repository <strong class="markup--strong markup--p-strong">TalkToYourCreditCardPart6</strong>:<a href="https://github.com/AndroidCrypto/TalkToYourCreditCardPart6" data-href="https://github.com/AndroidCrypto/TalkToYourCreditCardPart6" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"> TalkToYourCreditCardPart6</a></p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@androidcrypto" class="p-author h-card">AndroidCrypto</a> on <a href="https://medium.com/p/17e2e5d71c6e"><time class="dt-published" datetime="2023-04-12T09:41:15.583Z">April 12, 2023</time></a>.</p><p><a href="https://medium.com/@androidcrypto/talk-to-your-credit-card-part-6-read-all-files-given-in-the-afl-list-17e2e5d71c6e" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on April 12, 2023.</p></footer></article></body></html>