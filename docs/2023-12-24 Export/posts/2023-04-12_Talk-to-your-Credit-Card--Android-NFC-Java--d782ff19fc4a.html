<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Talk to your Credit Card (Android NFC Java)</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Talk to your Credit Card (Android NFC Java)</h1>
</header>
<section data-field="subtitle" class="p-summary">
This is an article series about reading a Credit Card (or in general a Payment Card) with your Android device. Im using Java as framework…
</section>
<section data-field="body" class="e-content">
<section name="60d0" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="3f00" id="3f00" class="graf graf--h3 graf--leading graf--title">Talk to your Credit Card (Android NFC Java)</h3><p name="41cd" id="41cd" class="graf graf--p graf-after--h3">This is an article series about <strong class="markup--strong markup--p-strong">reading a Credit Card</strong> (or in general a Payment Card) with your Android device. Im using <strong class="markup--strong markup--p-strong">Java as framework</strong> in Android Studio.</p><figure name="19f5" id="19f5" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*x9ajinP9_-43ezvg4TCW6A.png" data-width="240" data-height="151" alt="image of a sample credit card" src="https://cdn-images-1.medium.com/max/800/1*x9ajinP9_-43ezvg4TCW6A.png"><figcaption class="imageCaption">Airodyssey at English Wikipedia, CC BY-SA 3.0 <a href="http://creativecommons.org/licenses/by-sa/3.0/," data-href="http://creativecommons.org/licenses/by-sa/3.0/," class="markup--anchor markup--figure-anchor" rel="noopener" target="_blank">http://creativecommons.org/licenses/by-sa/3.0/,</a> via Wikimedia Commons</figcaption></figure><p name="a8c4" id="a8c4" class="graf graf--p graf-after--figure">As there are only 5 to 7 steps to get informations like the <strong class="markup--strong markup--p-strong">Credit Card number</strong> (called “Primary Account Number” or “PAN”) or card’s <strong class="markup--strong markup--p-strong">Expiration Date</strong> I split up the complete story into single articles covering each step. Each step is accompanied by a link to the step specific <strong class="markup--strong markup--p-strong">GitHub repository</strong> so you can easily follow the steps with the complete source code. The repository of the (final) seventh step has the compiled app available as APK file.</p><p name="d948" id="d948" class="graf graf--p graf-after--p">In general, a Credit Card readable by a contactless reader (NFC) follows the <strong class="markup--strong markup--p-strong">EMV specifications</strong> written in a lot of books, all available from the specification holder’s website <a href="https://www.emvco.com/specifications/" data-href="https://www.emvco.com/specifications/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">https://www.emvco.com/specifications/</a>. As the specifications provide a lot of information it can be a pain to go through them all to understand what you need to do.</p><p name="61c2" id="61c2" class="graf graf--p graf-after--p">When using “Credit Card” I mean all types of payment cards that are accessible using the NFC technology, e.g. a German “GiroCard”. As there maybe are sub-specifications for each type of card I can test my workflow only on card I own - the complete workflow is tested with these cards:</p><ul class="postList"><li name="6b45" id="6b45" class="graf graf--li graf-after--p">American Express type “Credit”</li><li name="cf7f" id="cf7f" class="graf graf--li graf-after--li">MasterCard types “Credit” and “Debit”</li><li name="98b9" id="98b9" class="graf graf--li graf-after--li">VisaCard types “Credit” and “Debit”</li><li name="3011" id="3011" class="graf graf--li graf-after--li">German GiroCards type “Debit”</li></ul><p name="182d" id="182d" class="graf graf--p graf-after--li">These are the steps to read a payment card, it is a kind of “question &amp; answer” workflow:</p><ol class="postList"><li name="7414" id="7414" class="graf graf--li graf-after--p">ask the card which applications are available on the card (“select PPSE”)(“Paypass Payment System Environment”)</li><li name="4753" id="4753" class="graf graf--li graf-after--li">analyze the card’s response and identify one or more of the application number or application id (“AID”)</li><li name="0d43" id="0d43" class="graf graf--li graf-after--li">select one application on the card to work with (“select AID”) [or iterate through the applications and run the following steps for each application]</li><li name="dc25" id="dc25" class="graf graf--li graf-after--li">analyze the card’s response to find out what data the card needs to proceed (find the “processing options data object list” (PDOL))</li><li name="3d4b" id="3d4b" class="graf graf--li graf-after--li">analyze the card’s response and get the content of the element “Application File Locator” (AFL) list</li><li name="7472" id="7472" class="graf graf--li graf-after--li">read all files given in the AFL list and find the file where there are the elements “Application Primary Account Number” and “Application Expiration Date”</li><li name="eda8" id="eda8" class="graf graf--li graf-after--li">find and print out the “Application Primary Account Number” (“PAN”) = card number and “Application Expiration Date” = expiration date of the card.</li></ol><p name="a6a5" id="a6a5" class="graf graf--p graf-after--li">At this point I’m placing two serious warnings: <strong class="markup--strong markup--p-strong">Please use a card that is outdated or terminated for your tests as you may damage your card irrevocably. Second: do not publish or send the the card data revealed by this app using an email as it may contain confidential data. Some data elements contain e.g. the card number in encrypted form so you can’t see that there are confidential data.</strong></p><p name="c3d8" id="c3d8" class="graf graf--p graf-after--p">Before we are starting our journey I give you some information on the “empty” card reader application (part 0) that will be the basis of our work.</p><p name="74aa" id="74aa" class="graf graf--p graf-after--p">To run the code we do need two permissions granted in the AndroidManifest.xml:</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="java" name="d0d7" id="d0d7" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">&lt;uses-permission android:name=<span class="hljs-string">&quot;android.permission.NFC&quot;</span> /&gt;<br />&lt;uses-permission android:name=<span class="hljs-string">&quot;android.permission.VIBRATE&quot;</span> /&gt; </span></pre><p name="34e8" id="34e8" class="graf graf--p graf-after--pre">The first one is to enable NFC support in our project and the second to enable an “card is read” indication vibration.</p><p name="2747" id="2747" class="graf graf--p graf-after--p">We do need 3 dependencies to run the app:</p><ol class="postList"><li name="dab6" id="dab6" class="graf graf--li graf-after--p">BER-TLV: as we need to search for and extract “Tag-Length-Value” data we do need this library</li><li name="fac6" id="fac6" class="graf graf--li graf-after--li">EMV-NFC-Paycard-Enrollment: although this library is a fully card reading library we use the library for nice “pretty-printing” of data we recieve as respond from our Credit Card</li><li name="4457" id="4457" class="graf graf--li graf-after--li">Android-About-Page: just a convenience library to sho an “About” page</li></ol><p name="a7f6" id="a7f6" class="graf graf--p graf-after--li">build.gradle (app):</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="csharp" name="6acc" id="6acc" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">    <span class="hljs-comment">// parsing BER-TLV encoded data, e.g. a credit card</span><br />    <span class="hljs-comment">// source: https://github.com/evsinev/ber-tlv</span><br />    implementation <span class="hljs-string">&#x27;com.payneteasy:ber-tlv:1.0-11&#x27;</span><br />    <br />    <span class="hljs-comment">// pretty printing of card&#x27;s responses</span><br />    <span class="hljs-comment">// source: https://github.com/devnied/EMV-NFC-Paycard-Enrollment</span><br />    implementation <span class="hljs-string">&#x27;com.github.devnied.emvnfccard:library:3.0.1&#x27;</span><br />    <br />    <span class="hljs-comment">// implementing an about page</span><br />    implementation <span class="hljs-string">&#x27;io.github.medyo:android-about-page:2.0.0&#x27;</span></span></pre><p name="5f59" id="5f59" class="graf graf--p graf-after--pre">The layout of the app is very simple — we just need two EditText components to display the reader’s “dataFound” and “logfile” and a progress bar indicating a running read process. Additionally there is a toolbar that has a small menu for copying the logFile data to the ClipBoard, save the content to a file, show the dependencies licenses and showing an “about” page:</p><p name="6349" id="6349" class="graf graf--p graf-after--p">activity_main.xml:</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="xml" name="6f48" id="6f48" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-8&quot;</span>?&gt;</span><br /><span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span><br />    <span class="hljs-attr">xmlns:app</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res-auto&quot;</span><br />    <span class="hljs-attr">xmlns:tools</span>=<span class="hljs-string">&quot;http://schemas.android.com/tools&quot;</span><br />    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span><br />    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span><br />    <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">&quot;vertical&quot;</span><br />    <span class="hljs-attr">tools:context</span>=<span class="hljs-string">&quot;.MainActivity&quot;</span>&gt;</span><br /><br />    <span class="hljs-tag">&lt;<span class="hljs-name">androidx.appcompat.widget.Toolbar</span><br />        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/main_toolbar&quot;</span><br />        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span><br />        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;?attr/actionBarSize&quot;</span><br />        <span class="hljs-attr">android:background</span>=<span class="hljs-string">&quot;@color/colorPrimary&quot;</span><br />        <span class="hljs-attr">android:elevation</span>=<span class="hljs-string">&quot;@dimen/toolbar_elevation&quot;</span><br />        <span class="hljs-attr">android:theme</span>=<span class="hljs-string">&quot;@style/ThemeOverlay.AppCompat.Dark.ActionBar&quot;</span><br />        <span class="hljs-attr">app:popupTheme</span>=<span class="hljs-string">&quot;@style/ThemeOverlay.AppCompat.Light&quot;</span> /&gt;</span><br /><br />    <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span><br />        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/tvTitle&quot;</span><br />        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span><br />        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span><br />        <span class="hljs-attr">android:padding</span>=<span class="hljs-string">&quot;10dp&quot;</span><br />        <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;Talk to your CreditCard&quot;</span><br />        <span class="hljs-attr">android:textAlignment</span>=<span class="hljs-string">&quot;center&quot;</span><br />        <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">&quot;20sp&quot;</span><br />        <span class="hljs-attr">android:textStyle</span>=<span class="hljs-string">&quot;bold&quot;</span> /&gt;</span><br /><br />    <span class="hljs-tag">&lt;<span class="hljs-name">ScrollView</span><br />        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span><br />        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;match_parent&quot;</span>&gt;</span><br /><br />        <span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span><br />            <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span><br />            <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span><br />            <span class="hljs-attr">android:layout_margin</span>=<span class="hljs-string">&quot;16dp&quot;</span><br />            <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">&quot;vertical&quot;</span>&gt;</span><br /><br />            <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span><br />                <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/tv1&quot;</span><br />                <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span><br />                <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span><br />                <span class="hljs-attr">android:layout_marginTop</span>=<span class="hljs-string">&quot;8dp&quot;</span><br />                <span class="hljs-attr">android:textAlignment</span>=<span class="hljs-string">&quot;center&quot;</span><br />                <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">&quot;16sp&quot;</span><br />                <span class="hljs-attr">android:background</span>=<span class="hljs-string">&quot;@drawable/round_rect_shape&quot;</span><br />                <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;we do need permissions for NFC and Vibration&quot;</span> /&gt;</span><br /><br />            <span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span><br />                <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/loading_layout&quot;</span><br />                <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span><br />                <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span><br />                <span class="hljs-attr">android:layout_gravity</span>=<span class="hljs-string">&quot;center&quot;</span><br />                <span class="hljs-attr">android:orientation</span>=<span class="hljs-string">&quot;vertical&quot;</span><br />                <span class="hljs-attr">android:visibility</span>=<span class="hljs-string">&quot;gone&quot;</span>&gt;</span><br /><br />                <span class="hljs-tag">&lt;<span class="hljs-name">ProgressBar</span><br />                    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span><br />                    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span><br />                    <span class="hljs-attr">android:layout_gravity</span>=<span class="hljs-string">&quot;center_horizontal&quot;</span> /&gt;</span><br /><br />                <span class="hljs-tag">&lt;<span class="hljs-name">TextView</span><br />                    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;wrap_content&quot;</span><br />                    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span><br />                    <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;read data - do not move the card&quot;</span> /&gt;</span><br /><br />            <span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br /><br />            <span class="hljs-tag">&lt;<span class="hljs-name">com.google.android.material.textfield.TextInputLayout</span><br />                <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/etDataLayout&quot;</span><br />                <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;@style/Widget.MaterialComponents.TextInputLayout.OutlinedBox&quot;</span><br />                <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span><br />                <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span><br />                <span class="hljs-attr">android:layout_marginTop</span>=<span class="hljs-string">&quot;8dp&quot;</span><br />                <span class="hljs-attr">android:hint</span>=<span class="hljs-string">&quot;Data:&quot;</span><br />                <span class="hljs-attr">android:visibility</span>=<span class="hljs-string">&quot;visible&quot;</span><br />                <span class="hljs-attr">app:boxCornerRadiusBottomEnd</span>=<span class="hljs-string">&quot;5dp&quot;</span><br />                <span class="hljs-attr">app:boxCornerRadiusBottomStart</span>=<span class="hljs-string">&quot;5dp&quot;</span><br />                <span class="hljs-attr">app:boxCornerRadiusTopEnd</span>=<span class="hljs-string">&quot;5dp&quot;</span><br />                <span class="hljs-attr">app:boxCornerRadiusTopStart</span>=<span class="hljs-string">&quot;5dp&quot;</span><br />                <span class="hljs-attr">app:endIconMode</span>=<span class="hljs-string">&quot;clear_text&quot;</span>&gt;</span><br /><br />                <span class="hljs-tag">&lt;<span class="hljs-name">com.google.android.material.textfield.TextInputEditText</span><br />                    <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/etData&quot;</span><br />                    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span><br />                    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span><br />                    <span class="hljs-attr">android:ellipsize</span>=<span class="hljs-string">&quot;end&quot;</span><br />                    <span class="hljs-attr">android:focusable</span>=<span class="hljs-string">&quot;false&quot;</span><br />                    <span class="hljs-attr">android:fontFamily</span>=<span class="hljs-string">&quot;monospace&quot;</span><br />                    <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;&quot;</span><br />                    <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">&quot;14sp&quot;</span><br />                    <span class="hljs-attr">android:visibility</span>=<span class="hljs-string">&quot;visible&quot;</span><br />                    <span class="hljs-attr">tools:ignore</span>=<span class="hljs-string">&quot;KeyboardInaccessibleWidget&quot;</span> /&gt;</span><br />            <span class="hljs-tag">&lt;/<span class="hljs-name">com.google.android.material.textfield.TextInputLayout</span>&gt;</span><br /><br />            <span class="hljs-tag">&lt;<span class="hljs-name">com.google.android.material.textfield.TextInputLayout</span><br />                <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/etLogLayout&quot;</span><br />                <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;@style/Widget.MaterialComponents.TextInputLayout.OutlinedBox&quot;</span><br />                <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span><br />                <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span><br />                <span class="hljs-attr">android:layout_marginTop</span>=<span class="hljs-string">&quot;8dp&quot;</span><br />                <span class="hljs-attr">android:hint</span>=<span class="hljs-string">&quot;Log:&quot;</span><br />                <span class="hljs-attr">android:visibility</span>=<span class="hljs-string">&quot;visible&quot;</span><br />                <span class="hljs-attr">app:boxCornerRadiusBottomEnd</span>=<span class="hljs-string">&quot;5dp&quot;</span><br />                <span class="hljs-attr">app:boxCornerRadiusBottomStart</span>=<span class="hljs-string">&quot;5dp&quot;</span><br />                <span class="hljs-attr">app:boxCornerRadiusTopEnd</span>=<span class="hljs-string">&quot;5dp&quot;</span><br />                <span class="hljs-attr">app:boxCornerRadiusTopStart</span>=<span class="hljs-string">&quot;5dp&quot;</span><br />                <span class="hljs-attr">app:endIconMode</span>=<span class="hljs-string">&quot;clear_text&quot;</span>&gt;</span><br /><br />                <span class="hljs-tag">&lt;<span class="hljs-name">com.google.android.material.textfield.TextInputEditText</span><br />                    <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/etLog&quot;</span><br />                    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span><br />                    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span><br />                    <span class="hljs-attr">android:ellipsize</span>=<span class="hljs-string">&quot;end&quot;</span><br />                    <span class="hljs-attr">android:focusable</span>=<span class="hljs-string">&quot;false&quot;</span><br />                    <span class="hljs-attr">android:fontFamily</span>=<span class="hljs-string">&quot;monospace&quot;</span><br />                    <span class="hljs-attr">android:text</span>=<span class="hljs-string">&quot;&quot;</span><br />                    <span class="hljs-attr">android:textSize</span>=<span class="hljs-string">&quot;14sp&quot;</span><br />                    <span class="hljs-attr">android:visibility</span>=<span class="hljs-string">&quot;visible&quot;</span><br />                    <span class="hljs-attr">tools:ignore</span>=<span class="hljs-string">&quot;KeyboardInaccessibleWidget&quot;</span> /&gt;</span><br />            <span class="hljs-tag">&lt;/<span class="hljs-name">com.google.android.material.textfield.TextInputLayout</span>&gt;</span><br /><br />            <span class="hljs-tag">&lt;<span class="hljs-name">com.google.android.material.divider.MaterialDivider</span><br />                <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span><br />                <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;wrap_content&quot;</span><br />                <span class="hljs-attr">android:layout_marginTop</span>=<span class="hljs-string">&quot;8dp&quot;</span><br />                <span class="hljs-attr">android:layout_marginBottom</span>=<span class="hljs-string">&quot;8dp&quot;</span><br />                <span class="hljs-attr">app:dividerInsetEnd</span>=<span class="hljs-string">&quot;16dp&quot;</span><br />                <span class="hljs-attr">app:dividerInsetStart</span>=<span class="hljs-string">&quot;16dp&quot;</span><br />                <span class="hljs-attr">app:dividerThickness</span>=<span class="hljs-string">&quot;4dp&quot;</span> /&gt;</span><br /><br />        <span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br />    <span class="hljs-tag">&lt;/<span class="hljs-name">ScrollView</span>&gt;</span><br /><br /><span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span></span></pre><p name="44b3" id="44b3" class="graf graf--p graf-after--pre">menu_activity_main.xml:</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="xml" name="8e65" id="8e65" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-tag">&lt;<span class="hljs-name">menu</span><br />    <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span><br />    <span class="hljs-attr">xmlns:app</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res-auto&quot;</span>&gt;</span><br /><br />    <span class="hljs-tag">&lt;<span class="hljs-name">item</span><br />        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/action_copy_data&quot;</span><br />        <span class="hljs-attr">android:title</span>=<span class="hljs-string">&quot;copy data&quot;</span><br />        <span class="hljs-attr">app:showAsAction</span>=<span class="hljs-string">&quot;never&quot;</span>/&gt;</span><br /><br />    <span class="hljs-tag">&lt;<span class="hljs-name">item</span><br />        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/action_export_text_file&quot;</span><br />        <span class="hljs-attr">android:title</span>=<span class="hljs-string">&quot;Export text File&quot;</span><br />        <span class="hljs-attr">app:showAsAction</span>=<span class="hljs-string">&quot;never&quot;</span>/&gt;</span><br /><br />    <span class="hljs-tag">&lt;<span class="hljs-name">item</span><br />        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/action_licenses&quot;</span><br />        <span class="hljs-attr">android:title</span>=<span class="hljs-string">&quot;Licenses&quot;</span><br />        <span class="hljs-attr">app:showAsAction</span>=<span class="hljs-string">&quot;never&quot;</span>/&gt;</span><br /><br />    <span class="hljs-tag">&lt;<span class="hljs-name">item</span><br />        <span class="hljs-attr">android:id</span>=<span class="hljs-string">&quot;@+id/action_about&quot;</span><br />        <span class="hljs-attr">android:title</span>=<span class="hljs-string">&quot;About the app&quot;</span><br />        <span class="hljs-attr">app:showAsAction</span>=<span class="hljs-string">&quot;never&quot;</span>/&gt;</span><br /><br /><span class="hljs-tag">&lt;/<span class="hljs-name">menu</span>&gt;</span></span></pre><p name="611a" id="611a" class="graf graf--p graf-after--pre">The res/raw folder contains two MP3-files for the “ping”-ringtones that are played when reading of the card starts and ends.</p><p name="731e" id="731e" class="graf graf--p graf-after--p">The MainActivity.java class implements <strong class="markup--strong markup--p-strong">NfcAdapter.ReaderCallback</strong> so I’m using the <strong class="markup--strong markup--p-strong">NFC Reader mode</strong> to get access to the card. This way the application is not started by an intent when an NFC tag is detected —<strong class="markup--strong markup--p-strong"> the read process starts only when the application is in the foreground</strong>. On the other hand this process is more reliable because our app get’s the “first access” to the data.</p><p name="b7dd" id="b7dd" class="graf graf--p graf-after--p">MainActivity.java:</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="java" name="ab7f" id="ab7f" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">package</span> de.androidcrypto.talktoyourcreditcard;<br /><br /><span class="hljs-keyword">import</span> android.app.Activity;<br /><span class="hljs-keyword">import</span> android.content.ClipData;<br /><span class="hljs-keyword">import</span> android.content.ClipboardManager;<br /><span class="hljs-keyword">import</span> android.content.Context;<br /><span class="hljs-keyword">import</span> android.content.Intent;<br /><span class="hljs-keyword">import</span> android.media.MediaPlayer;<br /><span class="hljs-keyword">import</span> android.net.Uri;<br /><span class="hljs-keyword">import</span> android.nfc.NfcAdapter;<br /><span class="hljs-keyword">import</span> android.nfc.Tag;<br /><span class="hljs-keyword">import</span> android.nfc.tech.IsoDep;<br /><span class="hljs-keyword">import</span> android.os.Build;<br /><span class="hljs-keyword">import</span> android.os.Bundle;<br /><span class="hljs-keyword">import</span> android.os.VibrationEffect;<br /><span class="hljs-keyword">import</span> android.os.Vibrator;<br /><span class="hljs-keyword">import</span> android.provider.Settings;<br /><span class="hljs-keyword">import</span> android.text.TextUtils;<br /><span class="hljs-keyword">import</span> android.util.Log;<br /><span class="hljs-keyword">import</span> android.view.Gravity;<br /><span class="hljs-keyword">import</span> android.view.LayoutInflater;<br /><span class="hljs-keyword">import</span> android.view.Menu;<br /><span class="hljs-keyword">import</span> android.view.MenuItem;<br /><span class="hljs-keyword">import</span> android.view.View;<br /><span class="hljs-keyword">import</span> android.webkit.WebView;<br /><span class="hljs-keyword">import</span> android.widget.TextView;<br /><span class="hljs-keyword">import</span> android.widget.Toast;<br /><br /><span class="hljs-keyword">import</span> androidx.activity.result.ActivityResult;<br /><span class="hljs-keyword">import</span> androidx.activity.result.ActivityResultCallback;<br /><span class="hljs-keyword">import</span> androidx.activity.result.ActivityResultLauncher;<br /><span class="hljs-keyword">import</span> androidx.activity.result.contract.ActivityResultContracts;<br /><span class="hljs-keyword">import</span> androidx.annotation.NonNull;<br /><span class="hljs-keyword">import</span> androidx.appcompat.app.AppCompatActivity;<br /><span class="hljs-keyword">import</span> androidx.appcompat.widget.Toolbar;<br /><br /><span class="hljs-keyword">import</span> com.github.devnied.emvnfccard.enums.CommandEnum;<br /><span class="hljs-keyword">import</span> com.github.devnied.emvnfccard.exception.CommunicationException;<br /><span class="hljs-keyword">import</span> com.github.devnied.emvnfccard.iso7816emv.EmvTags;<br /><span class="hljs-keyword">import</span> com.github.devnied.emvnfccard.iso7816emv.impl.DefaultTerminalImpl;<br /><span class="hljs-keyword">import</span> com.github.devnied.emvnfccard.utils.CommandApdu;<br /><span class="hljs-keyword">import</span> com.github.devnied.emvnfccard.utils.TlvUtil;<br /><span class="hljs-keyword">import</span> com.payneteasy.tlv.BerTag;<br /><span class="hljs-keyword">import</span> com.payneteasy.tlv.BerTlv;<br /><span class="hljs-keyword">import</span> com.payneteasy.tlv.BerTlvParser;<br /><span class="hljs-keyword">import</span> com.payneteasy.tlv.BerTlvs;<br /><br /><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br /><span class="hljs-keyword">import</span> java.io.IOException;<br /><span class="hljs-keyword">import</span> java.io.OutputStreamWriter;<br /><span class="hljs-keyword">import</span> java.math.BigInteger;<br /><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br /><span class="hljs-keyword">import</span> java.util.ArrayList;<br /><span class="hljs-keyword">import</span> java.util.Arrays;<br /><span class="hljs-keyword">import</span> java.util.Calendar;<br /><span class="hljs-keyword">import</span> java.util.List;<br /><br /><span class="hljs-keyword">import</span> mehdi.sakout.aboutpage.AboutPage;<br /><span class="hljs-keyword">import</span> mehdi.sakout.aboutpage.Element;<br /><br /><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AppCompatActivity</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">NfcAdapter</span>.ReaderCallback {<br /><br />    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TAG</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;MainAct&quot;</span>;<br />    <span class="hljs-keyword">private</span> com.google.android.material.textfield.TextInputEditText etData, etLog;<br />    <span class="hljs-keyword">private</span> View loadingLayout;<br />    <span class="hljs-keyword">private</span> NfcAdapter mNfcAdapter;<br /><br />    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">outputString</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>; <span class="hljs-comment">// used for the UI output</span><br />    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">exportString</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>; <span class="hljs-comment">// used for exporting the log to a text file</span><br />    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">exportStringFileName</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;emv.html&quot;</span>;<br />    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">stepSeparatorString</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;*********************************&quot;</span>;<br />    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">lineSeparatorString</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;---------------------------------&quot;</span>;<br />    Context context;<br /><br />    <span class="hljs-meta">@Override</span><br />    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(Bundle savedInstanceState)</span> {<br />        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br />        setContentView(R.layout.activity_main);<br />        <span class="hljs-type">Toolbar</span> <span class="hljs-variable">myToolbar</span> <span class="hljs-operator">=</span> (Toolbar) findViewById(R.id.main_toolbar);<br />        setSupportActionBar(myToolbar);<br /><br />        etData = findViewById(R.id.etData);<br />        etLog = findViewById(R.id.etLog);<br />        loadingLayout = findViewById(R.id.loading_layout);<br /><br />        context = getApplicationContext();<br /><br />        mNfcAdapter = NfcAdapter.getDefaultAdapter(<span class="hljs-built_in">this</span>);<br />    }<br /><br />    <span class="hljs-comment">/**<br />     * section for NFC<br />     */</span><br /><br />    <span class="hljs-comment">/**<br />     * This method is run in another thread when a card is discovered<br />     * This method cannot cannot direct interact with the UI Thread<br />     * Use `runOnUiThread` method to change the UI from this method<br />     *<br />     * <span class="hljs-doctag">@param</span> tag discovered tag<br />     */</span><br /><br />    <span class="hljs-meta">@Override</span><br />    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onTagDiscovered</span><span class="hljs-params">(Tag tag)</span> {<br />        clearData();<br />        Log.d(TAG, <span class="hljs-string">&quot;NFC tag discovered&quot;</span>);<br />        writeToUiAppend(<span class="hljs-string">&quot;NFC tag discovered&quot;</span>);<br />        playSinglePing();<br />        setLoadingLayoutVisibility(<span class="hljs-literal">true</span>);<br />        <span class="hljs-type">byte</span>[] tagId = tag.getId();<br />        writeToUiAppend(<span class="hljs-string">&quot;TagId: &quot;</span> + bytesToHexNpe(tagId));<br />        String[] techList = tag.getTechList();<br />        writeToUiAppend(<span class="hljs-string">&quot;TechList found with these entries:&quot;</span>);<br />        <span class="hljs-type">boolean</span> <span class="hljs-variable">isoDepInTechList</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br />        <span class="hljs-keyword">for</span> (String s : techList) {<br />            writeToUiAppend(s);<br />            <span class="hljs-keyword">if</span> (s.equals(<span class="hljs-string">&quot;android.nfc.tech.IsoDep&quot;</span>)) isoDepInTechList = <span class="hljs-literal">true</span>;<br />        }<br />        <span class="hljs-comment">// proceed only if tag has IsoDep in the techList</span><br />        <span class="hljs-keyword">if</span> (isoDepInTechList) {<br />            <span class="hljs-type">IsoDep</span> <span class="hljs-variable">nfc</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br />            nfc = IsoDep.get(tag);<br />            <span class="hljs-keyword">if</span> (nfc != <span class="hljs-literal">null</span>) {<br />                <span class="hljs-keyword">try</span> {<br />                    nfc.connect();<br />                    Log.d(TAG, <span class="hljs-string">&quot;connection with card success&quot;</span>);<br />                    writeToUiAppend(<span class="hljs-string">&quot;connection with card success&quot;</span>);<br />                    <span class="hljs-comment">// here we are going to start our journey through the card</span><br /><br />                    printStepHeader(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;our journey begins&quot;</span>);<br />                    writeToUiAppend(etData, <span class="hljs-string">&quot;00 reading of the card started&quot;</span>);<br /><br />                    writeToUiAppend(<span class="hljs-string">&quot;increase IsoDep timeout for long lasting reading&quot;</span>);<br />                    writeToUiAppend(<span class="hljs-string">&quot;timeout old: &quot;</span> + nfc.getTimeout() + <span class="hljs-string">&quot; ms&quot;</span>);<br />                    nfc.setTimeout(<span class="hljs-number">10000</span>);<br />                    writeToUiAppend(<span class="hljs-string">&quot;timeout new: &quot;</span> + nfc.getTimeout() + <span class="hljs-string">&quot; ms&quot;</span>);<br /><br /><br />                    <span class="hljs-comment">/**<br />                     * step 1 code start<br />                     */</span><br /><br /><br /><br />                    <span class="hljs-comment">/**<br />                     * step 1 code end<br />                     */</span><br /><br />                    printStepHeader(<span class="hljs-number">99</span>, <span class="hljs-string">&quot;our journey ends&quot;</span>);<br />                    writeToUiAppend(etData, <span class="hljs-string">&quot;99 reading of the card completed&quot;</span>);<br />                    vibrate();<br />                } <span class="hljs-keyword">catch</span> (IOException e) {<br />                    writeToUiAppend(<span class="hljs-string">&quot;connection with card failure&quot;</span>);<br />                    writeToUiAppend(e.getMessage());<br />                    <span class="hljs-comment">// throw new RuntimeException(e);</span><br />                    startEndSequence(nfc);<br />                    <span class="hljs-keyword">return</span>;<br />                }<br />            }<br />        } <span class="hljs-keyword">else</span> {<br />            <span class="hljs-comment">// if (isoDepInTechList) {</span><br />            writeToUiAppend(<span class="hljs-string">&quot;The discovered NFC tag does not have an IsoDep interface.&quot;</span>);<br />        }<br />        <span class="hljs-comment">// final cleanup</span><br />        playDoublePing();<br />        writeToUiFinal(etLog);<br />        setLoadingLayoutVisibility(<span class="hljs-literal">false</span>);<br />    }<br /><br /><br /><br />    <span class="hljs-comment">/**<br />     * section for emv reading<br />     */</span><br /><br /><br />    <span class="hljs-comment">/**<br />     * add blanks to a string on right side up to a length of len<br />     * if the data.length &gt;= len one character is deleted to get minimum one blank<br />     * <span class="hljs-doctag">@param</span> data<br />     * <span class="hljs-doctag">@param</span> len<br />     * <span class="hljs-doctag">@return</span><br />     */</span><br />    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">trimStringRight</span><span class="hljs-params">(String data, <span class="hljs-type">int</span> len)</span> {<br />        <span class="hljs-keyword">if</span> (data.length() &gt;= len) {<br />            data = data.substring(<span class="hljs-number">0</span>, (len - <span class="hljs-number">1</span>));<br />        }<br />        <span class="hljs-keyword">while</span> (data.length() &lt; len) {<br />            data = data + <span class="hljs-string">&quot; &quot;</span>;<br />        }<br />        <span class="hljs-keyword">return</span> data;<br />    }<br /><br />    <span class="hljs-comment">/**<br />     * checks if the response has an 0x&#x27;9000&#x27; at the end means success<br />     * and the method returns the data without 0x&#x27;9000&#x27; at the end<br />     * if any other trailing bytes show up the method returns NULL<br />     *<br />     * <span class="hljs-doctag">@param</span> data<br />     * <span class="hljs-doctag">@return</span><br />     */</span><br />    <span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[] checkResponse(<span class="hljs-meta">@NonNull</span> <span class="hljs-type">byte</span>[] data) {<br />        <span class="hljs-comment">// simple sanity check</span><br />        <span class="hljs-keyword">if</span> (data.length &lt; <span class="hljs-number">5</span>) {<br />            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br />        } <span class="hljs-comment">// not ok</span><br />        <span class="hljs-type">int</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> ((<span class="hljs-number">0xff</span> &amp; data[data.length - <span class="hljs-number">2</span>]) &lt;&lt; <span class="hljs-number">8</span>) | (<span class="hljs-number">0xff</span> &amp; data[data.length - <span class="hljs-number">1</span>]);<br />        <span class="hljs-keyword">if</span> (status != <span class="hljs-number">0x9000</span>) {<br />            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br />        } <span class="hljs-keyword">else</span> {<br />            <span class="hljs-keyword">return</span> Arrays.copyOfRange(data, <span class="hljs-number">0</span>, data.length - <span class="hljs-number">2</span>);<br />        }<br />    }<br /><br />    <span class="hljs-comment">/**<br />     * section for conversion utils<br />     */</span><br /><br />    <span class="hljs-comment">/**<br />     * converts a byte array to a hex encoded string<br />     * This method is Null Pointer Exception (NPE) safe<br />     *<br />     * <span class="hljs-doctag">@param</span> bytes<br />     * <span class="hljs-doctag">@return</span> hex encoded string<br />     */</span><br />    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">bytesToHexNpe</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> {<br />        <span class="hljs-keyword">if</span> (bytes != <span class="hljs-literal">null</span>) {<br />            <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br />            <span class="hljs-keyword">for</span> (<span class="hljs-type">byte</span> b : bytes)<br />                result.append(Integer.toString((b &amp; <span class="hljs-number">0xff</span>) + <span class="hljs-number">0x100</span>, <span class="hljs-number">16</span>).substring(<span class="hljs-number">1</span>));<br />            <span class="hljs-keyword">return</span> result.toString();<br />        } <span class="hljs-keyword">else</span> {<br />            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br />        }<br />    }<br /><br />    <span class="hljs-comment">/**<br />     * converts a byte array to a hex encoded string<br />     * This method is Null Pointer Exception (NPE) safe<br />     * <span class="hljs-doctag">@param</span> bytes<br />     * <span class="hljs-doctag">@return</span> hex encoded string with a blank after each value<br />     */</span><br />    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">bytesToHexBlankNpe</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> {<br />        <span class="hljs-keyword">if</span> (bytes == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br />        <span class="hljs-type">StringBuffer</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuffer</span>();<br />        <span class="hljs-keyword">for</span> (<span class="hljs-type">byte</span> b : bytes) result.append(Integer.toString((b &amp; <span class="hljs-number">0xff</span>) + <span class="hljs-number">0x100</span>, <span class="hljs-number">16</span>).substring(<span class="hljs-number">1</span>)).append(<span class="hljs-string">&quot; &quot;</span>);<br />        <span class="hljs-keyword">return</span> result.toString();<br />    }<br /><br />    <span class="hljs-comment">/**<br />     * converts a hex encoded string to a byte array<br />     *<br />     * <span class="hljs-doctag">@param</span> str<br />     * <span class="hljs-doctag">@return</span><br />     */</span><br />    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] hexToBytes(String str) {<br />        <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[str.length() / <span class="hljs-number">2</span>];<br />        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; bytes.length; i++) {<br />            bytes[i] = (<span class="hljs-type">byte</span>) Integer.parseInt(str.substring(<span class="hljs-number">2</span> * i, <span class="hljs-number">2</span> * i + <span class="hljs-number">2</span>),<br />                    <span class="hljs-number">16</span>);<br />        }<br />        <span class="hljs-keyword">return</span> bytes;<br />    }<br /><br />    <span class="hljs-comment">/**<br />     * converts a byte to int<br />     *<br />     * <span class="hljs-doctag">@param</span> b<br />     * <span class="hljs-doctag">@return</span><br />     */</span><br />    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">byteToInt</span><span class="hljs-params">(<span class="hljs-type">byte</span> b)</span> {<br />        <span class="hljs-keyword">return</span> (<span class="hljs-type">int</span>) b &amp; <span class="hljs-number">0xFF</span>;<br />    }<br /><br />    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">intFromByteArray</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] bytes)</span> {<br />        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(bytes).intValue();<br />    }<br /><br />    <span class="hljs-comment">/**<br />     * converts a byte to its hex string representation<br />     * <span class="hljs-doctag">@param</span> data<br />     * <span class="hljs-doctag">@return</span><br />     */</span><br />    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">byteToHex</span><span class="hljs-params">(<span class="hljs-type">byte</span> data)</span> {<br />        <span class="hljs-type">int</span> <span class="hljs-variable">hex</span> <span class="hljs-operator">=</span> data &amp; <span class="hljs-number">0xFF</span>;<br />        <span class="hljs-keyword">return</span> Integer.toHexString(hex);<br />    }<br /><br />    <span class="hljs-comment">/**<br />     * converts an integer to a byte array<br />     *<br />     * <span class="hljs-doctag">@param</span> value<br />     * <span class="hljs-doctag">@return</span><br />     */</span><br />    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] intToByteArray(<span class="hljs-type">int</span> value) {<br />        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigInteger</span>(String.valueOf(value)).toByteArray();<br />    }<br /><br />    <span class="hljs-comment">/**<br />     * splits a byte array in chunks<br />     *<br />     * <span class="hljs-doctag">@param</span> source<br />     * <span class="hljs-doctag">@param</span> chunksize<br />     * <span class="hljs-doctag">@return</span> a List&lt;byte[]&gt; with sets of chunksize<br />     */</span><br />    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> List&lt;<span class="hljs-type">byte</span>[]&gt; divideArray(<span class="hljs-type">byte</span>[] source, <span class="hljs-type">int</span> chunksize) {<br />        List&lt;<span class="hljs-type">byte</span>[]&gt; result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;<span class="hljs-type">byte</span>[]&gt;();<br />        <span class="hljs-type">int</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br />        <span class="hljs-keyword">while</span> (start &lt; source.length) {<br />            <span class="hljs-type">int</span> <span class="hljs-variable">end</span> <span class="hljs-operator">=</span> Math.min(source.length, start + chunksize);<br />            result.add(Arrays.copyOfRange(source, start, end));<br />            start += chunksize;<br />        }<br />        <span class="hljs-keyword">return</span> result;<br />    }<br /><br />    <span class="hljs-comment">/**<br />     * section for NFC<br />     */</span><br /><br />    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">showWirelessSettings</span><span class="hljs-params">()</span> {<br />        Toast.makeText(<span class="hljs-built_in">this</span>, <span class="hljs-string">&quot;You need to enable NFC&quot;</span>, Toast.LENGTH_SHORT).show();<br />        <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(Settings.ACTION_WIRELESS_SETTINGS);<br />        startActivity(intent);<br />    }<br /><br />    <span class="hljs-meta">@Override</span><br />    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onResume</span><span class="hljs-params">()</span> {<br />        <span class="hljs-built_in">super</span>.onResume();<br />        <span class="hljs-keyword">if</span> (mNfcAdapter != <span class="hljs-literal">null</span>) {<br />            <span class="hljs-keyword">if</span> (!mNfcAdapter.isEnabled())<br />                showWirelessSettings();<br />            <span class="hljs-type">Bundle</span> <span class="hljs-variable">options</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bundle</span>();<br />            <span class="hljs-comment">// Work around for some broken Nfc firmware implementations that poll the card too fast</span><br />            options.putInt(NfcAdapter.EXTRA_READER_PRESENCE_CHECK_DELAY, <span class="hljs-number">250</span>);<br />            <span class="hljs-comment">// Enable ReaderMode for all types of card and disable platform sounds</span><br />            <span class="hljs-comment">// the option NfcAdapter.FLAG_READER_SKIP_NDEF_CHECK is NOT set</span><br />            <span class="hljs-comment">// to get the data of the tag afer reading</span><br />            mNfcAdapter.enableReaderMode(<span class="hljs-built_in">this</span>,<br />                    <span class="hljs-built_in">this</span>,<br />                    NfcAdapter.FLAG_READER_NFC_A |<br />                            NfcAdapter.FLAG_READER_NFC_B |<br />                            NfcAdapter.FLAG_READER_NFC_F |<br />                            NfcAdapter.FLAG_READER_NFC_V |<br />                            NfcAdapter.FLAG_READER_NFC_BARCODE |<br />                            NfcAdapter.FLAG_READER_NO_PLATFORM_SOUNDS,<br />                    options);<br />        }<br />    }<br /><br />    <span class="hljs-comment">/**<br />     * important is the disabling of the ReaderMode when activity is pausing<br />     */</span><br /><br />    <span class="hljs-meta">@Override</span><br />    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onPause</span><span class="hljs-params">()</span> {<br />        <span class="hljs-built_in">super</span>.onPause();<br />        <span class="hljs-keyword">if</span> (mNfcAdapter != <span class="hljs-literal">null</span>)<br />            mNfcAdapter.disableReaderMode(<span class="hljs-built_in">this</span>);<br />    }<br /><br />    <span class="hljs-comment">/**<br />     * section for UI<br />     */</span><br /><br />    <span class="hljs-comment">/**<br />     * shows a progress bar as long as the reading lasts<br />     *<br />     * <span class="hljs-doctag">@param</span> isVisible<br />     */</span><br /><br />    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setLoadingLayoutVisibility</span><span class="hljs-params">(<span class="hljs-type">boolean</span> isVisible)</span> {<br />        runOnUiThread(() -&gt; {<br />            <span class="hljs-keyword">if</span> (isVisible) {<br />                loadingLayout.setVisibility(View.VISIBLE);<br />            } <span class="hljs-keyword">else</span> {<br />                loadingLayout.setVisibility(View.GONE);<br />            }<br />        });<br />    }<br /><br />    <span class="hljs-comment">/**<br />     * vibrate<br />     */</span><br />    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">vibrate</span><span class="hljs-params">()</span> {<br />        <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) {<br />            ((Vibrator) getSystemService(VIBRATOR_SERVICE)).vibrate(VibrationEffect.createOneShot(<span class="hljs-number">150</span>, <span class="hljs-number">10</span>));<br />        } <span class="hljs-keyword">else</span> {<br />            <span class="hljs-type">Vibrator</span> <span class="hljs-variable">v</span> <span class="hljs-operator">=</span> (Vibrator) getSystemService(Context.VIBRATOR_SERVICE);<br />            v.vibrate(<span class="hljs-number">200</span>);<br />        }<br />    }<br /><br />    <span class="hljs-comment">/**<br />     * Sound files downloaded from Material Design Sounds<br />     * https://m2.material.io/design/sound/sound-resources.html<br />     *<br />     */</span><br />    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">playSinglePing</span><span class="hljs-params">()</span> {<br />        <span class="hljs-type">MediaPlayer</span> <span class="hljs-variable">mp</span> <span class="hljs-operator">=</span> MediaPlayer.create(<span class="hljs-built_in">this</span>, R.raw.notification_decorative_02);<br />        mp.start();<br />    }<br /><br />    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">playDoublePing</span><span class="hljs-params">()</span> {<br />        <span class="hljs-type">MediaPlayer</span> <span class="hljs-variable">mp</span> <span class="hljs-operator">=</span> MediaPlayer.create(<span class="hljs-built_in">this</span>, R.raw.notification_decorative_01);<br />        mp.start();<br />    }<br /><br />    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">startEndSequence</span><span class="hljs-params">(IsoDep nfc)</span> {<br />        playDoublePing();<br />        writeToUiFinal(etLog);<br />        setLoadingLayoutVisibility(<span class="hljs-literal">false</span>);<br />        vibrate();<br />        <span class="hljs-keyword">try</span> {<br />            nfc.close();<br />        } <span class="hljs-keyword">catch</span> (IOException e) {<br />            <span class="hljs-comment">// throw new RuntimeException(e);</span><br />        }<br />        <span class="hljs-keyword">return</span>;<br />    }<br /><br />    <span class="hljs-comment">/**<br />     * prints a nice header for each step<br />     *<br />     * <span class="hljs-doctag">@param</span> step<br />     * <span class="hljs-doctag">@param</span> message<br />     */</span><br />    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">printStepHeader</span><span class="hljs-params">(<span class="hljs-type">int</span> step, String message)</span> {<br />        <span class="hljs-comment">// message should not extend 29 characters, longer messages will get trimmed</span><br />        <span class="hljs-type">String</span> <span class="hljs-variable">emptyMessage</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;                                 &quot;</span>;<br />        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br />        sb.append(outputString); <span class="hljs-comment">// has already a line feed at the end</span><br />        sb.append(<span class="hljs-string">&quot;&quot;</span>).append(<span class="hljs-string">&quot;\n&quot;</span>);<br />        sb.append(stepSeparatorString).append(<span class="hljs-string">&quot;\n&quot;</span>);<br />        sb.append(<span class="hljs-string">&quot;************ step &quot;</span>).append(String.format(<span class="hljs-string">&quot;%02d&quot;</span>, step)).append(<span class="hljs-string">&quot; ************&quot;</span>).append(<span class="hljs-string">&quot;\n&quot;</span>);<br />        sb.append(<span class="hljs-string">&quot;* &quot;</span>).append((message + emptyMessage).substring(<span class="hljs-number">0</span>, <span class="hljs-number">29</span>)).append(<span class="hljs-string">&quot; *&quot;</span>).append(<span class="hljs-string">&quot;\n&quot;</span>);<br />        sb.append(stepSeparatorString).append(<span class="hljs-string">&quot;\n&quot;</span>);<br />        outputString = sb.toString();<br />    }<br /><br />    <span class="hljs-comment">/**<br />     * used for printing the card responses in a human readable format to a string<br />     *<br />     * <span class="hljs-doctag">@param</span> responseData<br />     * <span class="hljs-doctag">@return</span><br />     */</span><br />    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">prettyPrintDataToString</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] responseData)</span> {<br />        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br />        sb.append(<span class="hljs-string">&quot;------------------------------------&quot;</span>).append(<span class="hljs-string">&quot;\n&quot;</span>);<br />        sb.append(trimLeadingLineFeeds(TlvUtil.prettyPrintAPDUResponse(responseData))).append(<span class="hljs-string">&quot;\n&quot;</span>);<br />        sb.append(<span class="hljs-string">&quot;------------------------------------&quot;</span>).append(<span class="hljs-string">&quot;\n&quot;</span>);<br />        <span class="hljs-keyword">return</span> sb.toString();<br />    }<br /><br />    <span class="hljs-comment">/**<br />     * trim leading line feeds if existing<br />     *<br />     * <span class="hljs-doctag">@param</span> input<br />     * <span class="hljs-doctag">@return</span><br />     */</span><br />    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">trimLeadingLineFeeds</span><span class="hljs-params">(String input)</span> {<br />        String[] output = input.split(<span class="hljs-string">&quot;^\\n+&quot;</span>, <span class="hljs-number">2</span>);<br />        <span class="hljs-keyword">return</span> output.length &gt; <span class="hljs-number">1</span> ? output[<span class="hljs-number">1</span>] : output[<span class="hljs-number">0</span>];<br />    }<br /><br />    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clearData</span><span class="hljs-params">()</span> {<br />        runOnUiThread(() -&gt; {<br />            outputString = <span class="hljs-string">&quot;&quot;</span>;<br />            exportString = <span class="hljs-string">&quot;&quot;</span>;<br />            etData.setText(<span class="hljs-string">&quot;&quot;</span>);<br />            etLog.setText(<span class="hljs-string">&quot;&quot;</span>);<br />        });<br />    }<br /><br />    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeToUiAppend</span><span class="hljs-params">(String message)</span> {<br />        <span class="hljs-comment">//System.out.println(message);</span><br />        outputString = outputString + message + <span class="hljs-string">&quot;\n&quot;</span>;<br />    }<br /><br />    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeToUiAppend</span><span class="hljs-params">(<span class="hljs-keyword">final</span> TextView textView, String message)</span> {<br />        runOnUiThread(() -&gt; {<br />            <span class="hljs-keyword">if</span> (TextUtils.isEmpty(textView.getText().toString())) {<br />                <span class="hljs-keyword">if</span> (textView == (TextView) etLog) {<br />                } <span class="hljs-keyword">else</span> {<br />                    textView.setText(message);<br />                }<br />            } <span class="hljs-keyword">else</span> {<br />                <span class="hljs-type">String</span> <span class="hljs-variable">newString</span> <span class="hljs-operator">=</span> textView.getText().toString() + <span class="hljs-string">&quot;\n&quot;</span> + message;<br />                <span class="hljs-keyword">if</span> (textView == (TextView) etLog) {<br />                } <span class="hljs-keyword">else</span> {<br />                    textView.setText(newString);<br />                }<br />            }<br />        });<br />    }<br /><br />    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeToUiFinal</span><span class="hljs-params">(<span class="hljs-keyword">final</span> TextView textView)</span> {<br />        <span class="hljs-keyword">if</span> (textView == (TextView) etLog) {<br />            runOnUiThread(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() {<br />                <span class="hljs-meta">@Override</span><br />                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {<br />                    textView.setText(outputString);<br />                    System.out.println(outputString); <span class="hljs-comment">// print the data to console</span><br />                }<br />            });<br />        }<br />    }<br /><br />    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">provideTextViewDataForExport</span><span class="hljs-params">(TextView textView)</span> {<br />        exportString = textView.getText().toString();<br />    }<br /><br />    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeToUiToast</span><span class="hljs-params">(String message)</span> {<br />        runOnUiThread(() -&gt; {<br />            Toast.makeText(getApplicationContext(),<br />                    message,<br />                    Toast.LENGTH_SHORT).show();<br />        });<br />    }<br /><br />    <span class="hljs-comment">/**<br />     * section OptionsMenu export text file methods<br />     */</span><br /><br />    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exportTextFile</span><span class="hljs-params">()</span> {<br />        provideTextViewDataForExport(etLog);<br />        <span class="hljs-keyword">if</span> (exportString.isEmpty()) {<br />            writeToUiToast(<span class="hljs-string">&quot;Scan a tag first before writing files :-)&quot;</span>);<br />            <span class="hljs-keyword">return</span>;<br />        }<br />        writeStringToExternalSharedStorage();<br />    }<br /><br />    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeStringToExternalSharedStorage</span><span class="hljs-params">()</span> {<br />        <span class="hljs-type">Intent</span> <span class="hljs-variable">intent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(Intent.ACTION_CREATE_DOCUMENT);<br />        intent.addCategory(Intent.CATEGORY_OPENABLE);<br />        intent.setType(<span class="hljs-string">&quot;*/*&quot;</span>);<br />        <span class="hljs-comment">// Optionally, specify a URI for the file that should appear in the</span><br />        <span class="hljs-comment">// system file picker when it loads.</span><br />        <span class="hljs-comment">// boolean pickerInitialUri = false;</span><br />        <span class="hljs-comment">// intent.putExtra(DocumentsContract.EXTRA_INITIAL_URI, pickerInitialUri);</span><br />        <span class="hljs-comment">// get filename from edittext</span><br />        <span class="hljs-type">String</span> <span class="hljs-variable">filename</span> <span class="hljs-operator">=</span> exportStringFileName;<br />        <span class="hljs-comment">// sanity check</span><br />        <span class="hljs-keyword">if</span> (filename.equals(<span class="hljs-string">&quot;&quot;</span>)) {<br />            writeToUiToast(<span class="hljs-string">&quot;scan a tag before writing the content to a file :-)&quot;</span>);<br />            <span class="hljs-keyword">return</span>;<br />        }<br />        intent.putExtra(Intent.EXTRA_TITLE, filename);<br />        selectTextFileActivityResultLauncher.launch(intent);<br />    }<br /><br />    ActivityResultLauncher&lt;Intent&gt; selectTextFileActivityResultLauncher = registerForActivityResult(<br />            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActivityResultContracts</span>.StartActivityForResult(),<br />            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ActivityResultCallback</span>&lt;ActivityResult&gt;() {<br />                <span class="hljs-meta">@Override</span><br />                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onActivityResult</span><span class="hljs-params">(ActivityResult result)</span> {<br />                    <span class="hljs-keyword">if</span> (result.getResultCode() == Activity.RESULT_OK) {<br />                        <span class="hljs-comment">// There are no request codes</span><br />                        <span class="hljs-type">Intent</span> <span class="hljs-variable">resultData</span> <span class="hljs-operator">=</span> result.getData();<br />                        <span class="hljs-comment">// The result data contains a URI for the document or directory that</span><br />                        <span class="hljs-comment">// the user selected.</span><br />                        <span class="hljs-type">Uri</span> <span class="hljs-variable">uri</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br />                        <span class="hljs-keyword">if</span> (resultData != <span class="hljs-literal">null</span>) {<br />                            uri = resultData.getData();<br />                            <span class="hljs-comment">// Perform operations on the document using its URI.</span><br />                            <span class="hljs-keyword">try</span> {<br />                                <span class="hljs-comment">// get file content from edittext</span><br />                                <span class="hljs-type">String</span> <span class="hljs-variable">fileContent</span> <span class="hljs-operator">=</span> exportString;<br />                                System.out.println(<span class="hljs-string">&quot;## data to write: &quot;</span> + exportString);<br />                                writeTextToUri(uri, fileContent);<br />                                writeToUiToast(<span class="hljs-string">&quot;file written to external shared storage: &quot;</span> + uri.toString());<br />                            } <span class="hljs-keyword">catch</span> (IOException e) {<br />                                e.printStackTrace();<br />                                writeToUiToast(<span class="hljs-string">&quot;ERROR: &quot;</span> + e.toString());<br />                                <span class="hljs-keyword">return</span>;<br />                            }<br />                        }<br />                    }<br />                }<br />            });<br /><br />    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeTextToUri</span><span class="hljs-params">(Uri uri, String data)</span> <span class="hljs-keyword">throws</span> IOException {<br />        <span class="hljs-keyword">try</span> {<br />            System.out.println(<span class="hljs-string">&quot;** data to write: &quot;</span> + data);<br />            <span class="hljs-type">OutputStreamWriter</span> <span class="hljs-variable">outputStreamWriter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OutputStreamWriter</span>(getApplicationContext().getContentResolver().openOutputStream(uri));<br />            outputStreamWriter.write(data);<br />            outputStreamWriter.close();<br />        } <span class="hljs-keyword">catch</span> (IOException e) {<br />            System.out.println(<span class="hljs-string">&quot;Exception File write failed: &quot;</span> + e.toString());<br />        }<br />    }<br /><br />    <span class="hljs-comment">/**<br />     * options menu show licenses<br />     */</span><br /><br />    <span class="hljs-comment">// run: displayLicensesAlertDialog();</span><br />    <span class="hljs-comment">// display licenses dialog see: https://bignerdranch.com/blog/open-source-licenses-and-android/</span><br />    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">displayLicensesAlertDialog</span><span class="hljs-params">()</span> {<br />        <span class="hljs-type">WebView</span> <span class="hljs-variable">view</span> <span class="hljs-operator">=</span> (WebView) LayoutInflater.from(<span class="hljs-built_in">this</span>).inflate(R.layout.dialog_licenses, <span class="hljs-literal">null</span>);<br />        view.loadUrl(<span class="hljs-string">&quot;file:///android_asset/open_source_licenses.html&quot;</span>);<br />        android.app.<span class="hljs-type">AlertDialog</span> <span class="hljs-variable">mAlertDialog</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">android</span>.app.AlertDialog.Builder(MainActivity.<span class="hljs-built_in">this</span>).create();<br />        mAlertDialog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">android</span>.app.AlertDialog.Builder(<span class="hljs-built_in">this</span>, R.style.Theme_TalkToYourCreditCard)<br />                .setTitle(getString(R.string.action_licenses))<br />                .setView(view)<br />                .setPositiveButton(android.R.string.ok, <span class="hljs-literal">null</span>)<br />                .show();<br />    }<br /><br />    <span class="hljs-comment">/**<br />     * section for OptionsMenu<br />     */</span><br /><br />    <span class="hljs-meta">@Override</span><br />    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onCreateOptionsMenu</span><span class="hljs-params">(Menu menu)</span> {<br />        getMenuInflater().inflate(R.menu.menu_activity_main, menu);<br /><br />        <span class="hljs-type">MenuItem</span> <span class="hljs-variable">mCopyData</span> <span class="hljs-operator">=</span> menu.findItem(R.id.action_copy_data);<br />        mCopyData.setOnMenuItemClickListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MenuItem</span>.OnMenuItemClickListener() {<br />            <span class="hljs-meta">@Override</span><br />            <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onMenuItemClick</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> MenuItem menuItem)</span> {<br />                <span class="hljs-type">ClipboardManager</span> <span class="hljs-variable">clipboard</span> <span class="hljs-operator">=</span> (ClipboardManager)<br />                        getSystemService(Context.CLIPBOARD_SERVICE);<br />                <span class="hljs-type">ClipData</span> <span class="hljs-variable">clip</span> <span class="hljs-operator">=</span> ClipData.newPlainText(<span class="hljs-string">&quot;BasicNfcEmvReader&quot;</span>, etLog.getText());<br />                clipboard.setPrimaryClip(clip);<br />                <span class="hljs-comment">// show toast only on Android versions &lt; 13</span><br />                <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.S_V2)<br />                    Toast.makeText(getApplicationContext(), <span class="hljs-string">&quot;copied&quot;</span>, Toast.LENGTH_SHORT).show();<br />                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br />            }<br />        });<br /><br />        <span class="hljs-type">MenuItem</span> <span class="hljs-variable">mExportTextFile</span> <span class="hljs-operator">=</span> menu.findItem(R.id.action_export_text_file);<br />        mExportTextFile.setOnMenuItemClickListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MenuItem</span>.OnMenuItemClickListener() {<br />            <span class="hljs-meta">@Override</span><br />            <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onMenuItemClick</span><span class="hljs-params">(MenuItem item)</span> {<br />                Log.i(TAG, <span class="hljs-string">&quot;mExportTextFile&quot;</span>);<br />                exportTextFile();<br />                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br />            }<br />        });<br /><br />        <span class="hljs-type">MenuItem</span> <span class="hljs-variable">mLicenses</span> <span class="hljs-operator">=</span> menu.findItem(R.id.action_licenses);<br />        mLicenses.setOnMenuItemClickListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MenuItem</span>.OnMenuItemClickListener() {<br />            <span class="hljs-meta">@Override</span><br />            <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onMenuItemClick</span><span class="hljs-params">(MenuItem item)</span> {<br />                Log.i(TAG, <span class="hljs-string">&quot;mLicenses&quot;</span>);<br />                displayLicensesAlertDialog();<br />                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br />            }<br />        });<br /><br />        <span class="hljs-type">MenuItem</span> <span class="hljs-variable">mAbout</span> <span class="hljs-operator">=</span> menu.findItem(R.id.action_about);<br />        mAbout.setOnMenuItemClickListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MenuItem</span>.OnMenuItemClickListener() {<br />            <span class="hljs-meta">@Override</span><br />            <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">onMenuItemClick</span><span class="hljs-params">(MenuItem item)</span> {<br />                Log.i(TAG, <span class="hljs-string">&quot;mLicenses&quot;</span>);<br />                <span class="hljs-type">CharSequence</span> <span class="hljs-variable">description</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;This is the basic app for the Talk to your Credit Card application&quot;</span>;<br />                <span class="hljs-type">View</span> <span class="hljs-variable">aboutPage</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AboutPage</span>(context)<br />                        .isRTL(<span class="hljs-literal">false</span>)<br />                        .setDescription(getString(R.string.app_description))<br />                        <span class="hljs-comment">//.setCustomFont(String) // or Typeface</span><br />                        .setImage(R.drawable.ic_launcher_playstore)<br />                        .addItem(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Element</span>().setTitle(<span class="hljs-string">&quot;Version 1.0&quot;</span>))<br />                        .addGroup(<span class="hljs-string">&quot;Connect with us&quot;</span>)<br />                        .addEmail(<span class="hljs-string">&quot;androidcrypto@gmx.de&quot;</span>)<br />                        .addWebsite(<span class="hljs-string">&quot;https://medium.com/@androidcrypto&quot;</span>)<br />                        .addGitHub(<span class="hljs-string">&quot;androidcrypto&quot;</span>)<br />                        .addItem(getCopyRightsElement())<br />                        .create();<br />                setContentView(aboutPage);<br />                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br />            }<br />        });<br /><br />        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.onCreateOptionsMenu(menu);<br />    }<br /><br />    Element <span class="hljs-title function_">getCopyRightsElement</span><span class="hljs-params">()</span> {<br />        <span class="hljs-type">Element</span> <span class="hljs-variable">copyRightsElement</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Element</span>();<br />        <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">copyrights</span> <span class="hljs-operator">=</span> String.format(getString(R.string.copy_right), Calendar.getInstance().get(Calendar.YEAR));<br />        copyRightsElement.setTitle(copyrights);<br />        copyRightsElement.setIconDrawable(R.drawable.about_icon_copy_right);<br />        copyRightsElement.setAutoApplyIconTint(<span class="hljs-literal">true</span>);<br />        copyRightsElement.setIconTint(mehdi.sakout.aboutpage.R.color.about_item_icon_color);<br />        copyRightsElement.setIconNightTint(android.R.color.white);<br />        copyRightsElement.setGravity(Gravity.CENTER);<br />        copyRightsElement.setOnClickListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">View</span>.OnClickListener() {<br />            <span class="hljs-meta">@Override</span><br />            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onClick</span><span class="hljs-params">(View v)</span> {<br />                Toast.makeText(MainActivity.<span class="hljs-built_in">this</span>, copyrights, Toast.LENGTH_SHORT).show();<br />            }<br />        });<br />        <span class="hljs-keyword">return</span> copyRightsElement;<br />    }<br />}</span></pre><p name="673a" id="673a" class="graf graf--p graf-after--pre">Last but not least I’m using 3 additional dependencies for our work:</p><ol class="postList"><li name="3f3a" id="3f3a" class="graf graf--li graf-after--p">to analyze the card’s reading response I’m using the library “BER-TLV parser and builder” written by Evgeniy (evsinev). Find the source code <a href="https://github.com/evsinev/ber-tlv" data-href="https://github.com/evsinev/ber-tlv" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">here</a>.</li><li name="74c0" id="74c0" class="graf graf--li graf-after--li">for pretty printing of the card’s response I use the “EMV-NFC-Paycard-Enrollment” written by Julien Millau (devnied). Find the source code <a href="https://github.com/devnied/EMV-NFC-Paycard-Enrollment" data-href="https://github.com/devnied/EMV-NFC-Paycard-Enrollment" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">here</a>.</li><li name="0429" id="0429" class="graf graf--li graf-after--li">for showing the “About this app” page I’m using the library “Android About Page” written by Mehdi Sakout (medyo). Find the source code <a href="https://github.com/medyo/android-about-page" data-href="https://github.com/medyo/android-about-page" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">here</a>.</li></ol><p name="0ec6" id="0ec6" class="graf graf--p graf-after--li">The code should run on devices from Android 5 to Android 13+ and is tested on real devices with Android 5.0.1 SDK Level 21 LOLLIPOP = L, Android 8.0.0 SDK Level 26 = O and Android 13 SDK Level 33 Tiramisu = T.</p><p name="431d" id="431d" class="graf graf--p graf-after--p">When running the Basic app and tapping a credit card to the device’s NFC card reader the app recognizes the NFC tag and just logs some information:</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="plaintext" name="fb1b" id="fb1b" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">NFC tag discovered<br />TagId: 028eedb17074b0<br />TechList found with these entries:<br />android.nfc.tech.IsoDep<br />android.nfc.tech.NfcA<br />connection with card success<br /><br />*********************************<br />************ step 00 ************<br />* our journey begins            *<br />*********************************<br />increase IsoDep timeout for long reading<br />timeout old: 2000 ms<br />timeout new: 10000 ms</span></pre><p name="81fa" id="81fa" class="graf graf--p graf-after--pre">This information shows us that a) our Android device has enabled NFC capabilities, b) the NFC chip on the tag (Credit Card) could get read by the devices NFC system and c) — most important — that we get a connection to the card using the <strong class="markup--strong markup--p-strong">IsoDep class</strong> that is the basis for all further card readings. After a successful connect I’m increasing the timeout to not run in any error.</p><figure name="c26a" id="c26a" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*F2fTWovjxPPa4aeRl1ld5w.png" data-width="300" data-height="514" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*F2fTWovjxPPa4aeRl1ld5w.png"><figcaption class="imageCaption">Minimal out after tapping a Credit Card to the NFC reader</figcaption></figure><p name="6b20" id="6b20" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">The complete app code is available in my GitHub repository “TalkToYourCreditCard part 0”:</strong><a href="https://github.com/AndroidCrypto/TalkToYourCreditCardPart0" data-href="https://github.com/AndroidCrypto/TalkToYourCreditCardPart0" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"> TalkToYourCreditCardPart0</a></p><p name="ed33" id="ed33" class="graf graf--p graf-after--p">An additional note on the following steps: As all of the source codes run in the same package “de.androidcrypto.talktoyourcreditcard“ you will overwrite the previous app with the new app (step).</p><p name="2897" id="2897" class="graf graf--p graf-after--p graf--trailing">Go to the next article: <a href="https://medium.com/@androidcrypto/talk-to-your-credit-card-part-1-select-ppse-paypass-payment-system-environment-674bbc9745eb" data-href="https://medium.com/@androidcrypto/talk-to-your-credit-card-part-1-select-ppse-paypass-payment-system-environment-674bbc9745eb" class="markup--anchor markup--p-anchor" target="_blank"><strong class="markup--strong markup--p-strong">step 1: ask the card which applications are available on the card (“select PPSE”)</strong></a></p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@androidcrypto" class="p-author h-card">AndroidCrypto</a> on <a href="https://medium.com/p/d782ff19fc4a"><time class="dt-published" datetime="2023-04-12T09:32:08.044Z">April 12, 2023</time></a>.</p><p><a href="https://medium.com/@androidcrypto/talk-to-your-credit-card-android-nfc-java-d782ff19fc4a" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on December 24, 2023.</p></footer></article></body></html>