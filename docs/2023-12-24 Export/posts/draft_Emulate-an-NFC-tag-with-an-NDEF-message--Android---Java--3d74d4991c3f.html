<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Emulate an NFC-tag with an NDEF message (Android &amp; Java)</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Emulate an NFC-tag with an NDEF message (Android &amp; Java)</h1>
</header>
<section data-field="subtitle" class="p-summary">
Small devices (“tags”) that have Near Field Communication (“NFC”) capabilities are very common nowadays. There are different types…
</section>
<section data-field="body" class="e-content">
<section name="fc6e" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="81f1" id="81f1" class="graf graf--h3 graf--leading graf--title">Emulate an NFC-tag with an NDEF message (Android &amp; Java)</h3><p name="47c2" id="47c2" class="graf graf--p graf-after--h3">Small devices (“tags”) that have <strong class="markup--strong markup--p-strong">Near Field Communication (“NFC”)</strong> capabilities are very common nowadays. There are different types available that need different protocols to work with them. So the industry decided to provide a protocol that gives access to the data on a high-level way with a protocol named “<strong class="markup--strong markup--p-strong">NFC Data Exchange Format</strong>” or in short “<strong class="markup--strong markup--p-strong">NDEF</strong>”.</p><p name="561e" id="561e" class="graf graf--p graf-after--p">Although this article is about Android let us talk about Apple. There are a lot of Apple devices in the market and as Apple restricts the access to the NFC system there is just one way to access the data, and that is using the NDEF protocol.</p><p name="0459" id="0459" class="graf graf--p graf-after--p">A short overview of NDEF can be found with this <a href="https://learn.gototags.com/nfc/ndef" data-href="https://learn.gototags.com/nfc/ndef" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">link</a>. In very short, NDEF is a standardized format with a defined access point using a fixed “application identifier” (the value is “<strong class="markup--strong markup--p-strong">D2760000850101</strong>”). There are many tag reader available in the Google Play store but if you want to <strong class="markup--strong markup--p-strong">emulate an NDEF tag</strong> it is difficult to find an application that runs on modern Android versions.</p><p name="92f5" id="92f5" class="graf graf--p graf-after--p">I’m trying to close the gap and provide a simple but <strong class="markup--strong markup--p-strong">full working app that emulates an NDEF tag with a text message</strong>. There are of course many NDEF-types defined (e.g. for internet pages (URLs), Mime-types (media data) or Geolocation type (GPS coordinates)). Take my app as a basis for your individual needs and enhance it’s functionality.</p><p name="827d" id="827d" class="graf graf--p graf-after--p">Please keep in mind that <strong class="markup--strong markup--p-strong">the app is active since installation</strong> as it runs a <strong class="markup--strong markup--p-strong">HostApduService</strong>. If there are other apps on your phone providing data for NFC — AID “<strong class="markup--strong markup--p-strong">D2760000850101</strong>” (NDEF access) you run into problems (“routing conflict”) that needs to get resolved each time a card reader is tapped to the device and asking for an NDEF message.</p><p name="b77e" id="b77e" class="graf graf--p graf-after--p">There are 3 main functions in the app, available with the “Bottom Navigation Tabs”:</p><ol class="postList"><li name="6a7e" id="6a7e" class="graf graf--li graf-after--p">send an individual message in your NDEF message</li><li name="e8e9" id="e8e9" class="graf graf--li graf-after--li">read an NDEF message on a tag tapped to the device’s NFC reader using the high level API (“NDEF protocol”)</li><li name="0490" id="0490" class="graf graf--li graf-after--li">read an NDEF message on a tag tapped to the device’s NFC reader using the low level API (“IsoDep protocol”).</li></ol><p name="c42b" id="c42b" class="graf graf--p graf-after--li">The <strong class="markup--strong markup--p-strong">function 1 is working as long as the device is waken up</strong> (lock screen or any screen active). The app will deploy a static default message. If you choose the “Send” function you can choose from 3 options:</p><p name="3aa7" id="3aa7" class="graf graf--p graf-after--p">a) generating a dynamic message with the actual timestamp that changes every 2 seconds</p><p name="501b" id="501b" class="graf graf--p graf-after--p">b) generate a message with a defined text that gets appended by the timestamp as of submitting the data</p><p name="afd3" id="afd3" class="graf graf--p graf-after--p">c) use an URL as content</p><p name="bf72" id="bf72" class="graf graf--p graf-after--p">The <strong class="markup--strong markup--p-strong">functions 2 (read tag with NDERF protocol) and 3 (read tag with IsoDep protocol) do work only when the app is active and in the foreground</strong>. </p><p name="a4c5" id="a4c5" class="graf graf--p graf-after--p">To understand how to emulate a tag that is containing a NDEF message we can study what a reader is doing — based on that data we can respond the correct data for emulation. This shouldbe accompanied by reading the NFC Forum Type 4 Tag specification, available with this <a href="http://apps4android.org/nfc-specifications/NFCForum-TS-Type-4-Tag_2.0.pdf" data-href="http://apps4android.org/nfc-specifications/NFCForum-TS-Type-4-Tag_2.0.pdf" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">link</a>. </p><p name="380f" id="380f" class="graf graf--p graf-after--p">In the end there are 4 easy to follow steps to <strong class="markup--strong markup--p-strong">read</strong> data from a Type 4 tag:</p><ol class="postList"><li name="d2af" id="d2af" class="graf graf--li graf-after--p"><strong class="markup--strong markup--li-strong">select the NDEF specification</strong> on the tag by sending the byte sequence (here notated in hex encoding): “<em class="markup--em markup--li-em">00 A4 04 00 07 D2 76 00 00 85 01 01 00</em>”. The tag will answer with “<em class="markup--em markup--li-em">90 00</em>” as positive response</li><li name="2b86" id="2b86" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">select the Capability Container</strong> by sending the byte sequence (hex): “<em class="markup--em markup--li-em">00 A4 00 0C 02 </em><strong class="markup--strong markup--li-strong"><em class="markup--em markup--li-em">E1 03</em></strong>”, the tag will answer with “<em class="markup--em markup--li-em">90 00</em>” as positive response</li><li name="775b" id="775b" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">read the data in the Capability Container file</strong> (“ReadBinary data”) by  sending the (hex) sequence: “<em class="markup--em markup--li-em">00 B0 00 00 0F</em>”. The response is longer as the tag gives the reader some informations about the data to read: “<em class="markup--em markup--li-em">00 0F 20 00 3F 00 34 04 06 </em><strong class="markup--strong markup--li-strong"><em class="markup--em markup--li-em">E1 04</em></strong><em class="markup--em markup--li-em"> 00 FF 00 FF 9000</em>”. todo ###</li><li name="c570" id="c570" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">select the data file</strong> with this sequence: “<em class="markup--em markup--li-em">00 A4 00 0C 02 </em><strong class="markup--strong markup--li-strong"><em class="markup--em markup--li-em">E1 04</em></strong>”. If you compare this sequence to the one in step 2 you will see that the only difference is the byte at the end — the information comes from the response in step 3 where the address for the data is given (“<em class="markup--em markup--li-em">E1 04</em>”). The tag is responding with “90 00” means the file is selected and now ready to read</li><li name="65d2" id="65d2" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">read the data file length</strong> with this sequence: “<em class="markup--em markup--li-em">00 B0 00 00 02</em>”. This is an intermediate step to get the <strong class="markup--strong markup--li-strong">length of data</strong> for the final file read and the card is responding with “<em class="markup--em markup--li-em">00 2E 90 00</em>” — a 2 bytes long length field (hex x002E = decimal 46) and the positive response (“<em class="markup--em markup--li-em">90 00</em>”).</li><li name="9efb" id="9efb" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">read the data file</strong> with this sequence: “00 B0 00 02 2E”. Now we receive the complete data as a byte array: “<em class="markup--em markup--li-em">d1012a55046769746875622e636f6d2f416e64726f696443727970746f3f7461623d7265706f7369746f726965739000</em>” that has a trailing “<em class="markup--em markup--li-em">90 00</em>” indicating a positive response. The data contains a complete NDEF message containing one record of type “U” = “URL”. Giving the data into a hex to string converter reveals this information: “<em class="markup--em markup--li-em">�*Ugithub.com/AndroidCrypto?tab=repositories”.</em></li></ol><p name="6065" id="6065" class="graf graf--p graf-after--li">With these steps we are been able to emulate a tag by answering the “questions” from the card reader. Here is an short overview about the app.</p><p name="83a5" id="83a5" class="graf graf--p graf-after--p">To run the app we need permissions for “NFC” and “Vibration”, granted in the “<strong class="markup--strong markup--p-strong">AndroidManifest.xml</strong>” file. The emulation takes place in the “<strong class="markup--strong markup--p-strong">MyHostApduService.java</strong>” class but as this a <strong class="markup--strong markup--p-strong">Service class</strong> we need to declare the file in the AndroidManifest as well; we need to add a service section:</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="xml" name="66f4" id="66f4" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-tag">&lt;<span class="hljs-name">service</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;.MyHostApduService&quot;</span> <span class="hljs-attr">android:exported</span>=<span class="hljs-string">&quot;true&quot;</span><br />    <span class="hljs-attr">android:permission</span>=<span class="hljs-string">&quot;android.permission.BIND_NFC_SERVICE&quot;</span>&gt;</span><br />    <span class="hljs-tag">&lt;<span class="hljs-name">intent-filter</span>&gt;</span><br />       <span class="hljs-tag">&lt;<span class="hljs-name">action</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;android.nfc.cardemulation.action.HOST_APDU_SERVICE&quot;</span>/&gt;</span><br />       <span class="hljs-comment">&lt;!-- category required!!! this was not included in official android HCE documentation --&gt;</span><br />       <span class="hljs-tag">&lt;<span class="hljs-name">category</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;android.intent.category.DEFAULT&quot;</span>/&gt;</span><br />    <span class="hljs-tag">&lt;/<span class="hljs-name">intent-filter</span>&gt;</span><br />    <span class="hljs-tag">&lt;<span class="hljs-name">meta-data</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;android.nfc.cardemulation.host_apdu_service&quot;</span><br />    <span class="hljs-attr">ndroid:resource</span>=<span class="hljs-string">&quot;@xml/apduservice&quot;</span>/&gt;</span><br /><span class="hljs-tag">&lt;/<span class="hljs-name">service</span>&gt;</span></span></pre><p name="fb1d" id="fb1d" class="graf graf--p graf-after--pre">The service entry has a second reference to the file “<strong class="markup--strong markup--p-strong">apduservice</strong>” located in the <strong class="markup--strong markup--p-strong">resources/xml</strong> folder:  </p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="xml" name="1587" id="1587" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">apduservice.xml:<br /><br /><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;utf-8&quot;</span>?&gt;</span><br /><span class="hljs-tag">&lt;<span class="hljs-name">host-apdu-service</span> <span class="hljs-attr">xmlns:android</span>=<span class="hljs-string">&quot;http://schemas.android.com/apk/res/android&quot;</span><br />    <span class="hljs-attr">android:description</span>=<span class="hljs-string">&quot;@string/servicedesc&quot;</span><br />    <span class="hljs-attr">android:requireDeviceUnlock</span>=<span class="hljs-string">&quot;false&quot;</span>&gt;</span><br />    <span class="hljs-tag">&lt;<span class="hljs-name">aid-group</span> <span class="hljs-attr">android:description</span>=<span class="hljs-string">&quot;@string/aiddescription&quot;</span><br />        <span class="hljs-attr">android:category</span>=<span class="hljs-string">&quot;other&quot;</span>&gt;</span><br />        <span class="hljs-comment">&lt;!-- Sample for the demo application --&gt;</span><br />        <span class="hljs-tag">&lt;<span class="hljs-name">aid-filter</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;D2760000850101&quot;</span> /&gt;</span><br />    <span class="hljs-tag">&lt;/<span class="hljs-name">aid-group</span>&gt;</span><br /><span class="hljs-tag">&lt;/<span class="hljs-name">host-apdu-service</span>&gt;</span></span></pre><p name="897d" id="897d" class="graf graf--p graf-after--pre">This is the main entry point for every following steps — the “aid-filter” references to the “Application ID” (“AID”) “<strong class="markup--strong markup--p-strong">D2760000850101”</strong> that is reserved for <strong class="markup--strong markup--p-strong">NDEF messages</strong>. Choosing any other ID will cause a failure because every NDEF reader will ask for this AID and if this AID is not defined in the apduservice.xml file the read request will not be forwarded to our app (to the MyHostApduService.java class).</p><p name="630a" id="630a" class="graf graf--p graf-after--p">The main work is done in the <strong class="markup--strong markup--p-strong">MyHostApduService.java</strong> class. There are two main parts in the class — we do have 4 byte array definitions:</p><ol class="postList"><li name="eb8c" id="eb8c" class="graf graf--li graf-after--p">the select application is defined that way:</li></ol><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="java" name="eba0" id="eba0" class="graf graf--pre graf-after--li graf--preV2"><span class="pre--content"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">byte</span>[] SELECT_APPLICATION = {<br />            (<span class="hljs-type">byte</span>) <span class="hljs-number">0x00</span>, <span class="hljs-comment">// CLA - Class - Class of instruction</span><br />            (<span class="hljs-type">byte</span>) <span class="hljs-number">0xA4</span>, <span class="hljs-comment">// INS - Instruction - Instruction code</span><br />            (<span class="hljs-type">byte</span>) <span class="hljs-number">0x04</span>, <span class="hljs-comment">// P1 - Parameter 1 - Instruction parameter 1</span><br />            (<span class="hljs-type">byte</span>) <span class="hljs-number">0x00</span>, <span class="hljs-comment">// P2 - Parameter 2 - Instruction parameter 2</span><br />            (<span class="hljs-type">byte</span>) <span class="hljs-number">0x07</span>, <span class="hljs-comment">// Lc field - Number of bytes present in the data field of the command</span><br />            (<span class="hljs-type">byte</span>) <span class="hljs-number">0xD2</span>, (<span class="hljs-type">byte</span>) <span class="hljs-number">0x76</span>, (<span class="hljs-type">byte</span>) <span class="hljs-number">0x00</span>, (<span class="hljs-type">byte</span>) <span class="hljs-number">0x00</span>, (<span class="hljs-type">byte</span>) <span class="hljs-number">0x85</span>, (<span class="hljs-type">byte</span>) <span class="hljs-number">0x01</span>, (<span class="hljs-type">byte</span>) <span class="hljs-number">0x01</span>, <span class="hljs-comment">// NDEF Tag Application name D2 76 00 00 85 01 01</span><br />            (<span class="hljs-type">byte</span>) <span class="hljs-number">0x00</span>  <span class="hljs-comment">// Le field - Maximum number of bytes expected in the data field of the response to the command</span><br />    };</span></pre><p name="fe76" id="fe76" class="graf graf--p graf-after--pre">2. select capability container:</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="java" name="7cb7" id="7cb7" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">byte</span>[] SELECT_CAPABILITY_CONTAINER = {<br />            (<span class="hljs-type">byte</span>) <span class="hljs-number">0x00</span>, <span class="hljs-comment">// CLA - Class - Class of instruction</span><br />            (<span class="hljs-type">byte</span>) <span class="hljs-number">0xa4</span>, <span class="hljs-comment">// INS - Instruction - Instruction code</span><br />            (<span class="hljs-type">byte</span>) <span class="hljs-number">0x00</span>, <span class="hljs-comment">// P1 - Parameter 1 - Instruction parameter 1</span><br />            (<span class="hljs-type">byte</span>) <span class="hljs-number">0x0c</span>, <span class="hljs-comment">// P2 - Parameter 2 - Instruction parameter 2</span><br />            (<span class="hljs-type">byte</span>) <span class="hljs-number">0x02</span>, <span class="hljs-comment">// Lc field - Number of bytes present in the data field of the command</span><br />            (<span class="hljs-type">byte</span>) <span class="hljs-number">0xe1</span>, (<span class="hljs-type">byte</span>) <span class="hljs-number">0x03</span> <span class="hljs-comment">// file identifier of the CC file</span><br />    };</span></pre><p name="4ad3" id="4ad3" class="graf graf--p graf-after--pre">3. select NDEF file:</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="java" name="fdcc" id="fdcc" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">byte</span>[] SELECT_NDEF_FILE = {<br />            (<span class="hljs-type">byte</span>) <span class="hljs-number">0x00</span>, <span class="hljs-comment">// CLA - Class - Class of instruction</span><br />            (<span class="hljs-type">byte</span>) <span class="hljs-number">0xa4</span>, <span class="hljs-comment">// Instruction byte (INS) for Select command</span><br />            (<span class="hljs-type">byte</span>) <span class="hljs-number">0x00</span>, <span class="hljs-comment">// Parameter byte (P1), select by identifier</span><br />            (<span class="hljs-type">byte</span>) <span class="hljs-number">0x0c</span>, <span class="hljs-comment">// Parameter byte (P1), select by identifier</span><br />            (<span class="hljs-type">byte</span>) <span class="hljs-number">0x02</span>, <span class="hljs-comment">// Lc field - Number of bytes present in the data field of the command</span><br />            (<span class="hljs-type">byte</span>) <span class="hljs-number">0xE1</span>, (<span class="hljs-type">byte</span>) <span class="hljs-number">0x04</span> <span class="hljs-comment">// file identifier of the NDEF file retrieved from the CC file</span><br />    };</span></pre><p name="6bbf" id="6bbf" class="graf graf--p graf-after--pre">4. send capability container:</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="csharp" name="0635" id="0635" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">private</span> final <span class="hljs-keyword">static</span> <span class="hljs-built_in">byte</span>[] CAPABILITY_CONTAINER_FILE = <span class="hljs-keyword">new</span> <span class="hljs-built_in">byte</span>[] {<br />            <span class="hljs-number">0x00</span>, <span class="hljs-number">0x0f</span>, <span class="hljs-comment">// CCLEN</span><br />            <span class="hljs-number">0x20</span>, <span class="hljs-comment">// Mapping Version</span><br />            <span class="hljs-number">0x00</span>, <span class="hljs-number">0x3b</span>, <span class="hljs-comment">// Maximum R-APDU data size</span><br />            <span class="hljs-number">0x00</span>, <span class="hljs-number">0x34</span>, <span class="hljs-comment">// Maximum C-APDU data size</span><br />            <span class="hljs-number">0x04</span>, <span class="hljs-number">0x06</span>, <span class="hljs-comment">// Tag &amp; Length</span><br />            (<span class="hljs-built_in">byte</span>)<span class="hljs-number">0xe1</span>, <span class="hljs-number">0x04</span>, <span class="hljs-comment">// NDEF File Identifier</span><br />            (<span class="hljs-built_in">byte</span>) <span class="hljs-number">0x00</span>, (<span class="hljs-built_in">byte</span>) <span class="hljs-number">0xff</span>, <span class="hljs-comment">// Maximum NDEF size, do NOT extend this value</span><br />            <span class="hljs-number">0x00</span>, <span class="hljs-comment">// NDEF file read access granted</span><br />            (<span class="hljs-built_in">byte</span>)<span class="hljs-number">0xff</span>, <span class="hljs-comment">// NDEF File write access denied</span><br />    };</span></pre><p name="394c" id="394c" class="graf graf--p graf-after--pre">The second important part is the parsing of incoming apdu commands:</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="java" name="31a8" id="31a8" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-comment">/**<br />     * emulates an NFC Forum Tag Type 4<br />     */</span><br />    <span class="hljs-meta">@Override</span><br />    <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] processCommandApdu(<span class="hljs-type">byte</span>[] commandApdu, Bundle extras) {<br />        Log.d((TAG), <span class="hljs-string">&quot;commandApdu: &quot;</span> + Utils.bytesToHex(commandApdu)); <br />        <span class="hljs-comment">//if (Arrays.equals(SELECT_APP, commandApdu)) {</span><br />        <span class="hljs-comment">// check if commandApdu qualifies for SELECT_APPLICATION</span><br />        <span class="hljs-keyword">if</span> (Arrays.equals(SELECT_APPLICATION, commandApdu)) {<br />            mAppSelected = <span class="hljs-literal">true</span>;<br />            mCcSelected = <span class="hljs-literal">false</span>;<br />            mNdefSelected = <span class="hljs-literal">false</span>;<br />            Log.d((TAG), <span class="hljs-string">&quot;responseApdu: &quot;</span> + Utils.bytesToHex(SUCCESS_SW));<br />            <span class="hljs-keyword">return</span> SUCCESS_SW;<br />            <span class="hljs-comment">// check if commandApdu qualifies for SELECT_CAPABILITY_CONTAINER</span><br />        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mAppSelected &amp;&amp; Arrays.equals(SELECT_CAPABILITY_CONTAINER, commandApdu)) {<br />            mCcSelected = <span class="hljs-literal">true</span>;<br />            mNdefSelected = <span class="hljs-literal">false</span>;<br />            Log.d((TAG), <span class="hljs-string">&quot;responseApdu: &quot;</span> + Utils.bytesToHex(SUCCESS_SW));<br />            <span class="hljs-keyword">return</span> SUCCESS_SW;<br />            <span class="hljs-comment">// check if commandApdu qualifies for SELECT_NDEF_FILE</span><br />        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mAppSelected &amp;&amp; Arrays.equals(SELECT_NDEF_FILE, commandApdu)) {<br />            <span class="hljs-comment">// NDEF</span><br />            mCcSelected = <span class="hljs-literal">false</span>;<br />            mNdefSelected = <span class="hljs-literal">true</span>;<br />            Log.d((TAG), <span class="hljs-string">&quot;responseApdu: &quot;</span> + Utils.bytesToHex(SUCCESS_SW));<br />            <span class="hljs-keyword">return</span> SUCCESS_SW;<br />            <span class="hljs-comment">// check if commandApdu qualifies for // READ_BINARY</span><br />        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (commandApdu[<span class="hljs-number">0</span>] == (<span class="hljs-type">byte</span>)<span class="hljs-number">0x00</span> &amp;&amp; commandApdu[<span class="hljs-number">1</span>] == (<span class="hljs-type">byte</span>)<span class="hljs-number">0xb0</span>) {<br />            <span class="hljs-comment">// READ_BINARY</span><br />            <span class="hljs-comment">// get the offset an le (length) data</span><br />            <span class="hljs-comment">//System.out.println(&quot;** &quot; + Utils.bytesToHex(commandApdu) + &quot; in else if (commandApdu[0] == (byte)0x00 &amp;&amp; commandApdu[1] == (byte)0xb0) {&quot;);</span><br />            <span class="hljs-type">int</span> <span class="hljs-variable">offset</span> <span class="hljs-operator">=</span> (<span class="hljs-number">0x00ff</span> &amp; commandApdu[<span class="hljs-number">2</span>]) * <span class="hljs-number">256</span> + (<span class="hljs-number">0x00ff</span> &amp; commandApdu[<span class="hljs-number">3</span>]);<br />            <span class="hljs-type">int</span> <span class="hljs-variable">le</span> <span class="hljs-operator">=</span> <span class="hljs-number">0x00ff</span> &amp; commandApdu[<span class="hljs-number">4</span>];<br /><br />            <span class="hljs-type">byte</span>[] responseApdu = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[le + SUCCESS_SW.length];<br /><br />            <span class="hljs-keyword">if</span> (mCcSelected &amp;&amp; offset == <span class="hljs-number">0</span> &amp;&amp; le == CAPABILITY_CONTAINER_FILE.length) {<br />                System.arraycopy(CAPABILITY_CONTAINER_FILE, offset, responseApdu, <span class="hljs-number">0</span>, le);<br />                System.arraycopy(SUCCESS_SW, <span class="hljs-number">0</span>, responseApdu, le, SUCCESS_SW.length);<br />                Log.d((TAG), <span class="hljs-string">&quot;responseApdu: &quot;</span> + Utils.bytesToHex(responseApdu));<br />                <span class="hljs-keyword">return</span> responseApdu;<br />            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mNdefSelected) {<br />                <span class="hljs-keyword">if</span> (offset + le &lt;= mNdefRecordFile.length) {<br />                    System.arraycopy(mNdefRecordFile, offset, responseApdu, <span class="hljs-number">0</span>, le);<br />                    System.arraycopy(SUCCESS_SW, <span class="hljs-number">0</span>, responseApdu, le, SUCCESS_SW.length);<br />                    Log.d((TAG), <span class="hljs-string">&quot;responseApdu: &quot;</span> + Utils.bytesToHex(responseApdu));<br />                    <span class="hljs-keyword">return</span> responseApdu;<br />                }<br />            }<br />        }<br /><br />        <span class="hljs-comment">// The tag should return different errors for different reasons</span><br />        <span class="hljs-comment">// this emulation just returns the general error message</span><br />        Log.d((TAG), <span class="hljs-string">&quot;responseApdu: &quot;</span> + Utils.bytesToHex(FAILURE_SW));<br />        <span class="hljs-keyword">return</span> FAILURE_SW;<br />    }</span></pre><p name="e049" id="e049" class="graf graf--p graf-after--pre">That is the complete magic of the emulation. When tapping our emulated tag to a card reader running NXP’s TagInfo we get these informations in the NDEF-tab:</p><pre data-code-block-mode="0" spellcheck="false" name="870c" id="870c" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">-- NDEF ------------------------------<br><br># NFC data set information:<br>NDEF message containing 1 record<br>Current message size: 46 bytes<br>Maximum message size: 253 bytes<br>NFC data set access: Read-Only<br><br># Record #1: URI record:<br>Type Name Format: NFC Forum well-known type<br>Short Record<br>type: &quot;U&quot;<br>protocol field: https://<br>URI field: github.com/AndroidCrypto?tab=repositories<br>Payload length: 42 bytes<br>Payload data:<br><br>[00] 04 67 69 74 68 75 62 2E 63 6F 6D 2F 41 6E 64 72 |.github.com/Andr|<br>[10] 6F 69 64 43 72 79 70 74 6F 3F 74 61 62 3D 72 65 |oidCrypto?tab=re|<br>[20] 70 6F 73 69 74 6F 72 69 65 73                   |positories      |<br><br># NDEF message:<br>[00] D1 01 2A 55 04 67 69 74 68 75 62 2E 63 6F 6D 2F |..*U.github.com/|<br>[10] 41 6E 64 72 6F 69 64 43 72 79 70 74 6F 3F 74 61 |AndroidCrypto?ta|<br>[20] 62 3D 72 65 70 6F 73 69 74 6F 72 69 65 73       |b=repositories  |<br><br># Capability Container (CC) file content:<br>Mapping version 2.0<br>CC length: 15 bytes<br>Maximum Le value: 59 bytes<br>Maximum Lc value: 52 bytes<br>NDEF File Control TLV:<br>* Length: 6 bytes<br>* NDEF file ID: 0xE104<br>* Maximum NDEF data size: 255 bytes<br>* NDEF access: Read-Only<br>[0] 00 0F 20 00 3B 00 34 04 06 E1 04 00 FF 00 FF    |.. .;.4........ |<br><br># Type 4 Tag File Control Information (FCI):<br>Type 4 Tag v2 application FCI: [none]<br>CC file FCI: [none]<br>NDEF file FCI: [none]<br><br># NDEF file contents:<br>[00] 00 2E D1 01 2A 55 04 67 69 74 68 75 62 2E 63 6F |....*U.github.co|<br>[10] 6D 2F 41 6E 64 72 6F 69 64 43 72 79 70 74 6F 3F |m/AndroidCrypto?|<br>[20] 74 61 62 3D 72 65 70 6F 73 69 74 6F 72 69 65 73 |tab=repositories|</span></pre><p name="55ba" id="55ba" class="graf graf--p graf-after--pre">Without an NDEF reader in the foreground the device will ask for an app that can work with an incoming URL, usually one or two browser will “lift their finger”:</p><figure name="8965" id="8965" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*j29b9I5G_cVqmcfb2pkmIw.png" data-width="200" data-height="362" alt="The NFC reader detected an NFC tag with an NDEF message of type URL, so all applications that can work with such a content say “give the URL to me”" src="https://cdn-images-1.medium.com/max/800/1*j29b9I5G_cVqmcfb2pkmIw.png"><figcaption class="imageCaption">App chooser for an incoming URL</figcaption></figure><p name="0c9d" id="0c9d" class="graf graf--p graf-after--figure">After selecting the Chrome browser the URL is fired and the content is shown:</p><figure name="c6ac" id="c6ac" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*wRo8GlQr-XlFxGwRyUsrSw.png" data-width="200" data-height="368" alt="The content of the URL is shown in a browser" src="https://cdn-images-1.medium.com/max/800/1*wRo8GlQr-XlFxGwRyUsrSw.png"><figcaption class="imageCaption">The URL is the NDEF message is for the GitHub repository overview of the user “AndroidCrypto”</figcaption></figure><p name="a4b2" id="a4b2" class="graf graf--p graf-after--figure">As mentioned before, as long as the device that runs the emulator is active (means: the screen is not dark) the service will run. Without any further interaction a default text is shown in the NDEF message. If you run the app, choose the “send” tab and select “<strong class="markup--strong markup--p-strong">uses the actual timestamp</strong>” the app is presenting an actual timestamp every 2 seconds. The second option “<strong class="markup--strong markup--p-strong">use an individual message</strong>” enables the EditText to enter a message. The timestamp at the time of entering is added to the message. The third option “<strong class="markup--strong markup--p-strong">use an URL</strong>” enables the EditText to enter an URL (this MUST start with “https://”) that is included in the NDEF message.</p><figure name="0017" id="0017" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*BqYRkv0oB-1WZPF93PWzTg.png" data-width="200" data-height="363" alt="Screenshot of the send tab content" src="https://cdn-images-1.medium.com/max/800/1*BqYRkv0oB-1WZPF93PWzTg.png"><figcaption class="imageCaption">select the last radio button for an URL as NDEF message</figcaption></figure><p name="d5d9" id="d5d9" class="graf graf--p graf-after--figure">To complete the app overview, the third tab “read” uses the (high level API) NDEF protocol to read a tapped tag and returns the content:</p><figure name="b61a" id="b61a" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*fm1FMKYoSSiXbtnNxl_kHQ.png" data-width="200" data-height="363" alt="Screenshot of the read tab content" src="https://cdn-images-1.medium.com/max/800/1*fm1FMKYoSSiXbtnNxl_kHQ.png"><figcaption class="imageCaption">The reader read the emulated NDEF message containing an URL</figcaption></figure><p name="6a36" id="6a36" class="graf graf--p graf-after--figure">The fourth tab “read extended” uses the (low level API) IsoDep protocol to read the content of the message on a tapped to the device. The complete workflow is visible so you will find all step shown in this article.</p><figure name="57d8" id="57d8" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*_Db1W-0VIbDwvK21Fdu5Og.png" data-width="200" data-height="370" alt="Screenshot of the read extended tab part 1" src="https://cdn-images-1.medium.com/max/800/1*_Db1W-0VIbDwvK21Fdu5Og.png"></figure><figure name="a50d" id="a50d" class="graf graf--figure graf-after--figure"><img class="graf-image" data-image-id="1*6KGWYgevU2oa7e4doLlq4A.png" data-width="200" data-height="367" alt="Screenshot of the read extended tab part 2" src="https://cdn-images-1.medium.com/max/800/1*6KGWYgevU2oa7e4doLlq4A.png"></figure><p name="4660" id="4660" class="graf graf--p graf-after--figure"> The complete app source code is available in my GitHub repository:</p><p name="8042" id="8042" class="graf graf--p graf--empty graf-after--p"><br></p><p name="9bb5" id="9bb5" class="graf graf--p graf--empty graf-after--p graf--trailing"><br></p></div></div></section>
</section>
<footer><p><a href="https://medium.com/p/3d74d4991c3f">View original.</a></p><p>Exported from <a href="https://medium.com">Medium</a> on December 24, 2023.</p></footer></article></body></html>