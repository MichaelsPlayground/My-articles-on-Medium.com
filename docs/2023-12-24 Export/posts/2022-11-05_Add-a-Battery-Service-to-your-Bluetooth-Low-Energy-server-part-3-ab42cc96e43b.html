<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Add a Battery Service to your Bluetooth Low Energy server part 3</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Add a Battery Service to your Bluetooth Low Energy server part 3</h1>
</header>
<section data-field="subtitle" class="p-summary">
In part 2 of my article series about a Bluetooth Low Energy (BLE) server we implemented some interaction between the user interface (UI)…
</section>
<section data-field="body" class="e-content">
<section name="66e5" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="6548" id="6548" class="graf graf--h3 graf--leading graf--title">Add a Battery Service to your Bluetooth Low Energy server part 3</h3><p name="9336" id="9336" class="graf graf--p graf-after--h3">In <a href="https://medium.com/@androidcrypto/enhance-your-own-android-bluetooth-low-energy-server-part-2-980cac9f910f" data-href="https://medium.com/@androidcrypto/enhance-your-own-android-bluetooth-low-energy-server-part-2-980cac9f910f" class="markup--anchor markup--p-anchor" target="_blank">part 2</a> of my article series about a Bluetooth Low Energy (BLE) server we implemented some interaction between the user interface (UI) and the server. In this article I’m describing how to add a <strong class="markup--strong markup--p-strong">Battery Service</strong> to the server.</p><p name="72ba" id="72ba" class="graf graf--p graf-after--p">Why do we need a Battery Service on the server (device) ? There is a simple answer — because it is good practice and recommended by the Bluetooth organization. Most devices like thermometers, weather stations or glucose meter are battery powered and the client should monitor the battery level to warn the user before the device failing and shutting down due to an empty battery.</p><p name="893d" id="893d" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">At the end of the article we know how to work with properties, permissions, notifications and indications.</strong></p><p name="9815" id="9815" class="graf graf--p graf-after--p">This is the screen as it will look like when we are ready:</p><figure name="ee2b" id="ee2b" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*WDOK7TRNKeCeFmBswPz9EA.png" data-width="500" data-height="759" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*WDOK7TRNKeCeFmBswPz9EA.png"></figure><p name="7b1a" id="7b1a" class="graf graf--p graf-after--figure">At the moment the server is started the battery level is descending every second down to 0 independently of a connection.</p><p name="bce8" id="bce8" class="graf graf--p graf-after--p">As this article is orientated on the official documents of the Battery Service we need to know some information.</p><p name="6047" id="6047" class="graf graf--p graf-after--p">As seen in previous articles all of the data elements in a BLE server need to have specific numbers called UUIDs (“universally unique identifier”). You can generate thos number online (e.g. <a href="https://www.uuidgenerator.net/version4" data-href="https://www.uuidgenerator.net/version4" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">https://www.uuidgenerator.net/version4</a>) or — when orientated on known services — on the data the Bluetooth group is providing.</p><p name="e6b2" id="e6b2" class="graf graf--p graf-after--p">These are the steps to get your UUIDs and additional information:</p><ol class="postList"><li name="3ae5" id="3ae5" class="graf graf--li graf-after--p">Search the specifications website for Battery Service and download the specification <a href="https://www.bluetooth.com/specifications/specs/" data-href="https://www.bluetooth.com/specifications/specs/" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">here</a></li><li name="b75e" id="b75e" class="graf graf--li graf-after--li">find the Battery Service UUID (“0000180F-0000–1000–8000–00805f9b34fb”) and Battery Level (characteristic) UUID (“00002A19–0000–1000–8000–00805f9b34fb”) in the downloaded PDF document (“Assigned Numbers Document”) <a href="https://www.bluetooth.com/specifications/assigned-numbers/" data-href="https://www.bluetooth.com/specifications/assigned-numbers/" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">here</a></li><li name="f112" id="f112" class="graf graf--li graf-after--li">get the information how the data is formatted. This is a little bit tricky as the data is included in specification.xml files that are no longer available on the official servers to the public (only for members). A nice guy has downloaded and provides them in his <a href="https://github.com/oesmith/gatt-xml/" data-href="https://github.com/oesmith/gatt-xml/" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">GitHub repository</a> and there is a battery_service.xml available <a href="https://github.com/oesmith/gatt-xml/blob/master/org.bluetooth.service.battery_service.xml" data-href="https://github.com/oesmith/gatt-xml/blob/master/org.bluetooth.service.battery_service.xml" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">here</a>.</li></ol><p name="00e7" id="00e7" class="graf graf--p graf-after--li">One note on short and long UUIDs: sometimes you will find the short version but when running a server or client you will need the long version, e.g. the short version of the Battery Service is “0x180F”.</p><p name="77eb" id="77eb" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">This is the summary of all informations</strong>: the specification told us that the Battery Service provides one mandatory data field called Battery Level that is readable, additionally this field may be used with a notification (optional). We found the UUIDs for the service and characteristic. At least the xml file told us that the battery level is just one byte of information containing the value 0 (battery is empty) up to 100 (battery is full).</p><p name="41cb" id="41cb" class="graf graf--p graf-after--p">Similar to other services our new Battery Service is in a new .java file as well (BatteryService.java).</p><p name="a9db" id="a9db" class="graf graf--p graf-after--p">First we define the service and characteristic variables:</p><pre name="deef" id="deef" class="graf graf--pre graf-after--p">private static final UUID <em class="markup--em markup--pre-em">BATTERY_SERVICE_UUID </em>= UUID.<em class="markup--em markup--pre-em">fromString</em>(&quot;0000180F-0000-1000-8000-00805f9b34fb&quot;);<br>public static final UUID <em class="markup--em markup--pre-em">BATTERY_LEVEL_CHARACTERISTIC_UUID </em>= UUID.<em class="markup--em markup--pre-em">fromString</em>(&quot;00002A19-0000-1000-8000-00805f9b34fb&quot;);<br><br>private @NotNull final BluetoothGattService service = new BluetoothGattService(<em class="markup--em markup--pre-em">BATTERY_SERVICE_UUID</em>, <em class="markup--em markup--pre-em">SERVICE_TYPE_PRIMARY</em>);<br>private @NotNull final BluetoothGattCharacteristic characteristic = new BluetoothGattCharacteristic(<em class="markup--em markup--pre-em">BATTERY_LEVEL_CHARACTERISTIC_UUID</em>, <em class="markup--em markup--pre-em">PROPERTY_READ </em>| <em class="markup--em markup--pre-em">PROPERTY_NOTIFY</em>, <em class="markup--em markup--pre-em">PERMISSION_READ</em>);</pre><p name="b61c" id="b61c" class="graf graf--p graf-after--pre">As the new class is extended from BaseService we need to override the specific methods that we need for our new service:</p><pre name="82bb" id="82bb" class="graf graf--pre graf-after--p">@Override<br>public void onCentralDisconnected(@NotNull BluetoothCentral central) {<br>    if (noCentralsConnected()) {<br>        <em class="markup--em markup--pre-em">// note: as the battery service should run without any connection or interaction this could get commented out<br>        // stopNotifying();<br>    </em>}<br>}<br><br>@Override<br>public ReadResponse onCharacteristicRead(@NotNull BluetoothCentral central, @NotNull BluetoothGattCharacteristic characteristic) {<br>    if (characteristic.getUuid().equals(<em class="markup--em markup--pre-em">BATTERY_LEVEL_CHARACTERISTIC_UUID</em>)) {<br>        return new ReadResponse(GattStatus.<em class="markup--em markup--pre-em">SUCCESS</em>, new byte[]{(byte) ((byte) currentBL &amp; 0xFF)});<br>    }<br>    return super.onCharacteristicRead(central, characteristic);<br>}<br><br>@Override<br>public void onNotifyingEnabled(@NotNull BluetoothCentral central, @NotNull BluetoothGattCharacteristic characteristic) {<br>    if (characteristic.getUuid().equals(<em class="markup--em markup--pre-em">BATTERY_LEVEL_CHARACTERISTIC_UUID</em>)) {<br>        <em class="markup--em markup--pre-em">// note: as the battery service should run without any connection or interaction this could get commented out<br>        // notifyBatteryLevel();<br>    </em>}<br>}<br><br>@Override<br>public void onNotifyingDisabled(@NotNull BluetoothCentral central, @NotNull BluetoothGattCharacteristic characteristic) {<br>    if (characteristic.getUuid().equals(<em class="markup--em markup--pre-em">BATTERY_LEVEL_CHARACTERISTIC_UUID</em>)) {<br>        <em class="markup--em markup--pre-em">// note: as the battery service should run without any connection or interaction this could get commented out<br>        // stopNotifying();<br>    </em>}<br>}</pre><p name="004b" id="004b" class="graf graf--p graf-after--pre">In a real device we are having a sensor that measures something link temperature or the blood pressure, here we are simulating that the battery level is descending every second until 0:</p><pre name="1a31" id="1a31" class="graf graf--pre graf-after--p">private void notifyBatteryLevel() {<br>    currentBL += (int) - 1;<br>    final byte[] value = new byte[]{(byte) ((byte) currentBL &amp; 0xFF)};<br>    notifyCharacteristicChanged(value, characteristic);<br>    sendBatteryLevelToUi(value);<br>    <em class="markup--em markup--pre-em">// stop the countdown on 0, in a real device this is not necessary as the device stops when battery is empty<br>    </em>if (currentBL &lt; 1) {<br>        handler.removeCallbacks(notifyRunnable);<br>    } else {<br>        handler.postDelayed(notifyRunnable, 1000);<br>    }<br>    Timber.<em class="markup--em markup--pre-em">i</em>(&quot;new BL: %d&quot;, currentBL);<br>}</pre><p name="27a3" id="27a3" class="graf graf--p graf-after--pre">As we want to expose this value on the device itself we have to send it from here to the user interface with an Broadcast Intent:</p><pre name="39ac" id="39ac" class="graf graf--pre graf-after--p">private void sendBatteryLevelToUi(byte[] value) {<br>    BluetoothBytesParser parser = new BluetoothBytesParser(value);<br>    String valueString = parser.getIntValue(<em class="markup--em markup--pre-em">FORMAT_UINT8</em>).toString();<br>    Intent intent = new Intent(<em class="markup--em markup--pre-em">BLUETOOTH_SERVER_BATTERY_LEVEL</em>);<br>    intent.putExtra(<em class="markup--em markup--pre-em">BLUETOOTH_SERVER_BATTERY_LEVEL_EXTRA</em>, valueString);<br>    mContext.sendBroadcast(intent);<br>}</pre><p name="f460" id="f460" class="graf graf--p graf-after--pre">Now we are having a closer look to the characteristic definition:</p><pre name="cf4c" id="cf4c" class="graf graf--pre graf-after--p">BluetoothGattCharacteristic characteristic = new BluetoothGattCharacteristic(<br><em class="markup--em markup--pre-em">BATTERY_LEVEL_CHARACTERISTIC_UUID</em>, <em class="markup--em markup--pre-em">PROPERTY_READ </em>| <em class="markup--em markup--pre-em">PROPERTY_NOTIFY</em>, <em class="markup--em markup--pre-em">PERMISSION_READ</em>);</pre><p name="fad0" id="fad0" class="graf graf--p graf-after--pre"><strong class="markup--strong markup--p-strong">How to define the characteristic ?</strong> At this point we define if a characteristic is readable (PROPERTY_READ) and/or writable (PROPERTY_WRITE). As well we define that this characteristic is enabled for a notification (PROPERTY_NOTIFY) or indication (PROPERTY_INDICATE). There is a little difference between both , when using “indicate” the next value is send later the client needs to send a “received” conformation before the next value is distributed; for “notify” this is not done. When using a subscription (notify/indicate) it is important to add a “Client Characteristic Configuration Descriptor” to the characteristic: `characteristic.addDescriptor(getClientCharacteristicConfigurationDescriptor());`.</p><p name="d122" id="d122" class="graf graf--p graf-after--p">The last parameter will set the permission to read or write and should correspond to the property value.</p><p name="322f" id="322f" class="graf graf--p graf-after--p">Here is the forecast for a later article: what does happen when we are using `PERMISSION_READ_ENCRYPTED_MITM` instead of `PERMISSION_READ` ?</p><p name="c7d4" id="c7d4" class="graf graf--p graf-after--p">Now we are ready to build and run the app. You can check the behaviour of the app by conneting a client like the BleClientBlessedPart3 with the server or use the “nRF connect for mobile” app, I wrote a <a href="/@androidcrypto/connect-the-android-nrf-connect-mobile-app-with-a-bluetooth-low-energy-device-8ba900d70286" data-href="/@androidcrypto/connect-the-android-nrf-connect-mobile-app-with-a-bluetooth-low-energy-device-8ba900d70286" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">short manual</a> to run the app here on Medium.com.</p><p name="cc10" id="cc10" class="graf graf--p graf-after--p">The complete <strong class="markup--strong markup--p-strong">source code</strong> for the BleServerBlessedPart3 is available on my GitHub repository: <a href="https://github.com/AndroidCrypto/BleServerBlessedPart3" data-href="https://github.com/AndroidCrypto/BleServerBlessedPart3" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">https://github.com/AndroidCrypto/BleServerBlessedPart3</a>.</p><p name="e648" id="e648" class="graf graf--p graf-after--p graf--trailing">The companion article “<a href="https://medium.com/@androidcrypto/add-a-battery-service-listener-to-a-android-bluetooth-low-energy-client-part-3-c70e16ed130a" data-href="https://medium.com/@androidcrypto/add-a-battery-service-listener-to-a-android-bluetooth-low-energy-client-part-3-c70e16ed130a" class="markup--anchor markup--p-anchor" target="_blank">Enhance a Android Bluetooth Low Energy client part 3</a>” is published here on medium.com as well.</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@androidcrypto" class="p-author h-card">AndroidCrypto</a> on <a href="https://medium.com/p/ab42cc96e43b"><time class="dt-published" datetime="2022-11-05T14:02:19.856Z">November 5, 2022</time></a>.</p><p><a href="https://medium.com/@androidcrypto/add-a-battery-service-to-your-bluetooth-low-energy-server-part-3-ab42cc96e43b" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on December 24, 2023.</p></footer></article></body></html>