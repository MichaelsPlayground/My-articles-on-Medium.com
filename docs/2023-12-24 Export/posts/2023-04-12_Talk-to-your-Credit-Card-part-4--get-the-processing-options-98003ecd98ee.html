<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Talk to your Credit Card part 4: get the processing options</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Talk to your Credit Card part 4: get the processing options</h1>
</header>
<section data-field="subtitle" class="p-summary">
In part 3 we selected an application by it’s AID and got a response that differs between MasterCard and VisaCard.
</section>
<section data-field="body" class="e-content">
<section name="e8dc" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="38b4" id="38b4" class="graf graf--h3 graf--leading graf--title">Talk to your Credit Card part 4: get the processing options</h3><p name="6086" id="6086" class="graf graf--p graf-after--h3">In part 3 we selected an application by it’s AID and got a response that differs between MasterCard and VisaCard.</p><p name="a8ad" id="a8ad" class="graf graf--p graf-after--p">In this part we analyze the response, collect some data and provide them to the card to <strong class="markup--strong markup--p-strong">get the processing options (GPO)</strong>.</p><figure name="818c" id="818c" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*1sMMuj1SdmT7cqU4v-cGqQ.png" data-width="300" data-height="411" data-is-featured="true" alt="Screenshot of the app after reading a Credit Card" src="https://cdn-images-1.medium.com/max/800/1*1sMMuj1SdmT7cqU4v-cGqQ.png"></figure><p name="b978" id="b978" class="graf graf--p graf-after--figure">The tag we are focussing on is tag <em class="markup--em markup--p-em">0x9f38</em> (“<strong class="markup--strong markup--p-strong">Processing Options Data Object List (PDOL)</strong>”). You may have noticed that this tag is readable from a <strong class="markup--strong markup--p-strong">VisaCard</strong> but not from a <strong class="markup--strong markup--p-strong">MasterCard</strong>. We definitely need this information to proceed to the next step, but for a MasterCard solution you have to wait a little bit :-)</p><p name="3249" id="3249" class="graf graf--p graf-after--p">Let’s examine the prettyPrint for this tag <em class="markup--em markup--p-em">0x9f38.</em> <strong class="markup--strong markup--p-strong">The PDOL is a “request list”</strong>, means that the card want’s to know these data from the card reader or better from the payment terminal. Please remember that the purpose of an EMV card is making payments or transactions so if the card is presented to an NFC reader it always thinks “let’s make a transaction”.</p><pre data-code-block-mode="0" spellcheck="false" name="478c" id="478c" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">9F 38 0F -- Processing Options Data Object List (PDOL)<br>         9F 66 04 -- Terminal Transaction Qualifiers<br>         9F 02 06 -- Amount, Authorised (Numeric)<br>         9F 37 04 -- Unpredictable Number<br>         5F 2A 02 -- Transaction Currency Code<br>         9F 1A 02 -- Terminal Country Code</span></pre><p name="6f3f" id="6f3f" class="graf graf--p graf-after--pre">So the “data” is itself a list of tags and the length of data that needs to get returned from the terminal (the card reader) to the card.</p><p name="967b" id="967b" class="graf graf--p graf-after--p">A lot of posts propose to return just “nulled” data (data fields just containing <em class="markup--em markup--p-em">0x00</em>&#39;s). That may work for some cards but not in general. So I decided to make a “lookup class” that provide these data elements for a command to the card.</p><p name="3725" id="3725" class="graf graf--p graf-after--p">We append this code in MainActivity.java class:</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="java" name="d3a1" id="d3a1" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onTagDiscovered</span><span class="hljs-params">(Tag tag)</span> {<br />...<br /><span class="hljs-type">byte</span>[] selectAidResponseOk = checkResponse(selectAidResponse);<br /><span class="hljs-keyword">if</span> (selectAidResponseOk != <span class="hljs-literal">null</span>) {<br />  <span class="hljs-comment">//writeToUiAppend(&quot;&quot;);</span><br />  printStepHeader(<span class="hljs-number">4</span>, <span class="hljs-string">&quot;search for tag 0x9F38&quot;</span>);<br />  writeToUiAppend(<span class="hljs-string">&quot;04 search for tag 0x9F38 in the selectAid response&quot;</span>);<br />  <span class="hljs-comment">/**<br />   * note: different behaviour between VisaCard, Mastercard and German GiroCards<br />   * Mastercard has NO PDOL, Visa gives PDOL in tag 9F38<br />   * next step: search for tag 9F38 Processing Options Data Object List (PDOL)<br />   */</span><br />  <span class="hljs-type">BerTlvs</span> <span class="hljs-variable">tlvsAid</span> <span class="hljs-operator">=</span> parser.parse(selectAidResponseOk);<br />  <span class="hljs-type">BerTlv</span> <span class="hljs-variable">tag9f38</span> <span class="hljs-operator">=</span> tlvsAid.find(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BerTag</span>(<span class="hljs-number">0x9F</span>, <span class="hljs-number">0x38</span>));<br />  writeToUiAppend(etData, <span class="hljs-string">&quot;04 search for tag 0x9F38 in the selectAid response completed&quot;</span>);<br />  <span class="hljs-type">byte</span>[] gpoRequestCommand;<br /><br />  <span class="hljs-comment">// comment this out for regular workflow</span><br />  <span class="hljs-type">DolValues</span> <span class="hljs-variable">dolValues</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DolValues</span>();<br />  writeToUiAppend(<span class="hljs-string">&quot;Available predefined values for PDOL and CDOL&quot;</span>);<br />  writeToUiAppend(dolValues.dump());<br /><br />  <span class="hljs-keyword">if</span> (tag9f38 != <span class="hljs-literal">null</span>) {<br />      <span class="hljs-comment">/**<br />* the following code is for VisaCards and (German) GiroCards as we found a PDOL<br />*/</span><br />      writeToUiAppend(<span class="hljs-string">&quot;&quot;</span>);<br />      writeToUiAppend(<span class="hljs-string">&quot;### processing the American Express, VisaCard and GiroCard path ###&quot;</span>);<br />      writeToUiAppend(<span class="hljs-string">&quot;&quot;</span>);<br />      <span class="hljs-type">byte</span>[] pdolValue = tag9f38.getBytesValue();<br /><br />      writeToUiAppend(<span class="hljs-string">&quot;found tag 0x9F38 (PDOL) in the selectAid with this length: &quot;</span> + pdolValue.length + <span class="hljs-string">&quot; data: &quot;</span> + bytesToHexNpe(pdolValue));<br />      <span class="hljs-type">byte</span>[][] gpoRequestCommandArray = getGpoFromPdolExtended(pdolValue, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]{(<span class="hljs-type">byte</span>) <span class="hljs-number">0x00</span>}); <span class="hljs-comment">// 00 = default, maximum 03</span><br /><br />      gpoRequestCommand = gpoRequestCommandArray[<span class="hljs-number">0</span>];<br />      <span class="hljs-type">String</span> <span class="hljs-variable">pdolRequestString</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(gpoRequestCommandArray[<span class="hljs-number">1</span>], StandardCharsets.UTF_8);<br />      writeToUiAppend(<span class="hljs-string">&quot;&quot;</span>);<br />      writeToUiAppend(pdolRequestString);<br />  } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// if (tag9f38 != null) {</span><br />      <span class="hljs-comment">/**<br />* MasterCard code<br />*/</span><br />      writeToUiAppend(<span class="hljs-string">&quot;&quot;</span>);<br />      writeToUiAppend(<span class="hljs-string">&quot;### processing the MasterCard path ###&quot;</span>);<br />      writeToUiAppend(<span class="hljs-string">&quot;&quot;</span>);<br /><br />      writeToUiAppend(<span class="hljs-string">&quot;No PDOL found in the selectAid response, generating a &#x27;null&#x27; PDOL&quot;</span>);<br />      <span class="hljs-comment">//gpoRequestCommand = getGpoFromPdol(new byte[0]); // empty PDOL</span><br />      <span class="hljs-type">byte</span>[][] gpoRequestCommandArray = getGpoFromPdolExtended(<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">0</span>], <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[]{(<span class="hljs-type">byte</span>) <span class="hljs-number">0x00</span>});<br />      gpoRequestCommand = gpoRequestCommandArray[<span class="hljs-number">0</span>];<br />      <span class="hljs-type">String</span> <span class="hljs-variable">pdolRequestString</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(gpoRequestCommandArray[<span class="hljs-number">1</span>], StandardCharsets.UTF_8);<br />      writeToUiAppend(<span class="hljs-string">&quot;&quot;</span>);<br />      writeToUiAppend(pdolRequestString);<br />  }<br /><br />  <span class="hljs-comment">//writeToUiAppend(&quot;&quot;);</span><br />  printStepHeader(<span class="hljs-number">5</span>, <span class="hljs-string">&quot;get the processing options&quot;</span>);<br />  writeToUiAppend(<span class="hljs-string">&quot;05 get the processing options  command length: &quot;</span> + gpoRequestCommand.length + <span class="hljs-string">&quot; data: &quot;</span> + bytesToHexNpe(gpoRequestCommand));<br /><br />} <span class="hljs-keyword">else</span> { <span class="hljs-comment">// if (selectAidResponseOk != null) {</span><br />  writeToUiAppend(<span class="hljs-string">&quot;the selecting AID command failed&quot;</span>);<br />}</span></pre><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="java" name="647d" id="647d" class="graf graf--pre graf-after--pre graf--preV2"><span class="pre--content">From the main code we call the method getGpoFromPdolExtended:<br /><span class="hljs-type">byte</span>[][] gpoRequestCommandArray = getGpoFromPdolExtended(pdolValue, <span class="hljs-number">0</span>);<br />...<br /><br />    <span class="hljs-comment">/**<br />     * construct the getProcessingOptions command using the provided pdol<br />     * the default ttq is null, but another ttq can used if default ttq gives no result for later sending<br />     * <span class="hljs-doctag">@param</span> pdol<br />     * <span class="hljs-doctag">@param</span> ttq<br />     * <span class="hljs-doctag">@return</span> a byte[][] array<br />     * [0] = getProcessingOptions command<br />     * [1] = text table with requested tags from pdol with length and value<br />     */</span><br />    <span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[][] getGpoFromPdolExtended(<span class="hljs-meta">@NonNull</span> <span class="hljs-type">byte</span>[] pdol, <span class="hljs-type">int</span> ttq) {<br />        <span class="hljs-comment">// todo implement alternative ttq</span><br /><br />        <span class="hljs-type">byte</span>[][] result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">2</span>][];<br />        <span class="hljs-comment">// get the tags in a list</span><br />        List&lt;com.github.devnied.emvnfccard.iso7816emv.TagAndLength&gt; tagAndLength = TlvUtil.parseTagAndLength(pdol);<br />        <span class="hljs-type">int</span> <span class="hljs-variable">tagAndLengthSize</span> <span class="hljs-operator">=</span> tagAndLength.size();<br />        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">returnString</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br />        returnString.append(<span class="hljs-string">&quot;The card is requesting &quot;</span> + tagAndLengthSize + (tagAndLengthSize == <span class="hljs-number">1</span> ? <span class="hljs-string">&quot; tag&quot;</span> : <span class="hljs-string">&quot; tags&quot;</span>)).append(<span class="hljs-string">&quot; in the PDOL&quot;</span>).append(<span class="hljs-string">&quot;\n&quot;</span>);<br />        returnString.append(<span class="hljs-string">&quot;\n&quot;</span>);<br />        returnString.append(<span class="hljs-string">&quot;Tag  Tag Name                        Length Value&quot;</span>).append(<span class="hljs-string">&quot;\n&quot;</span>);<br />        returnString.append(<span class="hljs-string">&quot;-----------------------------------------------------&quot;</span>).append(<span class="hljs-string">&quot;\n&quot;</span>);<br />        <span class="hljs-keyword">if</span> (tagAndLengthSize &lt; <span class="hljs-number">1</span>) {<br />            returnString.append(<span class="hljs-string">&quot;     no PDOL provided, returning an empty command&quot;</span>).append(<span class="hljs-string">&quot;\n&quot;</span>);<br />            returnString.append(<span class="hljs-string">&quot;-----------------------------------------------------&quot;</span>);<br />            <span class="hljs-comment">// there are no pdols in the list</span><br />            <span class="hljs-comment">//Log.e(TAG, &quot;there are no PDOLs in the pdol array, aborted&quot;);</span><br />            <span class="hljs-comment">//return null;</span><br />            <span class="hljs-comment">// returning an empty PDOL</span><br />            <span class="hljs-type">String</span> <span class="hljs-variable">tagLength2d</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;00&quot;</span>; <span class="hljs-comment">// length value</span><br />            <span class="hljs-type">String</span> <span class="hljs-variable">tagLength2dAnd2</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;02&quot;</span>; <span class="hljs-comment">// length value + 2</span><br />            <span class="hljs-type">String</span> <span class="hljs-variable">constructedGpoCommandString</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;80A80000&quot;</span> + tagLength2dAnd2 + <span class="hljs-string">&quot;83&quot;</span> + tagLength2d + <span class="hljs-string">&quot;&quot;</span> + <span class="hljs-string">&quot;00&quot;</span>;<br />            result[<span class="hljs-number">0</span>] = hexToBytes(constructedGpoCommandString);<br />            result[<span class="hljs-number">1</span>] = returnString.toString().getBytes(StandardCharsets.UTF_8);<br />            <span class="hljs-keyword">return</span> result;<br />            <span class="hljs-comment">//return hexToBytes(constructedGpoCommandString);</span><br />        }<br />        <span class="hljs-type">int</span> <span class="hljs-variable">valueOfTagSum</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// total length</span><br />        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(); <span class="hljs-comment">// takes the default values of the tags</span><br />        <span class="hljs-type">DolValues</span> <span class="hljs-variable">dolValues</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DolValues</span>();<br />        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; tagAndLengthSize; i++) {<br />            <span class="hljs-comment">// get a single tag</span><br />            com.github.devnied.emvnfccard.iso7816emv.<span class="hljs-type">TagAndLength</span> <span class="hljs-variable">tal</span> <span class="hljs-operator">=</span> tagAndLength.get(i); <span class="hljs-comment">// eg 9f3704</span><br />            <span class="hljs-type">byte</span>[] tagToSearch = tal.getTag().getTagBytes(); <span class="hljs-comment">// gives the tag 9f37</span><br />            <span class="hljs-type">int</span> <span class="hljs-variable">lengthOfTag</span> <span class="hljs-operator">=</span> tal.getLength(); <span class="hljs-comment">// 4</span><br />            <span class="hljs-type">String</span> <span class="hljs-variable">nameOfTag</span> <span class="hljs-operator">=</span> tal.getTag().getName();<br />            valueOfTagSum += tal.getLength(); <span class="hljs-comment">// add it to the sum</span><br />            <span class="hljs-comment">// now we are trying to find a default value</span><br />            <span class="hljs-type">byte</span>[] defaultValue = dolValues.getDolValue(tagToSearch);<br />            <span class="hljs-type">byte</span>[] usedValue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">0</span>];<br />            <span class="hljs-keyword">if</span> (defaultValue != <span class="hljs-literal">null</span>) {<br />                <span class="hljs-keyword">if</span> (defaultValue.length &gt; lengthOfTag) {<br />                    <span class="hljs-comment">// cut it to correct length</span><br />                    usedValue = Arrays.copyOfRange(defaultValue, <span class="hljs-number">0</span>, lengthOfTag);<br />                    Log.i(TAG, <span class="hljs-string">&quot;asked for tag: &quot;</span> + bytesToHexNpe(tal.getTag().getTagBytes()) + <span class="hljs-string">&quot; default is too long, cut to: &quot;</span> + bytesToHexNpe(usedValue));<br />                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (defaultValue.length &lt; lengthOfTag) {<br />                    <span class="hljs-comment">// increase length</span><br />                    usedValue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[lengthOfTag];<br />                    System.arraycopy(defaultValue, <span class="hljs-number">0</span>, usedValue, <span class="hljs-number">0</span>, defaultValue.length);<br />                    Log.i(TAG, <span class="hljs-string">&quot;asked for tag: &quot;</span> + bytesToHexNpe(tal.getTag().getTagBytes()) + <span class="hljs-string">&quot; default is too short, increased to: &quot;</span> + bytesToHexNpe(usedValue));<br />                } <span class="hljs-keyword">else</span> {<br />                    <span class="hljs-comment">// correct length</span><br />                    usedValue = defaultValue.clone();<br />                    Log.i(TAG, <span class="hljs-string">&quot;asked for tag: &quot;</span> + bytesToHexNpe(tal.getTag().getTagBytes()) + <span class="hljs-string">&quot; default found: &quot;</span> + bytesToHexNpe(usedValue));<br />                }<br />            } <span class="hljs-keyword">else</span> {<br />                <span class="hljs-comment">// defaultValue is null means the tag was not found in our tags database for default values</span><br />                usedValue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[lengthOfTag];<br />                Log.i(TAG, <span class="hljs-string">&quot;asked for tag: &quot;</span> + bytesToHexNpe(tal.getTag().getTagBytes()) + <span class="hljs-string">&quot; NO default found, generate zeroed: &quot;</span> + bytesToHexNpe(usedValue));<br />            }<br />            <span class="hljs-comment">// now usedValue does have the correct length</span><br />            sb.append(bytesToHexNpe(usedValue));<br />            returnString.append(trimStringRight(bytesToHexNpe(tagToSearch),<span class="hljs-number">5</span>)).append(trimStringRight(nameOfTag, <span class="hljs-number">36</span>)).append(trimStringRight(String.valueOf(lengthOfTag), <span class="hljs-number">3</span>)).append(bytesToHexBlankNpe(usedValue)).append(<span class="hljs-string">&quot;\n&quot;</span>);<br />        }<br />        returnString.append(<span class="hljs-string">&quot;-----------------------------------------------------&quot;</span>).append(<span class="hljs-string">&quot;\n&quot;</span>);<br />        <span class="hljs-type">String</span> <span class="hljs-variable">constructedGpoString</span> <span class="hljs-operator">=</span> sb.toString();<br />        <span class="hljs-type">String</span> <span class="hljs-variable">tagLength2d</span> <span class="hljs-operator">=</span> bytesToHexNpe(intToByteArray(valueOfTagSum)); <span class="hljs-comment">// length value</span><br />        <span class="hljs-type">String</span> <span class="hljs-variable">tagLength2dAnd2</span> <span class="hljs-operator">=</span> bytesToHexNpe(intToByteArray(valueOfTagSum + <span class="hljs-number">2</span>)); <span class="hljs-comment">// length value + 2</span><br />        <span class="hljs-type">String</span> <span class="hljs-variable">constructedGpoCommandString</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;80A80000&quot;</span> + tagLength2dAnd2 + <span class="hljs-string">&quot;83&quot;</span> + tagLength2d + constructedGpoString + <span class="hljs-string">&quot;00&quot;</span>;<br />        result[<span class="hljs-number">0</span>] = hexToBytes(constructedGpoCommandString);<br />        result[<span class="hljs-number">1</span>] = returnString.toString().getBytes(StandardCharsets.UTF_8);<br />        <span class="hljs-keyword">return</span> result;<br />        <span class="hljs-comment">//return hexToBytes(constructedGpoCommandString);</span><br />    }</span></pre><p name="d2a9" id="d2a9" class="graf graf--p graf-after--pre">So what does this method in detail ? The first step is to analyze the value of tag <em class="markup--em markup--p-em">0x9f38</em> that holds the PDOL list. It gets the tag and the requested length. The tag is searched in the lookup table in class “DolValues.java” and the class returns a predefined value that may work in most cases. Here is the dumped output of my data, e.g. the “Terminal Country Code” is set to “<em class="markup--em markup--p-em">0978</em>” means “EUR”. Just a note: reading different (Visa-) cards showed that each card may ask for a different set of data, for that reason the list is longer than the list shown from PDOL.</p><pre data-code-block-mode="0" spellcheck="false" name="1662" id="1662" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">List of predefined tag and values for PDOL and CDOL<br>Tag  Name                             Value<br>---------------------------------------------<br>9f66 Terminal Transaction Qualifiers 27000000<br>9f02 Transaction Amount              000000001000<br>9f03 Amount, Other (Numeric)         000000000000<br>9f1a Terminal Country Code           0978<br>95   Terminal Verificat.Results      0000000000<br>5f2a Transaction Currency Code       0978<br>9a   Transaction Date                230301<br>9c   Transaction Type                00<br>9f37 Unpredictable Number            38393031<br>9f35 Terminal Type                   22<br>9f45 Data Authentication Code        0000<br>9f4c ICC Dynamic Number              0000000000000000<br>9f34 Terminal Transaction Qualifiers 000000<br>9f21 Transaction Time (HHMMSS)       111009<br>9f7c Merchant Custom Data            0000000000000000000000000000<br>00   Tag not found                   00</span></pre><p name="8759" id="8759" class="graf graf--p graf-after--pre">The next step is a kind of “sanity method” just for the case that the length of the requested value length differs to the predefined value length. If a tag is requested in the PDOL that is not available in our lookup table it returns a “nulled” value with the requested length.</p><p name="d892" id="d892" class="graf graf--p graf-after--p">Using all data elements a command string is generated and returned in index “0” of the method’s returned byte[] array.</p><p name="4d30" id="4d30" class="graf graf--p graf-after--p">For displaying reasons a table is generated with all requested tags, their length and the data; this information is returned in index “1” of the method’s returned byte[] array.</p><p name="51e9" id="51e9" class="graf graf--p graf-after--p">The app printouts the table and send the command to the card (we discuss this in the next step).</p><p name="35dc" id="35dc" class="graf graf--p graf-after--p">Now we are turning back to the little magic happens when using a <strong class="markup--strong markup--p-strong">MasterCard</strong>. In the last step the response to our “selectAid” command does not contain a tag <em class="markup--em markup--p-em">0x9f38</em> so how to construct the get processing options command ? The magic lies in the “no data” wording and the <em class="markup--em markup--p-em">getGpoFromPdolExtended</em> method gets an input of “<em class="markup--em markup--p-em">new byte[0]</em>“ to generate a command.</p><figure name="e331" id="e331" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*8tmstazeyxFOq6Kfv8ftGA.png" data-width="300" data-height="435" src="https://cdn-images-1.medium.com/max/800/1*8tmstazeyxFOq6Kfv8ftGA.png"></figure><p name="c7ad" id="c7ad" class="graf graf--p graf-after--figure">I know that this article is the most challenging part of our Credit Card journey but now you have all basic skills to proceed further.</p><p name="3822" id="3822" class="graf graf--p graf-after--p">The next <a href="https://medium.com/@androidcrypto/talk-to-your-credit-card-part-5-retrieve-the-application-file-locator-afl-list-8cecb0a2e166" data-href="https://medium.com/@androidcrypto/talk-to-your-credit-card-part-5-retrieve-the-application-file-locator-afl-list-8cecb0a2e166" class="markup--anchor markup--p-anchor" target="_blank">step is <strong class="markup--strong markup--p-strong">05 retrieve the “Application File Locator” (AFL) list</strong></a>.</p><p name="6c58" id="6c58" class="graf graf--p graf-after--p graf--trailing">Find the full code of the app in my GitHub repository <strong class="markup--strong markup--p-strong">TalkToYourCreditCardPart4</strong>:<a href="https://github.com/AndroidCrypto/TalkToYourCreditCardPart4" data-href="https://github.com/AndroidCrypto/TalkToYourCreditCardPart4" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"> TalkToYourCreditCardPart4</a></p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@androidcrypto" class="p-author h-card">AndroidCrypto</a> on <a href="https://medium.com/p/98003ecd98ee"><time class="dt-published" datetime="2023-04-12T09:39:18.217Z">April 12, 2023</time></a>.</p><p><a href="https://medium.com/@androidcrypto/talk-to-your-credit-card-part-4-get-the-processing-options-98003ecd98ee" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on December 24, 2023.</p></footer></article></body></html>