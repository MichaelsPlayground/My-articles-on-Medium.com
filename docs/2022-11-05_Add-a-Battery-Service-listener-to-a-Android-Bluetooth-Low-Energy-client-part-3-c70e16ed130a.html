<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Add a Battery Service listener to a Android Bluetooth Low Energy client part 3</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Add a Battery Service listener to a Android Bluetooth Low Energy client part 3</h1>
</header>
<section data-field="subtitle" class="p-summary">
Our Bluetooth Low Energy client from part 2 has a nice user interface (UI) and in this part I’m showing on how to add a new service to the…
</section>
<section data-field="body" class="e-content">
<section name="411e" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="ed92" id="ed92" class="graf graf--h3 graf--leading graf--title">Add a Battery Service listener to a Android Bluetooth Low Energy client part 3</h3><p name="431d" id="431d" class="graf graf--p graf-after--h3">Our Bluetooth Low Energy client from <a href="https://medium.com/@androidcrypto/enhance-a-android-bluetooth-low-energy-client-part-2-200aab7255de" data-href="https://medium.com/@androidcrypto/enhance-a-android-bluetooth-low-energy-client-part-2-200aab7255de" class="markup--anchor markup--p-anchor" target="_blank">part 2</a> has a nice user interface (UI) and in this part I’m showing on how to add a new service to the client.</p><p name="f8d8" id="f8d8" class="graf graf--p graf-after--p">At the end the UI will look like this screenshot:</p><figure name="d753" id="d753" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*h_DdKaEx7gj4Ew0flI_PaQ.png" data-width="500" data-height="981" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*h_DdKaEx7gj4Ew0flI_PaQ.png"></figure><p name="282e" id="282e" class="graf graf--p graf-after--figure">We are still using the library <strong class="markup--strong markup--p-strong">blessed-android </strong>(<a href="https://github.com/weliem/blessed-android" data-href="https://github.com/weliem/blessed-android" class="markup--anchor markup--p-anchor" rel="noopener ugc nofollow noopener" target="_blank">https://github.com/weliem/blessed-android</a>) from <strong class="markup--strong markup--p-strong">Martijn van Welie</strong> to handle the complete BLE workflow.</p><p name="4429" id="4429" class="graf graf--p graf-after--p">The first step to add a new service to the app is to add a EditText to the main_activity.xml file as seeing above.</p><p name="9d06" id="9d06" class="graf graf--p graf-after--p">The next steps take place in the BluetoothHandler.java class. We do need 2 more constants for the Broadcast Intent:</p><pre name="e697" id="e697" class="graf graf--pre graf-after--p">public static final String <em class="markup--em markup--pre-em">BLUETOOTHHANDLER_BATTERY_LEVEL </em>= &quot;androidcrypto.bluetoothhandler.batterylevel&quot;;<br>public static final String <em class="markup--em markup--pre-em">BLUETOOTHHANDLER_BATTERY_LEVEL_EXTRA </em>= &quot;androidcrypto.bluetoothhandler.batterylevel.extra&quot;;</pre><p name="2e0c" id="2e0c" class="graf graf--p graf-after--pre">In the `BluetoothPeripheralCallback` are all methods for the data transfer between client and server and as we like to receive some data (the battery level) it is a change or update of a characteristic. The entry for the battery level was already there but it just wrote an entry to the log. Now we are grabbing the data, put them in a broadcast intent and sending the intent to a receiver (that is placed in the MainActivity).</p><pre name="96eb" id="96eb" class="graf graf--pre graf-after--p">BluetoothPeripheralCallback:<br>onCharacteristicUpdate:</pre><pre name="37a0" id="37a0" class="graf graf--pre graf-after--pre">} else if (characteristicUUID.equals(<em class="markup--em markup--pre-em">BATTERY_LEVEL_CHARACTERISTIC_UUID</em>)) {<br>    String valueString = parser.getIntValue(<em class="markup--em markup--pre-em">FORMAT_UINT8</em>).toString();<br>    Timber.<em class="markup--em markup--pre-em">i</em>(&quot;Received battery level %s%%&quot;, valueString);<br>    <em class="markup--em markup--pre-em">// new in part 3<br>    </em>Intent intent = new Intent(<em class="markup--em markup--pre-em">BLUETOOTHHANDLER_BATTERY_LEVEL</em>);<br>    intent.putExtra(<em class="markup--em markup--pre-em">BLUETOOTHHANDLER_BATTERY_LEVEL_EXTRA</em>, valueString);<br>    sendMeasurement(intent, peripheral);<br><br>}</pre><p name="378f" id="378f" class="graf graf--p graf-after--pre">Don’t forget to enable the notification for this:</p><pre name="9f2d" id="9f2d" class="graf graf--pre graf-after--p">public void enableAllSubscriptions(String peripheralMacAddress, boolean enable) {<br>    BluetoothPeripheral connectedPeripheral = central.getPeripheral(peripheralMacAddress);<br>    ...<br>    <em class="markup--em markup--pre-em">// new in part 3<br>    </em>connectedPeripheral.setNotify(<em class="markup--em markup--pre-em">BATTERY_LEVEL_SERVICE_UUID</em>, <em class="markup--em markup--pre-em">BATTERY_LEVEL_CHARACTERISTIC_UUID</em>, enable);<br>}</pre><p name="04d2" id="04d2" class="graf graf--p graf-after--pre">On MainActivity-side there is the BroadcastReceiver that catches the incoming data, here we are responsible to en- and disable some buttons and set the data in the EditText-field:</p><pre name="f2cd" id="f2cd" class="graf graf--pre graf-after--p">private final BroadcastReceiver batteryLevelDataReceiver = new BroadcastReceiver() {<br>    @Override<br>    public void onReceive(Context context, Intent intent) {<br>        String dataString = intent.getStringExtra(BluetoothHandler.<em class="markup--em markup--pre-em">BLUETOOTHHANDLER_BATTERY_LEVEL_EXTRA</em>);<br>        if (dataString == null) return;<br>        String resultString = &quot;The remaining battery level is &quot; +<br>                dataString + &quot; %&quot;;<br>        batteryLevel.setText(resultString);<br>    }<br>};</pre><p name="afcb" id="afcb" class="graf graf--p graf-after--pre">Do not forget to register the receiver on app’s creation:</p><pre name="9f35" id="9f35" class="graf graf--pre graf-after--p">registerReceiver(batteryLevelDataReceiver, new IntentFilter(BluetoothHandler.<em class="markup--em markup--pre-em">BLUETOOTHHANDLER_BATTERY_LEVEL</em>));</pre><p name="61e3" id="61e3" class="graf graf--p graf-after--pre">and unregister the receiver on app’s destroy:</p><pre name="2e7d" id="2e7d" class="graf graf--pre graf-after--p">@Override<br>protected void onDestroy() {<br>    super.onDestroy();<br>    <em class="markup--em markup--pre-em">// new in part 3<br>    </em>unregisterReceiver(batteryLevelDataReceiver);<br>    ...</pre><pre name="1cd2" id="1cd2" class="graf graf--pre graf-after--pre">}</pre><p name="ded0" id="ded0" class="graf graf--p graf-after--pre">Now the app is ready to build and start but there is one part missing — <strong class="markup--strong markup--p-strong">how do we know about the right data structure</strong> ? As long as your (new) service is using a registered (“known”) UUID there is a high chance that you will find a documentation about the data structure and format. I will show you the way on how to archive the necessary information.</p><p name="e21f" id="e21f" class="graf graf--p graf-after--p">These are the steps to get your UUIDs and additional information:</p><ol class="postList"><li name="3ae5" id="3ae5" class="graf graf--li graf-after--p">Search the specifications website for Battery Service and download the specification <a href="https://www.bluetooth.com/specifications/specs/" data-href="https://www.bluetooth.com/specifications/specs/" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">here</a></li><li name="b75e" id="b75e" class="graf graf--li graf-after--li">find the Battery Service UUID (“0000180F-0000–1000–8000–00805f9b34fb”) and Battery Level (characteristic) UUID (“00002A19–0000–1000–8000–00805f9b34fb”) in the downloaded PDF document (“Assigned Numbers Document”) <a href="https://www.bluetooth.com/specifications/assigned-numbers/" data-href="https://www.bluetooth.com/specifications/assigned-numbers/" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">here</a></li><li name="f112" id="f112" class="graf graf--li graf-after--li">get the information how the data is formatted. This is a little bit tricky as the data is included in specification.xml files that are no longer available on the official servers to the public (only for members). A nice guy has downloaded and provides them in his <a href="https://github.com/oesmith/gatt-xml/" data-href="https://github.com/oesmith/gatt-xml/" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">GitHub repository</a> and there is a battery_service.xml available <a href="https://github.com/oesmith/gatt-xml/blob/master/org.bluetooth.service.battery_service.xml" data-href="https://github.com/oesmith/gatt-xml/blob/master/org.bluetooth.service.battery_service.xml" class="markup--anchor markup--li-anchor" rel="noopener" target="_blank">here</a>.</li></ol><p name="00e7" id="00e7" class="graf graf--p graf-after--li">One note on short and long UUIDs: sometimes you will find the short version but when running a server or client you will need the long version, e.g. the short version of the Battery Service is “0x180F”.</p><p name="77eb" id="77eb" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">This is the summary of all informations</strong>: the specification told us that the Battery Service provides one mandatory data field called Battery Level that is readable, additionally this field may be used with a notification (optional). We found the UUIDs for the service and characteristic. At least the xml file told us that the battery level is just one byte of information containing the value 0 (battery is empty) up to 100 (battery is full).</p><p name="f813" id="f813" class="graf graf--p graf-after--p">Ok, this is very simple and we just need to receive one byte from the server and treat it as integer value. A more complex example is the data format for a Blood Pressure Measurement (you find it in the BloodPressureMeasurement.java) where there are flag that tell if some data elements are available and that the data fields do have different formats:</p><pre name="45ac" id="45ac" class="graf graf--pre graf-after--p">public BloodPressureMeasurement(byte[] value) {<br>    BluetoothBytesParser parser = new BluetoothBytesParser(value);<br><br>    <em class="markup--em markup--pre-em">// Parse the flags<br>    </em>int flags = parser.getIntValue(<em class="markup--em markup--pre-em">FORMAT_UINT8</em>);<br>    isMMHG = !((flags &amp; 0x01) &gt; 0);<br>    boolean timestampPresent = (flags &amp; 0x02) &gt; 0;<br>    boolean pulseRatePresent = (flags &amp; 0x04) &gt; 0;<br>    boolean userIdPresent = (flags &amp; 0x08) &gt; 0;<br>    boolean measurementStatusPresent = (flags &amp; 0x10) &gt; 0;<br><br>    <em class="markup--em markup--pre-em">// Get systolic, diastolic and mean arterial pressure<br>    </em>systolic = parser.getFloatValue(<em class="markup--em markup--pre-em">FORMAT_SFLOAT</em>);<br>    diastolic = parser.getFloatValue(<em class="markup--em markup--pre-em">FORMAT_SFLOAT</em>);<br>    meanArterialPressure = parser.getFloatValue(<em class="markup--em markup--pre-em">FORMAT_SFLOAT</em>);<br><br>    <em class="markup--em markup--pre-em">// Read timestamp<br>    </em>if (timestampPresent) {<br>        timestamp = parser.getDateTime();<br>    } else {<br>        timestamp = Calendar.<em class="markup--em markup--pre-em">getInstance</em>().getTime();<br>    }<br><br>    <em class="markup--em markup--pre-em">// Read pulse rate<br>    </em>if (pulseRatePresent) {<br>        pulseRate = parser.getFloatValue(<em class="markup--em markup--pre-em">FORMAT_SFLOAT</em>);<br>    }<br><br>    <em class="markup--em markup--pre-em">// Read userId<br>    </em>if (userIdPresent) {<br>        userID = parser.getIntValue(<em class="markup--em markup--pre-em">FORMAT_UINT8</em>);<br>    }<br>}</pre><p name="a04c" id="a04c" class="graf graf--p graf-after--pre"><strong class="markup--strong markup--p-strong">What to do if the UUID is unknown ?</strong> I can only recommend to search in the internet for the UUID and maybe a guy uses the UUID in his own project. Your second choice is to ask the manufacturer for a data sheet, otherwise you need to run a Bluetooth sniffer and analyze the data that is exchanged between client and server (but this is anoying :-( ).</p><p name="a2e0" id="a2e0" class="graf graf--p graf-after--p">The complete <strong class="markup--strong markup--p-strong">source code</strong> for the BleClientBlessedPart3 is available on my GitHub repository: <a href="https://github.com/AndroidCrypto/BleClientBlessedPart3" data-href="https://github.com/AndroidCrypto/BleClientBlessedPart3" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">https://github.com/AndroidCrypto/BleClientBlessedPart3</a>.</p><p name="201d" id="201d" class="graf graf--p graf-after--p graf--trailing">The companion article “<a href="https://medium.com/@androidcrypto/add-a-battery-service-to-your-bluetooth-low-energy-server-part-3-ab42cc96e43b" data-href="https://medium.com/@androidcrypto/add-a-battery-service-to-your-bluetooth-low-energy-server-part-3-ab42cc96e43b" class="markup--anchor markup--p-anchor" target="_blank">Add a Battery Service to your Bluetooth Low Energy server part 3</a>” is published here on medium.com as well.</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@androidcrypto" class="p-author h-card">AndroidCrypto</a> on <a href="https://medium.com/p/c70e16ed130a"><time class="dt-published" datetime="2022-11-05T14:03:12.093Z">November 5, 2022</time></a>.</p><p><a href="https://medium.com/@androidcrypto/add-a-battery-service-listener-to-a-android-bluetooth-low-energy-client-part-3-c70e16ed130a" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on November 27, 2022.</p></footer></article></body></html>