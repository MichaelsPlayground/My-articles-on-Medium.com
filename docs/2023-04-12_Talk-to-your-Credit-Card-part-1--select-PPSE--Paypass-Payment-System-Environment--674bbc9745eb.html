<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Talk to your Credit Card part 1: select PPSE (Paypass Payment System Environment)</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Talk to your Credit Card part 1: select PPSE (Paypass Payment System Environment)</h1>
</header>
<section data-field="subtitle" class="p-summary">
This is the first step of the article series about reading a Credit Card and retrieve the card number and it’s expiration date.
</section>
<section data-field="body" class="e-content">
<section name="6dac" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="5bb1" id="5bb1" class="graf graf--h3 graf--leading graf--title">Talk to your Credit Card part 1: select PPSE (Paypass Payment System Environment)</h3><p name="241d" id="241d" class="graf graf--p graf-after--h3">This is the first step of the article series about reading a Credit Card and retrieve the card number and it’s expiration date.</p><p name="4ad8" id="4ad8" class="graf graf--p graf-after--p">The previous article described the general workflow and basic elements of the app, now we are implementing the first step.</p><p name="0441" id="0441" class="graf graf--p graf-after--p">Note: I tested my app with more than 20 payment cards (American Express, VisaCard debit/credit, MasterCard debit/credit, (German) GiroCards maestro/VPay) and all of them contained the PPSE. <strong class="markup--strong markup--p-strong">Recording to the EMV specifications it is not guaranteed that a card has a PPSE and in that case the terminal should skip the reading of PPSE and proceed to step 3 (select an application).</strong> The terminal shall in that case try a list of “well known application identifiers” to select an application on the card. My app doesn’t support this procedure and will terminate the reading process. This may happen e.g. when reading a card from Union Pay, Diners, JCB or other cards uncommon in Germany, sorry.</p><p name="90f3" id="90f3" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Step 1: ask the card which applications are available on the card (“select PPSE”)</strong></p><p name="6477" id="6477" class="graf graf--p graf-after--p">Each NFC tag that is connected using the IsoDep-class has it’s own “wording” that is documented in a specification. Fortunately the specifications for EMV cards are published and are readable without any access limitations. In the repository for the Basis app you find the most important specifications for download.</p><p name="3175" id="3175" class="graf graf--p graf-after--p">Our journey to read the Credit Card beginns with a simple string:</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="java" name="cc05" id="cc05" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-type">byte</span>[] PPSE = <span class="hljs-string">&quot;2PAY.SYS.DDF01&quot;</span>.getBytes(StandardCharsets.UTF_8);</span></pre><p name="eeda" id="eeda" class="graf graf--p graf-after--pre">This is the <strong class="markup--strong markup--p-strong">entry point</strong> to our Credit Card and just needs to get send to the Credit Card using a <strong class="markup--strong markup--p-strong">transceive</strong>-command. The card will answer this command with a response that gives us important informations about how to go the next steps. Here is the code for that step:</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="java" name="332e" id="332e" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-type">byte</span>[] PPSE = <span class="hljs-string">&quot;2PAY.SYS.DDF01&quot;</span>.getBytes(StandardCharsets.UTF_8); <span class="hljs-comment">// PPSE</span><br /><span class="hljs-type">byte</span>[] selectPpseCommand = selectApdu(PPSE);<br /><span class="hljs-type">byte</span>[] selectPpseResponse = nfc.transceive(selectPpseCommand);</span></pre><p name="e07e" id="e07e" class="graf graf--p graf-after--pre">The “selectApdu” combines the PPSE byte array with a command sequence that includes a length field. The details of the command can be found in the specifications:</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="java" name="c806" id="c806" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[] selectApdu(<span class="hljs-meta">@NonNull</span> <span class="hljs-type">byte</span>[] data) {<br />        <span class="hljs-type">byte</span>[] commandApdu = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">6</span> + data.length];<br />        commandApdu[<span class="hljs-number">0</span>] = (<span class="hljs-type">byte</span>) <span class="hljs-number">0x00</span>;  <span class="hljs-comment">// CLA</span><br />        commandApdu[<span class="hljs-number">1</span>] = (<span class="hljs-type">byte</span>) <span class="hljs-number">0xA4</span>;  <span class="hljs-comment">// INS</span><br />        commandApdu[<span class="hljs-number">2</span>] = (<span class="hljs-type">byte</span>) <span class="hljs-number">0x04</span>;  <span class="hljs-comment">// P1</span><br />        commandApdu[<span class="hljs-number">3</span>] = (<span class="hljs-type">byte</span>) <span class="hljs-number">0x00</span>;  <span class="hljs-comment">// P2</span><br />        commandApdu[<span class="hljs-number">4</span>] = (<span class="hljs-type">byte</span>) (data.length &amp; <span class="hljs-number">0x0FF</span>);       <span class="hljs-comment">// Lc</span><br />        System.arraycopy(data, <span class="hljs-number">0</span>, commandApdu, <span class="hljs-number">5</span>, data.length);<br />        commandApdu[commandApdu.length - <span class="hljs-number">1</span>] = (<span class="hljs-type">byte</span>) <span class="hljs-number">0x00</span>;  <span class="hljs-comment">// Le</span><br />        <span class="hljs-keyword">return</span> commandApdu;<br />    }</span></pre><p name="b65e" id="b65e" class="graf graf--p graf-after--pre">A typical printout of the command and answer could look like this:</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="plaintext" name="8720" id="8720" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">01 select PPSE command  length 20 data: 00a404000e325041592e5359532e444446303100<br />01 select PPSE response length 64 data: 6f3c840e325041592e5359532e4444463031a52abf0c2761254f07a000000004101050104465626974204d6173746572436172648701019f0a04000101019000<br />... deleted some data to see the end:<br />01 select PPSE response length 64 data: 6f3c ... 019000</span></pre><p name="9486" id="9486" class="graf graf--p graf-after--pre">The most important information is at the end of the answer: there is a trailing “<strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">9000</em></strong>” that <strong class="markup--strong markup--p-strong">indicates that the command was accepted</strong> by the card and the data is valid. Follow the link to get the <a href="https://www.eftlab.com/knowledge-base/complete-list-of-apdu-responses" data-href="https://www.eftlab.com/knowledge-base/complete-list-of-apdu-responses" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">complete list of APDU commands</a>.</p><p name="d413" id="d413" class="graf graf--p graf-after--p">For that reason there is a simple “checkResponse” method available that checks for the trailing “<em class="markup--em markup--p-em">9000</em>” and gives us the data back without the trailer. If the response is not successful the method will return a NULL value:</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="java" name="6e33" id="6e33" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">    <span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[] checkResponse(<span class="hljs-meta">@NonNull</span> <span class="hljs-type">byte</span>[] data) {<br />        <span class="hljs-comment">// simple sanity check</span><br />        <span class="hljs-keyword">if</span> (data.length &lt; <span class="hljs-number">5</span>) {<br />            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br />        } <span class="hljs-comment">// not ok</span><br />        <span class="hljs-type">int</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> ((<span class="hljs-number">0xff</span> &amp; data[data.length - <span class="hljs-number">2</span>]) &lt;&lt; <span class="hljs-number">8</span>) | (<span class="hljs-number">0xff</span> &amp; data[data.length - <span class="hljs-number">1</span>]);<br />        <span class="hljs-keyword">if</span> (status != <span class="hljs-number">0x9000</span>) {<br />            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br />        } <span class="hljs-keyword">else</span> {<br />            <span class="hljs-keyword">return</span> Arrays.copyOfRange(data, <span class="hljs-number">0</span>, data.length - <span class="hljs-number">2</span>);<br />        }<br />    }</span></pre><p name="9191" id="9191" class="graf graf--p graf-after--pre">The card answered with “Command successfully executed (OK).” but what can we do with this information ?</p><p name="0abc" id="0abc" class="graf graf--p graf-after--p">For a first analysis we copy and paste the response to the website <a href="https://emvlab.org/tlvutils/" data-href="https://emvlab.org/tlvutils/" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">https://emvlab.org/tlvutils/</a> and get this result (this <a href="https://emvlab.org/tlvutils/?data=6f3c840e325041592e5359532e4444463031a52abf0c2761254f07a000000004101050104465626974204d6173746572436172648701019f0a0400010101" data-href="https://emvlab.org/tlvutils/?data=6f3c840e325041592e5359532e4444463031a52abf0c2761254f07a000000004101050104465626974204d6173746572436172648701019f0a0400010101" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">link</a> gives you the same information without copy &amp; paste):</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="plaintext" name="85fd" id="85fd" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">6F File Control Information (FCI) Template<br />  84 Dedicated File (DF) Name<br />    325041592E5359532E4444463031<br />  A5 File Control Information (FCI) Proprietary Template<br />    BF0C File Control Information (FCI) Issuer Discretionary Data<br />      61 Application Template<br />        4F Application Identifier (AID) – card<br />          A0000000041010<br />        50 Application Label<br />          D e b i t M a s t e r C a r d<br />        87 Application Priority Indicator<br />          01<br />        9F0A Unknown tag<br />          00010101</span></pre><p name="efda" id="efda" class="graf graf--p graf-after--pre">Wow — I didn’t expected that there is so much information in a 64 bytes long card response. To be honest: most of the text information is added by the website for a better human reading. Where does the website get the additional information from ? The answer is simple: from the specifications as well, but to retrieve the information in that form we need to dig deeper in the details.</p><p name="1ef5" id="1ef5" class="graf graf--p graf-after--p">The most important information is: Most response data is encoded in <strong class="markup--strong markup--p-strong">BER-TLV</strong> sequences. This is the short version of “<strong class="markup--strong markup--p-strong">Basic Encoding Rules — Text Length Values</strong>”; for an explanation I’m starting at the end:</p><p name="7fb3" id="7fb3" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">TLV</strong> decribes that the data is encapsulated in the form:</p><ol class="postList"><li name="1cb6" id="1cb6" class="graf graf--li graf-after--p"><strong class="markup--strong markup--li-strong">Tag</strong> that is the “identifier” for the data</li><li name="f629" id="f629" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Length</strong>: how many bytes will follow</li><li name="86e6" id="86e6" class="graf graf--li graf-after--li"><strong class="markup--strong markup--li-strong">Value</strong>: the data that are available for this tag</li></ol><p name="5a0c" id="5a0c" class="graf graf--p graf-after--li">Let’s start a short manual reading of our response data — but not starting at the beginning:</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="plaintext" name="7fc0" id="7fc0" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">..254f07a000000004101050104465626974204d6173746572436172648701<br />    4f is the tag<br />      07 is the length (hex 0x07 = decimal 07)<br />        a0000000041010 is the data following<br />                      50 is the tag<br />                        10 is the length (hex 0x10 = decimal 16)<br />                          4465626974204d617374657243617264 ... data</span></pre><p name="4cd0" id="4cd0" class="graf graf--p graf-after--pre">This sounds simple but that won’t work for the beginning of our data and reason for that is that the first tag “<em class="markup--em markup--p-em">60</em>” is a “constructed” tag, means it has not only data but a child or child tree following. The second issue arises when having a look at the tag “<em class="markup--em markup--p-em">BF0C</em>”:</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="plaintext" name="4e56" id="4e56" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">BF0C File Control Information (FCI) Issuer Discretionary Data</span></pre><p name="73bb" id="73bb" class="graf graf--p graf-after--pre">This is a 2 bytes long tag and the byte after this tag gives the length. The reason for both hick-ups is simple: our answer is not only of a TLV- but of a BER-TLV structure and we do need a lot of coding to get the data for the following steps by our own. The second thing is: we also need to have a table available with all names of the tags — uh, a lot of work.</p><p name="fddd" id="fddd" class="graf graf--p graf-after--p">For that reason I’m including two 3rd. party libraries into my app that all do the heavy jobs for us:</p><p name="e459" id="e459" class="graf graf--p graf-after--p">a) for easy parsing BER-TLV encoded data I’m using a BER-TLV encoder available here: <a href="https://github.com/evsinev/ber-tlv" data-href="https://github.com/evsinev/ber-tlv" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">https://github.com/evsinev/ber-tlv</a></p><p name="3ddf" id="3ddf" class="graf graf--p graf-after--p">b) for nice printouts and other BER-TLV related tasks I’m using the library “EMV-NFC-Paycard-Enrollment” available here: <a href="https://github.com/devnied/EMV-NFC-Paycard-Enrollment" data-href="https://github.com/devnied/EMV-NFC-Paycard-Enrollment" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">https://github.com/devnied/EMV-NFC-Paycard-Enrollment</a>. Please note that this library provides a full working EMV card reader but as all reading tasks are “under the hood” I do the tasks on my own to show every step in detail.</p><p name="d08b" id="d08b" class="graf graf--p graf-after--p">With the help it is very easy for us (a “one line of code”) to get a nice output of our data elements:</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="plaintext" name="7412" id="7412" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">writeToUiAppend(prettyPrintDataToString(selectPpseResponse));<br />------------------------------------<br />6F 3C -- File Control Information (FCI) Template<br />      84 0E -- Dedicated File (DF) Name<br />            32 50 41 59 2E 53 59 53 2E 44 44 46 30 31 (BINARY)<br />      A5 2A -- File Control Information (FCI) Proprietary Template<br />            BF 0C 27 -- File Control Information (FCI) Issuer Discretionary Data<br />                     61 25 -- Application Template<br />                           4F 07 -- Application Identifier (AID) - card<br />                                 A0 00 00 00 04 10 10 (BINARY)<br />                           50 10 -- Application Label<br />                                 44 65 62 69 74 20 4D 61 73 74 65 72 43 61 72 64 (=Debit MasterCard)<br />                           87 01 -- Application Priority Indicator<br />                                 01 (BINARY)<br />                           9F 0A 04 -- [UNKNOWN TAG]<br />                                    00 01 01 01 (BINARY)<br />90 00 -- Command successfully executed (OK)<br />------------------------------------</span></pre><p name="162e" id="162e" class="graf graf--p graf-after--pre">Btw: at this point we got the information that the card is a “Mastercard debit” card but: there are a lot of “optional” elements and this information is available on on some cards I read, so don’t rely that all of the data is available on every card!</p><p name="55aa" id="55aa" class="graf graf--p graf-after--p">I added this code in the MainActivity.java class:</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="java" name="10e0" id="10e0" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onTagDiscovered</span><span class="hljs-params">(Tag tag)</span> {<br />...<br />printStepHeader(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;select PPSE&quot;</span>);<br /><span class="hljs-type">byte</span>[] PPSE = <span class="hljs-string">&quot;2PAY.SYS.DDF01&quot;</span>.getBytes(StandardCharsets.UTF_8); <span class="hljs-comment">// PPSE</span><br /><span class="hljs-type">byte</span>[] selectPpseCommand = selectApdu(PPSE);<br /><span class="hljs-type">byte</span>[] selectPpseResponse = nfc.transceive(selectPpseCommand);<br />writeToUiAppend(<span class="hljs-string">&quot;01 select PPSE command  length &quot;</span> + selectPpseCommand.length + <span class="hljs-string">&quot; data: &quot;</span> + bytesToHexNpe(selectPpseCommand));<br />writeToUiAppend(<span class="hljs-string">&quot;01 select PPSE response length &quot;</span> + selectPpseResponse.length + <span class="hljs-string">&quot; data: &quot;</span> + bytesToHexNpe(selectPpseResponse));<br />writeToUiAppend(etData, <span class="hljs-string">&quot;01 select PPSE completed&quot;</span>);<br />writeToUiAppend(prettyPrintDataToString(selectPpseResponse));<br /><br /><span class="hljs-type">byte</span>[] selectPpseResponseOk = checkResponse(selectPpseResponse);<br /><span class="hljs-comment">// proceed only when te do have a positive read result = 0x&#x27;9000&#x27; at the end of response data</span><br /><span class="hljs-keyword">if</span> (selectPpseResponseOk != <span class="hljs-literal">null</span>) {<br /><br />} <span class="hljs-keyword">else</span> {<br /><span class="hljs-comment">// if (isoDepInTechList) {</span><br />    writeToUiAppend(<span class="hljs-string">&quot;The discovered NFC tag does not have an IsoDep interface.&quot;</span>);<br />}<br />...<br /><br />and later:<br /><span class="hljs-comment">/**<br /> * build a select apdu command<br /> *<br /> * <span class="hljs-doctag">@param</span> data<br /> * <span class="hljs-doctag">@return</span><br /> */</span><br /><span class="hljs-keyword">private</span> <span class="hljs-type">byte</span>[] selectApdu(<span class="hljs-meta">@NonNull</span> <span class="hljs-type">byte</span>[] data) {<br />  <span class="hljs-type">byte</span>[] commandApdu = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">6</span> + data.length];<br />  commandApdu[<span class="hljs-number">0</span>] = (<span class="hljs-type">byte</span>) <span class="hljs-number">0x00</span>;  <span class="hljs-comment">// CLA</span><br />  commandApdu[<span class="hljs-number">1</span>] = (<span class="hljs-type">byte</span>) <span class="hljs-number">0xA4</span>;  <span class="hljs-comment">// INS</span><br />  commandApdu[<span class="hljs-number">2</span>] = (<span class="hljs-type">byte</span>) <span class="hljs-number">0x04</span>;  <span class="hljs-comment">// P1</span><br />  commandApdu[<span class="hljs-number">3</span>] = (<span class="hljs-type">byte</span>) <span class="hljs-number">0x00</span>;  <span class="hljs-comment">// P2</span><br />  commandApdu[<span class="hljs-number">4</span>] = (<span class="hljs-type">byte</span>) (data.length &amp; <span class="hljs-number">0x0FF</span>);   <span class="hljs-comment">// Lc</span><br />  System.arraycopy(data, <span class="hljs-number">0</span>, commandApdu, <span class="hljs-number">5</span>, data.length);<br />  commandApdu[commandApdu.length - <span class="hljs-number">1</span>] = (<span class="hljs-type">byte</span>) <span class="hljs-number">0x00</span>;  <span class="hljs-comment">// Le</span><br />  <span class="hljs-keyword">return</span> commandApdu;<br />}</span></pre><p name="aff6" id="aff6" class="graf graf--p graf-after--pre">Find the full code of the app in my GitHub repository <strong class="markup--strong markup--p-strong">TalkToYourCreditCardPart1</strong>:<a href="https://github.com/AndroidCrypto/TalkToYourCreditCardPart1" data-href="https://github.com/AndroidCrypto/TalkToYourCreditCardPart1" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"> TalkToYourCreditCardPart1</a></p><p name="b197" id="b197" class="graf graf--p graf-after--p graf--trailing">Next <a href="https://medium.com/@androidcrypto/talk-to-your-credit-card-part-2-identify-applications-on-the-card-e6a57b310815" data-href="https://medium.com/@androidcrypto/talk-to-your-credit-card-part-2-identify-applications-on-the-card-e6a57b310815" class="markup--anchor markup--p-anchor" target="_blank"><strong class="markup--strong markup--p-strong">step 2 is: analyze the card’s response and identify one or more of the application number or application id (“AID”)</strong></a>:</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@androidcrypto" class="p-author h-card">AndroidCrypto</a> on <a href="https://medium.com/p/674bbc9745eb"><time class="dt-published" datetime="2023-04-12T09:34:47.616Z">April 12, 2023</time></a>.</p><p><a href="https://medium.com/@androidcrypto/talk-to-your-credit-card-part-1-select-ppse-paypass-payment-system-environment-674bbc9745eb" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on April 12, 2023.</p></footer></article></body></html>