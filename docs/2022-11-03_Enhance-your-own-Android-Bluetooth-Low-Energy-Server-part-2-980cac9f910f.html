<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Enhance your own Android Bluetooth Low Energy Server part 2</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Enhance your own Android Bluetooth Low Energy Server part 2</h1>
</header>
<section data-field="subtitle" class="p-summary">
In part 1 of my article series we setup a full running Bluetooth Low Energy (BLE) server, why do we need modifications on this? The answer…
</section>
<section data-field="body" class="e-content">
<section name="c6ce" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="9514" id="9514" class="graf graf--h3 graf--leading graf--title"><a href="/@androidcrypto/setup-your-own-android-bluetooth-low-energy-server-part-1-dbf8dadd75b5?source=your_stories_page-------------------------------------" data-href="/@androidcrypto/setup-your-own-android-bluetooth-low-energy-server-part-1-dbf8dadd75b5?source=your_stories_page-------------------------------------" class="markup--anchor markup--h3-anchor" rel="noopener follow" target="_blank">Enhance your own Android Bluetooth Low Energy Server part </a>2</h3><p name="57cf" id="57cf" class="graf graf--p graf-after--h3">In <a href="https://medium.com/@androidcrypto/setup-your-own-android-bluetooth-low-energy-server-part-1-dbf8dadd75b5" data-href="https://medium.com/@androidcrypto/setup-your-own-android-bluetooth-low-energy-server-part-1-dbf8dadd75b5" class="markup--anchor markup--p-anchor" target="_blank">part 1 of my article series</a> we setup a full running <strong class="markup--strong markup--p-strong">Bluetooth Low Energy (BLE) server</strong>, why do we need modifications on this? The answer is simple — get a better convenience when developing a client app. This is the screen as it will look like when we are ready:</p><figure name="ce2c" id="ce2c" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*fZSG0-vGz-WdKaa5sHVqxA.png" data-width="500" data-height="820" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*fZSG0-vGz-WdKaa5sHVqxA.png"></figure><p name="f1f1" id="f1f1" class="graf graf--p graf-after--figure">The app is exposing the status of your app — is Bluetooth enabled on your device, does the server advertise (and is scannable by client apps), is the device connected to a client and is a subscription enabled by a client ? At least there is a minimal logfile that gives a short information on what was going up. You can find the complete source code of the app in my GitHub repository, the link is at the end of the article.</p><p name="8ddb" id="8ddb" class="graf graf--p graf-after--p">This app is using the library <strong class="markup--strong markup--p-strong">blessed-android </strong>(https://github.com/weliem/blessed-android) from <strong class="markup--strong markup--p-strong">Martijn van Welie</strong> that has an actual and running example for a BLE server and client. This article series is based on this library that’s main purpose is to develop a BLE client.</p><p name="96ac" id="96ac" class="graf graf--p graf-after--p">When following <a href="https://medium.com/@androidcrypto/setup-your-own-android-bluetooth-low-energy-server-part-1-dbf8dadd75b5" data-href="https://medium.com/@androidcrypto/setup-your-own-android-bluetooth-low-energy-server-part-1-dbf8dadd75b5" class="markup--anchor markup--p-anchor" target="_blank">part 1</a> you have noticed there there is a strict separation of the user interface (UI) and the Bluetooth workload. The UI takes place in the MainActivity and all Bluetooth staff is located in the BluetoothServer-class and its supplementary service classes. When developing your own app please follow this advise — it is not only good programming praxis but as activities sometimes get closed or “refreshed” by Android you will face some trouble when the Bluetooth part is in the UI activity.</p><p name="bab0" id="bab0" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">This article describes how to transfer the data fbetween the Bluetooth-classes and the MainActivity-class.</strong></p><p name="3225" id="3225" class="graf graf--p graf-after--p">Lets start with the UI itself, change the activity_main.xml that there are 4 (Material) switches and a Textview or EditText element. Next instantiate the new elements in the MainActivity so that they are accessible within the class (kindly see an implementation in the repository).</p><p name="c769" id="c769" class="graf graf--p graf-after--p">The first check the app is doing is the “Bluetooth enabled” and this happens in the MainActivity:</p><pre name="0289" id="0289" class="graf graf--pre graf-after--p">@Override<br>protected void onResume() {<br>    super.onResume();<br><br>    if (!isBluetoothEnabled()) {<br>        bluetoothEnabled.setChecked(false); <em class="markup--em markup--pre-em">// added in part 2<br>        </em>Intent enableBtIntent = new Intent(BluetoothAdapter.<em class="markup--em markup--pre-em">ACTION_REQUEST_ENABLE</em>);<br>        startActivityForResult(enableBtIntent, <em class="markup--em markup--pre-em">REQUEST_ENABLE_BT</em>);<br>    } else {<br>        bluetoothEnabled.setChecked(true); <em class="markup--em markup--pre-em">// added in part 2<br>        </em>checkPermissions();<br>    }<br>}</pre><p name="209c" id="209c" class="graf graf--p graf-after--pre">The other parts are realized with a <strong class="markup--strong markup--p-strong">Broadcast Intent</strong> that sends from the BluetoothServer to the system and needs a registered receiver to deliver the message.</p><p name="04c8" id="04c8" class="graf graf--p graf-after--p">All of the following changes are done in BluetoothServer.java. For the intent we need a context and we get and store it on instantiating of the class:</p><pre name="8b81" id="8b81" class="graf graf--pre graf-after--p">private static Context <em class="markup--em markup--pre-em">mContext</em>; <em class="markup--em markup--pre-em">// new in part 2</em></pre><pre name="699b" id="699b" class="graf graf--pre graf-after--pre">public static synchronized BluetoothServer getInstance(Context context) {<br>    <em class="markup--em markup--pre-em">mContext </em>= context; <em class="markup--em markup--pre-em">// new in part 2<br>    </em>if (<em class="markup--em markup--pre-em">instance </em>== null) {<br>        <em class="markup--em markup--pre-em">instance </em>= new BluetoothServer(context.getApplicationContext());<br>    }<br>    return <em class="markup--em markup--pre-em">instance</em>;<br>}</pre><p name="f759" id="f759" class="graf graf--p graf-after--pre">The second requirement is to define some constants:</p><pre name="147e" id="147e" class="graf graf--pre graf-after--p">public static final String <em class="markup--em markup--pre-em">BLUETOOTH_SERVER_ADVERTISER </em>= &quot;androidcrypto.bluetoothserver.advertiser&quot;;<br>public static final String <em class="markup--em markup--pre-em">BLUETOOTH_SERVER_ADVERTISER_EXTRA </em>= &quot;androidcrypto.bluetoothserver.advertiser.extra&quot;;<br>public static final String <em class="markup--em markup--pre-em">BLUETOOTH_SERVER_CONNECTION </em>= &quot;androidcrypto.bluetoothserver.connection&quot;;<br>public static final String <em class="markup--em markup--pre-em">BLUETOOTH_SERVER_CONNECTION_EXTRA </em>= &quot;androidcrypto.bluetoothserver.connection.extra&quot;;<br>public static final String <em class="markup--em markup--pre-em">BLUETOOTH_SERVER_SUBSCRIPTION </em>= &quot;androidcrypto.bluetoothserver.subscription&quot;;<br>public static final String <em class="markup--em markup--pre-em">BLUETOOTH_SERVER_SUBSCRIPTION_EXTRA </em>= &quot;androidcrypto.bluetoothserver.subscription.extra&quot;;</pre><p name="7868" id="7868" class="graf graf--p graf-after--pre">For the broadcast we have a simple utility method:</p><pre name="e229" id="e229" class="graf graf--pre graf-after--p">private void sendToMain(@NotNull Intent intent) {<br>    <em class="markup--em markup--pre-em">mContext</em>.sendBroadcast(intent);<br>}</pre><p name="dc31" id="dc31" class="graf graf--p graf-after--pre">Now lets get the data from the server. The easiest way to get the <strong class="markup--strong markup--p-strong">advertising status</strong> is the <strong class="markup--strong markup--p-strong">BluetoothPeripheralManagerCallback</strong>, there are three service methods that are called when the advertising was started, stopped or there was a failure on advertising. In all cases we create a new intent with the advertiser constant, fill it in putExtra with a string (“on” or “off”) and deliver it throw the utility method — that’s all.</p><pre name="53cd" id="53cd" class="graf graf--pre graf-after--p">BluetoothPeripheralManagerCallback</pre><pre name="1a70" id="1a70" class="graf graf--pre graf-after--pre">@Override<br>    public void onAdvertisingStarted(@NotNull AdvertiseSettings settingsInEffect) {<br>        System.<em class="markup--em markup--pre-em">out</em>.println(&quot;*** onAdvertisingStarted ***&quot;);<br>        <em class="markup--em markup--pre-em">// new in part 2<br>        </em>Intent intent = new Intent(<em class="markup--em markup--pre-em">BLUETOOTH_SERVER_ADVERTISER</em>);<br>        intent.putExtra(<em class="markup--em markup--pre-em">BLUETOOTH_SERVER_ADVERTISER_EXTRA</em>, &quot;ON&quot;);<br>        sendToMain(intent);<br>    }<br><br>    @Override<br>    public void onAdvertiseFailure(@NotNull AdvertiseError advertiseError) {<br>        <em class="markup--em markup--pre-em">// new in part 2<br>        </em>Intent intent = new Intent(<em class="markup--em markup--pre-em">BLUETOOTH_SERVER_ADVERTISER</em>);<br>        intent.putExtra(<em class="markup--em markup--pre-em">BLUETOOTH_SERVER_ADVERTISER_EXTRA</em>, &quot;OFF&quot;);<br>        sendToMain(intent);<br>    }<br><br>    @Override<br>    public void onAdvertisingStopped() {<br>        <em class="markup--em markup--pre-em">// new in part 2<br>        </em>Intent intent = new Intent(<em class="markup--em markup--pre-em">BLUETOOTH_SERVER_ADVERTISER</em>);<br>        intent.putExtra(<em class="markup--em markup--pre-em">BLUETOOTH_SERVER_ADVERTISER_EXTRA</em>, &quot;OFF&quot;);<br>        sendToMain(intent);<br>    }<br>};</pre><p name="d10e" id="d10e" class="graf graf--p graf-after--pre">The same happens with the “<strong class="markup--strong markup--p-strong">connection status</strong>” information — here we send the additional information to what (client) MAC-address the server is connected with:</p><pre name="c142" id="c142" class="graf graf--pre graf-after--p">@Override<br>public void onCentralConnected(@NotNull BluetoothCentral central) {<br>    for (Service serviceImplementation : serviceImplementations.values()) {<br>        serviceImplementation.onCentralConnected(central);<br>    }<br>    <em class="markup--em markup--pre-em">// new in part 2<br>    </em>Intent intent = new Intent(<em class="markup--em markup--pre-em">BLUETOOTH_SERVER_CONNECTION</em>);<br>    intent.putExtra(<em class="markup--em markup--pre-em">BLUETOOTH_SERVER_CONNECTION_EXTRA</em>, &quot;connected to MAC: &quot; + central.getAddress());<br>    sendToMain(intent);<br>}<br><br>@Override<br>public void onCentralDisconnected(@NotNull BluetoothCentral central) {<br>    for (Service serviceImplementation : serviceImplementations.values()) {<br>        serviceImplementation.onCentralDisconnected(central);<br>    }<br>    <em class="markup--em markup--pre-em">// new in part 2<br>    </em>Intent intent = new Intent(<em class="markup--em markup--pre-em">BLUETOOTH_SERVER_CONNECTION</em>);<br>    intent.putExtra(<em class="markup--em markup--pre-em">BLUETOOTH_SERVER_CONNECTION_EXTRA</em>, &quot;DISCONNECTED from MAC: &quot; + central.getAddress());<br>    sendToMain(intent);<br>}</pre><p name="a745" id="a745" class="graf graf--p graf-after--pre">Last but not least we are going to get the “<strong class="markup--strong markup--p-strong">notifications enabled</strong>” data. Please note — for the sake of simplification the server does not check if all notifications got en- or disabled (e.g. if you enabled 2 notifications and disabled just one the status will show “disabled”:</p><pre name="eaf5" id="eaf5" class="graf graf--pre graf-after--p">@Override<br>public void onNotifyingEnabled(@NotNull BluetoothCentral central, @NotNull BluetoothGattCharacteristic characteristic) {<br>    Service serviceImplementation = serviceImplementations.get(characteristic.getService());<br>    if (serviceImplementation != null) {<br>        serviceImplementation.onNotifyingEnabled(central, characteristic);<br>        <em class="markup--em markup--pre-em">// new in part 2<br>        </em>Intent intent = new Intent(<em class="markup--em markup--pre-em">BLUETOOTH_SERVER_SUBSCRIPTION</em>);<br>        intent.putExtra(<em class="markup--em markup--pre-em">BLUETOOTH_SERVER_SUBSCRIPTION_EXTRA</em>, &quot;subscription enabled for characteristic: &quot; + characteristic.getUuid().toString());<br>        sendToMain(intent);<br>    }<br>}<br><br>@Override<br>public void onNotifyingDisabled(@NotNull BluetoothCentral central, @NotNull BluetoothGattCharacteristic characteristic) {<br>    Service serviceImplementation = serviceImplementations.get(characteristic.getService());<br>    if (serviceImplementation != null) {<br>        serviceImplementation.onNotifyingDisabled(central, characteristic);<br>        <em class="markup--em markup--pre-em">// new in part 2<br>        </em>Intent intent = new Intent(<em class="markup--em markup--pre-em">BLUETOOTH_SERVER_SUBSCRIPTION</em>);<br>        intent.putExtra(<em class="markup--em markup--pre-em">BLUETOOTH_SERVER_SUBSCRIPTION_EXTRA</em>, &quot;subscription disabled for characteristic: &quot; + characteristic.getUuid().toString());<br>        sendToMain(intent);<br>    }<br>}</pre><p name="f837" id="f837" class="graf graf--p graf-after--pre">Now we are changing to the recipient of the intent and the next changes took place in the MainActivity.java.</p><p name="8e74" id="8e74" class="graf graf--p graf-after--p">We do need a <strong class="markup--strong markup--p-strong">Broadcast receiver</strong> that handles all incoming intents. Here I’m showing receiver only for the DeviceConnected information. It checks for the matching constant (important: check for the extra-constant) and if the string contains a “connected” the switch is enabled. Additionally the logfile is prepended by the new information (e.g. “connected to MAC: 12:34:56:78:90:23”):</p><pre name="9251" id="9251" class="graf graf--pre graf-after--p">private final BroadcastReceiver connectionStateReceiver = new BroadcastReceiver() {<br>    @Override<br>    public void onReceive(Context context, Intent intent) {<br>        String dataStatus = intent.getStringExtra(BluetoothServer.<em class="markup--em markup--pre-em">BLUETOOTH_SERVER_CONNECTION_EXTRA</em>);<br>        if (dataStatus == null) return;<br>        if (dataStatus.contains(&quot;connected&quot;)) {<br>            deviceConnected.setChecked(true);<br>        } else {<br>            deviceConnected.setChecked(false);<br>        }<br>        String newConnectionLog = dataStatus + &quot;\n&quot; + connectionLog.getText().toString();<br>        connectionLog.setText(newConnectionLog);<br>    }<br>};</pre><p name="3315" id="3315" class="graf graf--p graf-after--pre">Please do not forget to register the receiver on startup</p><pre name="9943" id="9943" class="graf graf--pre graf-after--p">registerReceiver(connectionStateReceiver, new IntentFilter((BluetoothServer.<em class="markup--em markup--pre-em">BLUETOOTH_SERVER_CONNECTION</em>)));</pre><p name="4c08" id="4c08" class="graf graf--p graf-after--pre">and unregister on destroy:</p><pre name="7ec0" id="7ec0" class="graf graf--pre graf-after--p">@Override<br>protected void onDestroy() {<br>    super.onDestroy();<br>    unregisterReceiver(advertiserStateReceiver);<br>    unregisterReceiver(connectionStateReceiver);<br>    unregisterReceiver(subscriptionStateReceiver);<br>}</pre><p name="2360" id="2360" class="graf graf--p graf-after--pre">Now we are ready to build and run the app. You can check the behaviour of the app by conneting a client like the <a href="https://medium.com/@androidcrypto/setup-a-android-bluetooth-low-energy-client-part-1-70f0eea9149b" data-href="https://medium.com/@androidcrypto/setup-a-android-bluetooth-low-energy-client-part-1-70f0eea9149b" class="markup--anchor markup--p-anchor" target="_blank">BleClientBlessedPart1</a> with the server or use the “nRF connect for mobile” app, I wrote a <a href="https://medium.com/@androidcrypto/connect-the-android-nrf-connect-mobile-app-with-a-bluetooth-low-energy-device-8ba900d70286" data-href="https://medium.com/@androidcrypto/connect-the-android-nrf-connect-mobile-app-with-a-bluetooth-low-energy-device-8ba900d70286" class="markup--anchor markup--p-anchor" target="_blank">short manual</a> to run the app here on Medium.com.</p><p name="957d" id="957d" class="graf graf--p graf-after--p">The complete <strong class="markup--strong markup--p-strong">source code</strong> for the BleServerBlessedPart2 is available on my GitHub repository: <a href="https://github.com/AndroidCrypto/BleServerBlessedPart2" data-href="https://github.com/AndroidCrypto/BleServerBlessedPart2" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">https://github.com/AndroidCrypto/BleServerBlessedPart2</a>.</p><p name="bc4f" id="bc4f" class="graf graf--p graf-after--p">The companion article “<a href="https://medium.com/@androidcrypto/enhance-a-android-bluetooth-low-energy-client-part-2-200aab7255de" data-href="https://medium.com/@androidcrypto/enhance-a-android-bluetooth-low-energy-client-part-2-200aab7255de" class="markup--anchor markup--p-anchor" target="_blank">Enhance a Android Bluetooth Low Energy client part 2</a>” is published here on medium.com as well.</p><p name="0e2b" id="0e2b" class="graf graf--p graf-after--p graf--trailing">There is the part 3 article available here on medium: “<a href="https://medium.com/@androidcrypto/add-a-battery-service-to-your-bluetooth-low-energy-server-part-3-ab42cc96e43b" data-href="https://medium.com/@androidcrypto/add-a-battery-service-to-your-bluetooth-low-energy-server-part-3-ab42cc96e43b" class="markup--anchor markup--p-anchor" target="_blank">Add a Battery Service to your Bluetooth Low Energy server part 3</a>”</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@androidcrypto" class="p-author h-card">AndroidCrypto</a> on <a href="https://medium.com/p/980cac9f910f"><time class="dt-published" datetime="2022-11-03T22:21:48.770Z">November 3, 2022</time></a>.</p><p><a href="https://medium.com/@androidcrypto/enhance-your-own-android-bluetooth-low-energy-server-part-2-980cac9f910f" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on November 27, 2022.</p></footer></article></body></html>