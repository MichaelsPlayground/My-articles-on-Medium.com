<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Talk to your Credit Card part 5: retrieve the “Application File Locator” (AFL) list</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Talk to your Credit Card part 5: retrieve the “Application File Locator” (AFL) list</h1>
</header>
<section data-field="subtitle" class="p-summary">
At the end of step 4 we knew what data the card requests from the terminal to proceed; this information is the PDOL and we got a command to…
</section>
<section data-field="body" class="e-content">
<section name="a553" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="ebdb" id="ebdb" class="graf graf--h3 graf--leading graf--title">Talk to your Credit Card part 5: retrieve the “Application File Locator” (AFL) list</h3><p name="ee42" id="ee42" class="graf graf--p graf-after--h3">At the end of step 4 we knew what data the card requests from the terminal to proceed; this information is the <strong class="markup--strong markup--p-strong">PDOL</strong> and we got a command to send (back) to the card (the “<strong class="markup--strong markup--p-strong">get processing options”</strong> command).</p><p name="3956" id="3956" class="graf graf--p graf-after--p">In this step we analyze the response to the command and try to get the <strong class="markup--strong markup--p-strong">Application File Locator (AFL)</strong>.</p><figure name="3351" id="3351" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*g1f2_JERyuEXyeCtlRWcUQ.png" data-width="300" data-height="437" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*g1f2_JERyuEXyeCtlRWcUQ.png"></figure><p name="0daa" id="0daa" class="graf graf--p graf-after--figure">For the next step I’m using the command string for the <strong class="markup--strong markup--p-strong">VisaCard</strong>, but before proceeding there is a warning:</p><h3 name="8a01" id="8a01" class="graf graf--h3 graf-after--p">Serious security warning: This step may reveal confidential data like the credit card number ! The card number shown in my example is from a card cancelled long time ago and is no longer valid.</h3><pre data-code-block-mode="0" spellcheck="false" name="5704" id="5704" class="graf graf--pre graf-after--h3 graf--preV2"><span class="pre--content">05 get the processing options  command length: 26 data: 80a8000014831227000000000000001000383930310978097800<br>05 get the processing options response length: 203 data: 7781c68202200094041001030057134263540122270050d25062011381541400000f9f1007060d1103a020009f2608e6c80b815788c4c99f2701809f360200349f4b818055c341a8dac5f1aa10f45e8c8182de1ae20ffd139871d4e83d8e15a8b7eaedc994ca9a03d803640c40e1dc0a9cfe4631b1b1a614a3506e7218485cedbc1f0b15a645313a23251f284db9fde1aa78e3cc324736c885e53054a78caeab3b33b59bb0fd4199d3b553de3a6452e60155339c68a3cc0d37f3302ab1344fb94218f4069f6c0238009000<br>------------------------------------<br>77 81 C6 -- Response Message Template Format 2<br>         82 02 -- Application Interchange Profile<br>               20 00 (BINARY)<br>         94 04 -- Application File Locator (AFL)<br>               10 01 03 00 (BINARY)<br>         57 13 -- Track 2 Equivalent Data<br>               42 63 54 01 22 27 00 50 D2 50 62 01 13 81 54 14<br>               00 00 0F (BINARY)<br>         9F 10 07 -- Issuer Application Data<br>                  06 0D 11 03 A0 20 00 (BINARY)<br>         9F 26 08 -- Application Cryptogram<br>                  2F 94 A2 91 FB 5F A4 25 (BINARY)<br>         9F 27 01 -- Cryptogram Information Data<br>                  80 (BINARY)<br>         9F 36 02 -- Application Transaction Counter (ATC)<br>                  00 2E (BINARY)<br>         9F 4B 81 80 -- Signed Dynamic Application Data<br>                     6B 55 30 E9 ED BB F0 BD 83 0F 3C 02 1C 0E 13 3C<br>                     7D 96 F7 9C AB 91 27 A1 64 B4 A1 FF 4A 62 5E C2<br>                     6A 94 BC AE AA 6D 84 D1 92 24 1C C0 CB 96 86 27<br>                     6A C0 E0 59 B8 1A CE 32 3C CD B6 0E 1C 44 3A A7<br>                     1D 1E A4 45 D1 46 6B E9 38 46 CF 29 3B E5 AA 12<br>                     EB CA B6 83 FE AD C5 7F 2E D8 10 17 D2 F0 6F 71<br>                     E2 F1 D7 36 C3 60 84 B2 9C FA 9C 77 FD D1 8B 29<br>                     E7 53 07 58 2D 38 39 CE 73 1D 56 FA 31 45 8B E3 (BINARY)<br>         9F 6C 02 -- Mag Stripe Application Version Number (Card)<br>                  38 00 (BINARY)<br>90 00 -- Command successfully executed (OK)<br>------------------------------------</span></pre><p name="0b03" id="0b03" class="graf graf--p graf-after--pre">Wow, that is a lot of information given by the card and I want to pick out 4 data elements:</p><ul class="postList"><li name="9edb" id="9edb" class="graf graf--li graf-after--p">tag <em class="markup--em markup--li-em">0x77</em> <strong class="markup--strong markup--li-strong">Response Message Template Format 2</strong>: The card’s response can be in 2 different template, my Visa- and MasterCards responded using this template.</li><li name="e4dc" id="e4dc" class="graf graf--li graf-after--li">tag <em class="markup--em markup--li-em">0x94</em> <strong class="markup--strong markup--li-strong">Application File Locator (AFL)</strong>: we discuss the content of this tag in the next step, so please be paitend.</li><li name="3925" id="3925" class="graf graf--li graf-after--li">tag <em class="markup--em markup--li-em">0x57</em> <strong class="markup--strong markup--li-strong">Track 2 Equivalent Data</strong>: the data is a leftover from “old” magnet stripped cards but is still in use on modern EMV cards. <strong class="markup--strong markup--li-strong">This tag contains the credit card number and expiration date in cleartext !</strong> This tag is not returned by every (Visa-) card.</li><li name="5991" id="5991" class="graf graf--li graf-after--li">tag <em class="markup--em markup--li-em">0x9f36</em> <strong class="markup--strong markup--li-strong">Application Transaction Counter (ATC)</strong>: this is the card internal counter that increases each time we run the “get processing options” command. As it is a 2 bytes long field the <strong class="markup--strong markup--li-strong">maximum value is 65535</strong> — when this number is reached the card stopps working and gets unusable. <strong class="markup--strong markup--li-strong">So please do not run the command in a loop asking for hundreds or thousands of data.</strong></li></ul><p name="35dc" id="35dc" class="graf graf--p graf-after--li">This is the command (with “empty PDOL” information) and response using a <strong class="markup--strong markup--p-strong">MasterCard</strong>:</p><pre data-code-block-mode="0" spellcheck="false" name="26e6" id="26e6" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">05 get the processing options  command length: 8 data: 80a8000002830000<br>05 get the processing options response length: 22 data: 771282021980940c0801010010010101200102009000<br>------------------------------------<br>77 12 -- Response Message Template Format 2<br>      82 02 -- Application Interchange Profile<br>            19 80 (BINARY)<br>      94 0C -- Application File Locator (AFL)<br>            08 01 01 00 10 01 01 01 20 01 02 00 (BINARY)<br>90 00 -- Command successfully executed (OK)<br>------------------------------------</span></pre><p name="aaa1" id="aaa1" class="graf graf--p graf-after--pre">That’ s a much shortened version of response so the information in the next step is the value in tag <em class="markup--em markup--p-em">0x94</em> Application File Locator (AFL).</p><p name="77e0" id="77e0" class="graf graf--p graf-after--p">To get a full overview — this is the data seen using an <strong class="markup--strong markup--p-strong">American Express card</strong>:</p><pre data-code-block-mode="0" spellcheck="false" name="2bee" id="2bee" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">05 get the processing options  command length: 9 data: 80a800000383012200<br>05 get the processing options response length: 22 data: 80121800080101000803030008050500100202009000<br>------------------------------------<br>80 12 -- Response Message Template Format 1<br>      18 00 08 01 01 00 08 03 03 00 08 05 05 00 10 02<br>      02 00 (BINARY)<br>90 00 -- Command successfully executed (OK)<br>------------------------------------</span></pre><p name="7f81" id="7f81" class="graf graf--p graf-after--pre">The information looks different and yes — here is the explanation:</p><ul class="postList"><li name="e5d7" id="e5d7" class="graf graf--li graf-after--p">tag <em class="markup--em markup--li-em">0x80</em> <strong class="markup--strong markup--li-strong">Response Message Template Format 1</strong>: this is the second response format and it it not so easy to read.</li><li name="2ebb" id="2ebb" class="graf graf--li graf-after--li">There are no separate tags in this template and we do have to know the meaning of each byte in the data part</li><li name="524b" id="524b" class="graf graf--li graf-after--li">Fortunately the response is easy to parse (read from left to right)</li><li name="4d68" id="4d68" class="graf graf--li graf-after--li">bytes 1 + 2 (0x18 0x00) are identical to tag <em class="markup--em markup--li-em">0x82</em> <strong class="markup--strong markup--li-strong">Application Interchange Profile</strong> (see the response for the MasterCard)</li><li name="71e4" id="71e4" class="graf graf--li graf-after--li">bytes 3 … to the end are the data elements for tag <em class="markup--em markup--li-em">0x94</em> <strong class="markup--strong markup--li-strong">Application File Locator (AFL)</strong>.</li></ul><p name="c517" id="c517" class="graf graf--p graf-after--li">So in the end it is just an “array-copying” to get the AFL value.</p><p name="6e8c" id="6e8c" class="graf graf--p graf-after--p">Before proceeding to the next step I want to return to the data in tag <em class="markup--em markup--p-em">0x77</em> <strong class="markup--strong markup--p-strong">Response Message Template Format 2</strong>. Some cards include this tag in the “get processing options” response and we can stop further reading and just parse the tag value for the credit card number and expiration date, but as mentioned most cards do not include the tag. <strong class="markup--strong markup--p-strong">Again: the data are from an outdated Credit Card — do not use the number for any purpose !</strong></p><p name="044e" id="044e" class="graf graf--p graf-after--p">Here is a short explanation to parse the tag value (this is done in the <em class="markup--em markup--p-em">getPanFromTrack2EquivalentData</em> method). The tag 0x57 is a 19 bytes long field (hex <em class="markup--em markup--p-em">0x13</em> = 19 decimal). For a better parsing we convert the 19 bytes into a hex encoded string with 38 characters. The first 16 characters contain the “<strong class="markup--strong markup--p-strong">Primary Account Number</strong>” or “<strong class="markup--strong markup--p-strong">PAN</strong>” = “<strong class="markup--strong markup--p-strong">Credit Card Number</strong>”, followed by a “D” character that works as a separator to the next field which is the “<strong class="markup--strong markup--p-strong">Expiration Date</strong>”. This field is 4 characters long and the value is in the format “YYMM”, so we can retrieve the card number as “4263 5401 2227 0050” and the expiration date as “25 06” (= June 2025). As the card number can be shorter the “missing” characters are filled up with trailing “F” characters (happend with an American Express Card, those card numbers are only 15 bytes long.</p><pre data-code-block-mode="0" spellcheck="false" name="2626" id="2626" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">57 13 -- Track 2 Equivalent Data<br>      42 63 54 01 22 27 00 50 D2 50 62 01 13 81 54 14</span></pre><figure name="4318" id="4318" class="graf graf--figure graf-after--pre"><img class="graf-image" data-image-id="1*zl93BzyR9GFUWrSMbRKlSw.png" data-width="300" data-height="384" src="https://cdn-images-1.medium.com/max/800/1*zl93BzyR9GFUWrSMbRKlSw.png"></figure><p name="638f" id="638f" class="graf graf--p graf-after--figure">At this point we got an AFL from the card and are ready to read the files from this list, this is done in <a href="https://medium.com/@androidcrypto/talk-to-your-credit-card-part-6-read-all-files-given-in-the-afl-list-17e2e5d71c6e" data-href="https://medium.com/@androidcrypto/talk-to-your-credit-card-part-6-read-all-files-given-in-the-afl-list-17e2e5d71c6e" class="markup--anchor markup--p-anchor" target="_blank"><strong class="markup--strong markup--p-strong">step 06 read all files given in the AFL list</strong></a><strong class="markup--strong markup--p-strong">:</strong></p><p name="3883" id="3883" class="graf graf--p graf-after--p graf--trailing">Find the full code of the app in my GitHub repository <strong class="markup--strong markup--p-strong">TalkToYourCreditCardPart5</strong>:<a href="https://github.com/AndroidCrypto/TalkToYourCreditCardPart5" data-href="https://github.com/AndroidCrypto/TalkToYourCreditCardPart5" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"> TalkToYourCreditCardPart5</a></p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@androidcrypto" class="p-author h-card">AndroidCrypto</a> on <a href="https://medium.com/p/8cecb0a2e166"><time class="dt-published" datetime="2023-04-12T09:40:21.628Z">April 12, 2023</time></a>.</p><p><a href="https://medium.com/@androidcrypto/talk-to-your-credit-card-part-5-retrieve-the-application-file-locator-afl-list-8cecb0a2e166" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on April 12, 2023.</p></footer></article></body></html>